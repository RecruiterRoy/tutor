<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Login - tution.app</title>
    <link rel="icon" type="image/jpeg" href="images/tution.app_emblem.jpg">
    <link rel="apple-touch-icon" href="images/tution.app_emblem.jpg">
    <link rel="manifest" href="manifest.json">
    
    <!-- Load Supabase CDN first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Use Tailwind via CDN with config (production ready) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2'
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.1/cdn.min.js" defer></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }
        
        /* Mobile-specific fixes */
        @media (max-width: 768px) {
            .login-container {
                padding: 1rem;
                margin: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
            }
            
            .login-form {
                width: 100%;
                max-width: 100%;
                padding: 1.5rem;
            }
            
            .input-field {
                width: 100%;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .btn-primary {
                width: 100%;
                padding: 1rem;
                font-size: 16px;
                margin-top: 1rem;
            }
        }
        
        /* Fix input field visibility */
        input[type="email"], 
        input[type="password"], 
        input[type="tel"], 
        input[type="text"],
        select {
            background: rgba(0, 0, 0, 0.3) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        input[type="email"]::placeholder, 
        input[type="password"]::placeholder, 
        input[type="tel"]::placeholder, 
        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }
        
        input[type="email"]:focus, 
        input[type="password"]:focus, 
        input[type="tel"]:focus, 
        input[type="text"]:focus,
        select:focus {
            background: rgba(0, 0, 0, 0.5) !important;
            border-color: rgba(139, 92, 246, 0.8) !important;
            outline: none !important;
        }
        
        /* Fix select dropdown */
        select option {
            background: #1f2937;
            color: white;
        }
        
        /* Fix checkbox */
        input[type="checkbox"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Ensure buttons are visible and properly styled */
        button {
            display: block !important;
            width: 100% !important;
            margin: 0.5rem 0 !important;
            padding: 0.75rem 1rem !important;
            border-radius: 0.5rem !important;
            font-weight: 500 !important;
            text-align: center !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
        }
        
        /* Center all content */
        .center-content {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            width: 100% !important;
        }
        
        /* Ensure form elements are properly spaced */
        .form-group {
            margin-bottom: 1rem !important;
            width: 100% !important;
        }
        
        .form-label {
            display: block !important;
            margin-bottom: 0.5rem !important;
            text-align: left !important;
            width: 100% !important;
        }
        
        /* Simplified login form */
        .login-form-simple {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
        }
        
        .login-input {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 16px;
        }
        
        .login-input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .login-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .login-button:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .forgot-password {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            margin-top: 1rem;
        }
        
        .forgot-password:hover {
            color: white;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="glass-effect rounded-2xl p-8 w-full max-w-md shadow-2xl login-container center-content" x-data="authApp()">
        <!-- Header -->
        <div class="text-center mb-8 center-content">
            <div class="flex justify-center mb-4">
                <a href="index.html" class="cursor-pointer">
                    <img src="images/tution.app_logo.jpg" alt="tution.app Logo" style="height: 80px; width: auto; cursor: pointer;" onclick="window.location.href='index.html'">
                </a>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Welcome Back!</h1>
            <p class="text-gray-200">Sign in to continue your learning journey</p>
        </div>

        <!-- Simplified Login Form -->
        <div class="login-form-simple">
            <div class="form-group">
                <label class="form-label text-sm font-medium text-gray-200">Email or Mobile Number</label>
                <input x-model="email" 
                       type="text" 
                       placeholder="Enter your email or mobile number"
                       class="login-input">
            </div>
            
            <div class="form-group">
                <label class="form-label text-sm font-medium text-gray-200">Password</label>
                    <input x-model="password" 
                           x-ref="passwordField"
                           type="password" 
                           placeholder="Enter your password"
                       class="login-input w-full">
                <div class="mt-2">
                    <label class="flex items-center text-sm text-gray-200" style="cursor: pointer; user-select: none;">
                        <input x-model="showPassword" 
                               @change="togglePassword()"
                            @click="togglePassword()"
                               type="checkbox" 
                               class="mr-2"
                               style="cursor: pointer; transform: scale(1.2);">
                        <span @click="togglePassword()" style="cursor: pointer;">Show password</span>
                    </label>
                </div>
            </div>

            <button @click="signInWithEmail" 
                    :disabled="loading"
                    class="login-button">
                <span x-show="!loading">Sign In</span>
                <span x-show="loading">Processing...</span>
            </button>

            <div class="text-center">
                <a href="#" @click="resetPassword" class="forgot-password">Forgot Password?</a>
        </div>

        <!-- Sign Up Link -->
        <div class="mt-6 text-center">
            <p class="text-gray-300">
                Don't have an account? 
                <a href="register.html" class="text-purple-300 hover:text-purple-100 font-medium">Sign up</a>
            </p>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div x-show="message" 
             :class="messageType === 'success' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'"
             class="mt-4 p-3 rounded-lg text-sm w-full" 
             x-text="message"></div>
    </div>

    <script>
        // ========== ALPINE.JS APP INITIALIZATION ==========
        
        function authApp() {
            return {
                // Form data
                email: '',
                password: '',
                
                // UI state
                showPassword: false,
                loading: false,
                
                // Messages
                message: '',
                messageType: 'error',
                
                // Methods
                async signInWithEmail() {
                    if (!this.email) {
                        this.showMessage('Please enter your email or mobile number', 'error');
                        return;
                    }
                    
                    if (!this.password) {
                        this.showMessage('Please enter your password', 'error');
                        return;
                    }
                    
                    this.loading = true;
                    this.message = '';
                    
                    try {
                                        // Simple, direct login without timeouts
                            await handleLoginWithData(this.email, this.password);
                        
                    } catch (error) {
                        console.error('❌ Mobile login error:', error);
                        this.showMessage(error.message || 'Login failed - please try again', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                showMessage(message, type = 'error') {
                    this.message = message;
                    this.messageType = type;
                },
                
                togglePassword() {
                    this.showPassword = !this.showPassword;
                    const passwordField = this.$refs.passwordField;
                    passwordField.type = this.showPassword ? 'text' : 'password';
                },
                
                async resetPassword() {
                    if (!this.email) {
                        this.showMessage('Please enter your email first', 'error');
                        return;
                    }
                    
                    this.loading = true;
                    try {
                        const { error } = await window.supabaseClient.auth.resetPasswordForEmail(this.email);
                        if (error) throw error;
                        this.showMessage('Password reset link sent to your email', 'success');
                    } catch (error) {
                        this.showMessage(error.message || 'Failed to send reset link', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            };
        }

        // ========== SUPABASE INITIALIZATION ==========

        async function initSupabase() {
            try {
                // Check if already initialized
                if (window.supabaseClient) {
                    return window.supabaseClient;
                }
                
                // Configuration
                const SUPABASE_URL = 'https://vfqdjpiyaabufpaofysz.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmcWRqcGl5YWFidWZwYW9meXN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MDkzMDEsImV4cCI6MjA2OTE4NTMwMX0.SVY1Kf7D1nbXssuxCnnHcvaDAIintOpCLfhxV6rHvjo';
                
                // Initialize
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('✅ Supabase initialized');
                
                // Database connection test removed to avoid RLS policy issues
                console.log('✅ Supabase initialized successfully');
                
                // Set up session listener
                window.supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event, session ? 'Session exists' : 'No session');
                    
                    if (event === 'SIGNED_IN' && session) {
                        console.log('✅ User signed in successfully');
                    } else if (event === 'SIGNED_OUT') {
                        console.log('👋 User signed out');
                        // Clear any stale session data
                        localStorage.removeItem('supabase.auth.token');
                        sessionStorage.removeItem('supabase.auth.token');
                    } else if (event === 'TOKEN_REFRESHED') {
                        console.log('🔄 Token refreshed');
                    }
                });
                
                return window.supabaseClient;
                
            } catch (error) {
                console.error('❌ Supabase initialization failed:', error);
                throw error;
            }
        }

        // ========== SESSION CHECKING ==========

        async function checkIfLoggedIn() {
            try {
                console.log('🔍 Checking if user is already logged in...');
                
                // Initialize Supabase if not already done
                if (!window.supabaseClient) {
                    await initSupabase();
                }
                
                // Clear any stale session data first
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.removeItem('supabase.auth.token');
                
                // Get current session from Supabase
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Session check error:', error);
                    return false;
                }
                
                if (!session) {
                    console.log('❌ No active session found');
                    return false;
                }
                
                // Verify user exists
                const { data: { user }, error: userError } = await window.supabaseClient.auth.getUser();
                
                if (userError || !user) {
                    console.error('User validation failed:', userError);
                    return false;
                }
                
                console.log('✅ Valid session found for user:', user.email);
                return true;
                
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        // ========== MAIN INITIALIZATION ==========

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 Login page initializing...');
                
                // Initialize Supabase first
                await initSupabase();
                
                // No mobile-specific optimizations - keep it simple
                
                // Check for email verification redirect - handle all possible Supabase scenarios
                const urlParams = new URLSearchParams(window.location.search);
                const accessToken = urlParams.get('access_token');
                const refreshToken = urlParams.get('refresh_token');
                const type = urlParams.get('type');
                const error = urlParams.get('error');
                
                if (error) {
                    console.error('❌ Auth error from URL:', error);
                    showError('Authentication error: ' + error);
                    return;
                }
                
                // Handle email confirmation
                if (type === 'signup' && accessToken) {
                    console.log('🔧 Processing email confirmation...');
                    try {
                        const { data, error } = await window.supabaseClient.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        
                        if (error) {
                            console.error('❌ Session setting error:', error);
                            showError('Email confirmation failed: ' + error.message);
                        } else {
                            console.log('✅ Email confirmed successfully');
                            showSuccess('Email confirmed! Redirecting to dashboard...');
                            setTimeout(() => {
                                window.location.href = '/dashboard';
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('❌ Email confirmation error:', error);
                        showError('Email confirmation failed: ' + error.message);
                    }
                    return;
                }
                
                // Handle password reset
                if (type === 'recovery' && accessToken) {
                    console.log('🔧 Processing password reset...');
                    try {
                        const { data, error } = await window.supabaseClient.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        
                        if (error) {
                            console.error('❌ Password reset error:', error);
                            showError('Password reset failed: ' + error.message);
                        } else {
                            console.log('✅ Password reset successful');
                            showSuccess('Password reset successful! Redirecting to dashboard...');
                            setTimeout(() => {
                                window.location.href = '/dashboard';
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('❌ Password reset error:', error);
                        showError('Password reset failed: ' + error.message);
                    }
                    return;
                }
                
                // Check if user is already logged in
                const isLoggedIn = await checkIfLoggedIn();
                if (isLoggedIn) {
                    console.log('✅ User already logged in, redirecting to dashboard');
                    window.location.href = '/dashboard';
                    return;
                } else {
                    // Clear any stale session data to prevent loops
                    console.log('❌ No valid session, clearing any stale data');
                    localStorage.removeItem('supabase.auth.token');
                    sessionStorage.removeItem('supabase.auth.token');
                    localStorage.removeItem('tution_cached_user');
                    localStorage.removeItem('tution_cached_password');
                }
                
                console.log('✅ Login page ready');
                
            } catch (error) {
                console.error('❌ Login page initialization failed:', error);
                showError('Failed to initialize login page: ' + error.message);
            }
        });

        // ========== AUTHENTICATION FUNCTIONS ==========

        async function handleLoginWithData(email, password) {
            try {
                console.log('🔧 Attempting login with email/password...');
                
                // Initialize Supabase if not already done
                if (!window.supabaseClient) {
                    await initSupabase();
                }
                
                // Direct login without timeouts
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    console.error('❌ Login error:', error);
                    
                    // Handle specific error cases
                    if (error.message.includes('Invalid login credentials')) {
                        throw new Error('Invalid email or password. Please check your credentials and try again.');
                    } else if (error.message.includes('Email not confirmed')) {
                        throw new Error('Please check your email and click the confirmation link before logging in.');
                    } else if (error.message.includes('Too many requests')) {
                        throw new Error('Too many login attempts. Please wait a few minutes before trying again.');
                        } else {
                        throw new Error('Login failed: ' + error.message);
                    }
                }
                
                if (!data.user) {
                    throw new Error('Login failed: No user data received');
                }
                
                console.log('✅ Login successful for user:', data.user.email);
                
                // Save credentials to cache for future logins
                saveUserCredentials(email, password);
                
                // Check if user profile exists
                try {
                    await ensureUserProfile(data.user);
                } catch (profileError) {
                    console.warn('⚠️ Profile check failed, continuing with login:', profileError);
                    // Continue with login even if profile check fails
                }
                
                // Simple redirect for all devices
                window.location.href = '/dashboard';
                
            } catch (error) {
                console.error('❌ Login failed:', error);
                throw error;
            }
        }
        
        async function ensureUserProfile(user) {
            try {
                console.log('🔧 Ensuring user profile exists...');
                
                // Check if profile already exists
                const { data: existingProfile, error: fetchError } = await window.supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (fetchError && fetchError.code !== 'PGRST116') {
                    console.error('❌ Error checking profile:', fetchError);
                    throw new Error('Failed to check user profile');
                }
                
                if (existingProfile) {
                    console.log('✅ User profile already exists');
                    return existingProfile;
                }
                
                // Create basic profile
                console.log('🔧 Creating basic user profile...');
                const { data: newProfile, error: createError } = await window.supabaseClient
                    .from('user_profiles')
                    .insert({
                        id: user.id,
                        email: user.email,
                        full_name: user.user_metadata?.full_name || user.email?.split('@')[0] || 'User',
                        class: '10', // Default class
                        board: 'CBSE', // Default board
                        gender: 'male', // Default gender
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (createError) {
                    console.error('❌ Profile creation error:', createError);
                    throw new Error('Failed to create user profile: ' + createError.message);
                }
                
                console.log('✅ User profile created successfully');
                return newProfile;
                
            } catch (error) {
                console.error('❌ Profile creation failed:', error);
                throw error;
            }
        }
        
        // ========== UTILITY FUNCTIONS ==========

        function showError(message) {
            console.error('❌ Error:', message);
            // Alpine.js will handle the display
        }

        function showSuccess(message) {
            console.log('✅ Success:', message);
            // Alpine.js will handle the display
        }
        
        // ========== CACHING FUNCTIONS ==========
        
        function saveUserCredentials(email, password) {
            try {
                console.log('💾 Saving user credentials to cache...');
                localStorage.setItem('tution_cached_user', email);
                localStorage.setItem('tution_cached_password', password);
                localStorage.setItem('tution_last_login', Date.now().toString());
                console.log('✅ Credentials saved to cache');
            } catch (error) {
                console.error('❌ Error saving credentials to cache:', error);
            }
        }
        
        function loadCachedCredentials() {
            try {
                console.log('🔍 Loading cached credentials...');
                const cachedUser = localStorage.getItem('tution_cached_user');
                const cachedPassword = localStorage.getItem('tution_cached_password');
                
                if (cachedUser && cachedPassword) {
                    console.log('✅ Found cached credentials, prefilling form');
                    return { email: cachedUser, password: cachedPassword };
                } else {
                    console.log('❌ No cached credentials found');
                    return null;
                }
            } catch (error) {
                console.error('❌ Error loading cached credentials:', error);
                return null;
            }
        }
        
        function clearCachedCredentials() {
            try {
                localStorage.removeItem('tution_cached_user');
                localStorage.removeItem('tution_cached_password');
                localStorage.removeItem('tution_last_login');
                console.log('✅ Cached credentials cleared');
            } catch (error) {
                console.error('❌ Error clearing cached credentials:', error);
            }
        }
        
        // Check for prefilled credentials on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shouldPrefill = urlParams.get('prefill');
            
            if (shouldPrefill === 'true') {
                console.log('🔍 Checking for prefilled credentials...');
                const cachedCredentials = loadCachedCredentials();
                
                if (cachedCredentials) {
                    console.log('✅ Prefilling form with cached credentials');
                    // Use Alpine.js to set the values
                    if (window.Alpine) {
                        window.Alpine.store('loginForm', {
                            email: cachedCredentials.email,
                            password: cachedCredentials.password
                        });
                    }
                }
            }
            
            // Check if this is an APK and should redirect to dashboard
            const isAPK = window.location.protocol === 'file:' || 
                         window.navigator.userAgent.includes('Capacitor') ||
                         window.navigator.userAgent.includes('Android');
            
            if (isAPK) {
                console.log('📱 APK detected, checking for cached login...');
                // Check if user is already logged in
                checkIfLoggedIn().then(isLoggedIn => {
                    if (isLoggedIn) {
                        console.log('✅ User already logged in, redirecting to dashboard');
                        window.location.href = '/dashboard';
                    }
                }).catch(error => {
                    console.log('❌ Error checking login status:', error);
                });
            }
        });
        
        // Make functions globally available
        window.saveUserCredentials = saveUserCredentials;
        window.loadCachedCredentials = loadCachedCredentials;
        window.clearCachedCredentials = clearCachedCredentials;
    </script>
</body>
</html>