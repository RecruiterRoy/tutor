<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - tution.app</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Configuration and Client Scripts -->
    <script src="js/config.js"></script>
    <script src="js/supabaseClient.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dashboard.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="bg-white/80 backdrop-blur-xl border-r border-gray-200 w-64 transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 z-50">
            <div class="p-4">
                <div class="flex items-center space-x-3 mb-6">
                    <img src="images/tution.app_emblem.jpg" alt="tution.app" class="h-8 w-8">
                    <h1 class="text-xl font-bold text-gray-800">tution.app</h1>
                </div>
                
                <!-- User Info -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg" id="userAvatar">P</div>
                        <div>
                            <div class="text-gray-800 font-semibold" id="userName">Loading...</div>
                            <div class="text-gray-600 text-sm" id="userClass">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation -->
                <nav class="space-y-2">
                    <div class="nav-item active bg-blue-100 text-blue-700 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('classroomSection', event)">
                        <span class="text-2xl">üè´</span>
                        <span>Classroom</span>
                    </div>
                    <div class="nav-item text-gray-700 hover:bg-gray-100 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('homeworkSection', event)">
                        <span class="text-2xl">üìù</span>
                        <span>Homework</span>
                    </div>
                    <div class="nav-item text-gray-700 hover:bg-gray-100 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('assessmentSection', event)">
                        <span class="text-2xl">üìã</span>
                        <span>Assessment</span>
                    </div>
                    <div class="nav-item text-gray-700 hover:bg-gray-100 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('dailyChallengeSection', event)">
                        <span class="text-2xl">üéØ</span>
                        <span>Daily Quiz</span>
                        <span id="challengeStar" class="text-yellow-400 text-lg hidden">‚≠ê</span>
                    </div>
                    <div class="nav-item text-gray-700 hover:bg-gray-100 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('studyMaterialsSection', event)">
                        <span class="text-2xl">üìö</span>
                        <span>Study Materials</span>
                    </div>
                    <div class="nav-item text-gray-700 hover:bg-gray-100 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('profileSection', event)">
                        <span class="text-2xl">üë§</span>
                        <span>Profile</span>
                    </div>
                    <div class="nav-item text-gray-700 hover:bg-gray-100 px-4 py-3 rounded-lg cursor-pointer flex items-center space-x-3" onclick="showSection('settingsSection', event)">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-xl border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <button id="mobileSidebarToggle" class="text-gray-600 text-2xl lg:hidden">‚ò∞</button>
                    <div class="hidden lg:block">
                        <h2 class="text-xl font-semibold text-gray-800">Student Dashboard</h2>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-hidden">
                <!-- Classroom Section -->
                <div id="classroomSection" class="h-full overflow-y-auto p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- Chat Box -->
                        <div class="bg-white/90 backdrop-blur-xl rounded-2xl border border-gray-200 shadow-2xl h-[600px] flex flex-col">
                            <!-- Chat Header -->
                            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <img id="welcomeTeacherAvatar" src="images/roy_sir.jpg" alt="Teacher" class="w-12 h-12 rounded-full border-2 border-blue-300" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiM2QjdGRUEiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxMmMyLjIxIDAgNC0xLjc5IDQtNCAwLTIuMjEtMS43OS00LTQtNC0yLjIxIDAtNCAxLjc5LTQgNCAwIDIuMjEgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+Cg=='">
                                        <div>
                                            <div id="avatarName" class="text-gray-800 font-semibold">Roy Sir</div>
                                            <div class="text-gray-600 text-sm">Your AI Teacher</div>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="playButton" onclick="playTTS()" class="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-colors" title="Play TTS">
                                            <span class="text-lg">‚ñ∂Ô∏è</span>
                                        </button>
                                        <button id="stopButton" onclick="stopTTS()" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors" title="Stop TTS">
                                            <span class="text-lg">‚èπÔ∏è</span>
                                        </button>
                                        <button id="micButton" onclick="startMic()" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors" title="Voice Input">
                                            <span class="text-lg">üé§</span>
                                        </button>
                                        <button id="ocrButton" onclick="startCameraScan()" class="p-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition-colors" title="Camera OCR">
                                            <span class="text-lg">üì∑</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chat Messages -->
                            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4" style="max-height: 500px; scroll-behavior: smooth;">
                                <!-- Messages will be added here -->
                            </div>
                            
                            <!-- Input Area -->
                            <div class="p-4 border-t border-gray-200 flex-shrink-0">
                                <div class="flex space-x-3">
                                    <input type="text" id="chatInput" placeholder="Ask me anything about your studies..." 
                                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <button id="cameraButton" onclick="startCameraScan()" class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                        üì∑
                                    </button>
                                    <button id="voiceButton" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                        üé§
                                    </button>
                                    <button id="sendButton" class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        üì§
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Subject Selector -->
                        <div class="mt-4 bg-white/80 backdrop-blur-xl rounded-lg p-4 border border-gray-200">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-gray-800 font-semibold">Select Subject</span>
                                <button class="text-blue-600 hover:text-blue-800 text-sm">‚öôÔ∏è Manage</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200">General</button>
                                <button class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">English</button>
                                <button class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">Maths</button>
                                <button class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">Hindi</button>
                                <button class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">EVS</button>
                                <button class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">Science</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Homework Section -->
                <div id="homeworkSection" class="h-full hidden overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Homework</h2>
                        <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-6">
                            <div class="flex items-center space-x-3 mb-4">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                                <h3 class="text-lg font-semibold text-gray-800">School Registration Required</h3>
                            </div>
                            <p class="text-gray-700">You will see your homework here once your school is registered with us.</p>
                        </div>
                    </div>
                </div>

                <!-- Assessment Section -->
                <div id="assessmentSection" class="h-full hidden overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Assessment Center</h2>
                        
                        <!-- Quick Test -->
                        <div class="bg-white/80 rounded-lg p-6 mb-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üöÄ Quick Test</h3>
                            <p class="text-gray-600 mb-4">Generate a test quickly with preset options. Earn 5 points for taking the test!</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <select id="testSubject" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                    <option value="">Select Subject</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="science">Science</option>
                                    <option value="english">English</option>
                                    <option value="hindi">Hindi</option>
                                    <option value="evs">EVS</option>
                                    <option value="social_studies">Social Studies</option>
                                </select>
                                
                                <select id="testDuration" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                    <option value="5">5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="20">20 minutes</option>
                                    <option value="30">30 minutes</option>
                                </select>
                                
                                <select id="testDifficulty" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                                
                                <button id="startQuickTest" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                    Start Test
                                </button>
                            </div>
                            
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">Points:</span> 5 points for taking + 2 points per correct answer
                            </div>
                        </div>
                        
                        <!-- Custom Test -->
                        <div class="bg-white/80 rounded-lg p-6 mb-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üéØ Custom Test</h3>
                            <p class="text-gray-600 mb-4">Create a personalized test with specific topics and questions. Earn 5 points for taking + 2 points per correct answer!</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="customTestTopic" placeholder="Enter topic (e.g., Algebra, Photosynthesis, Grammar)" 
                                       class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                       
                                <select id="customTestQuestions" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                    <option value="5">5 Questions</option>
                                    <option value="10">10 Questions</option>
                                    <option value="15">15 Questions</option>
                                    <option value="20">20 Questions</option>
                                    <option value="25">25 Questions</option>
                                </select>
                                
                                <button id="createCustomTest" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                    Create Test
                                </button>
                            </div>
                            
                            <div class="text-sm text-gray-600">
                                <span class="font-medium">AI Generated:</span> Questions will be created based on your class syllabus and topic
                            </div>
                        </div>
                        
                        <!-- Test History -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Recent Tests</h3>
                            <div id="testHistory" class="space-y-3">
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h4 class="text-gray-800 font-medium">Mathematics Quiz</h4>
                                            <p class="text-gray-600 text-sm">Completed 2 days ago</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-green-600 font-bold">85%</span>
                                            <p class="text-gray-600 text-sm">17/20 ‚Ä¢ 39 points</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h4 class="text-gray-800 font-medium">Science Test</h4>
                                            <p class="text-gray-600 text-sm">Completed 1 week ago</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-yellow-600 font-bold">72%</span>
                                            <p class="text-gray-600 text-sm">18/25 ‚Ä¢ 41 points</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h4 class="text-gray-800 font-medium">English Grammar</h4>
                                            <p class="text-gray-600 text-sm">Completed 2 weeks ago</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-green-600 font-bold">90%</span>
                                            <p class="text-gray-600 text-sm">9/10 ‚Ä¢ 23 points</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Points Summary -->
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-6 text-white">
                            <h3 class="text-lg font-semibold mb-2">üèÜ Your Points</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold">103</div>
                                    <div class="text-blue-100">Total Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold">15</div>
                                    <div class="text-blue-100">Tests Taken</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold">78%</div>
                                    <div class="text-blue-100">Average Score</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Challenge Section -->
                <div id="dailyChallengeSection" class="h-full hidden overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üéØ Daily Quiz</h2>
                        
                        <!-- Daily Quiz Status -->
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg p-6 text-white mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold">Today's Challenge</h3>
                                    <p class="text-purple-100">New question available at 5:00 PM daily</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold" id="dailyStreak">0</div>
                                    <div class="text-purple-100">Day Streak</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold" id="quizPoints">0</div>
                                    <div class="text-purple-100">Quiz Points</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold" id="totalPoints">0</div>
                                    <div class="text-purple-100">Total Points</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold" id="rankPosition">-</div>
                                    <div class="text-purple-100">Your Rank</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Today's Question -->
                        <div id="todayQuestion" class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <div class="text-center">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Today's Question</h3>
                                <div id="dailyQuestionContent" class="text-gray-700 mb-6">
                                    <p>Loading today's question...</p>
                                </div>
                                <div id="dailyQuestionOptions" class="space-y-3 mb-6">
                                    <!-- Options will be added here -->
                                </div>
                                <div class="flex justify-center space-x-4">
                                    <button id="submitDailyAnswer" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                        Submit Answer
                                    </button>
                                    <button id="skipQuestion" class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                        Skip
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Question History -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìö Recent Questions</h3>
                            <div id="questionHistory" class="space-y-3">
                                <!-- Question history will be added here -->
                            </div>
                        </div>
                        
                        <!-- Leaderboard -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üèÜ Leaderboard</h3>
                            <div class="flex space-x-4 mb-4">
                                <button id="showGlobalLeaderboard" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Global
                                </button>
                                <button id="showClassLeaderboard" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                                    Class {currentUser?.class || '2'}
                                </button>
                            </div>
                            <div id="leaderboardContent">
                                <!-- Leaderboard will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Materials Section -->
                <div id="studyMaterialsSection" class="h-full hidden overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìö Study Materials</h2>
                        
                        <!-- Books Section -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìñ Books</h3>
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">üìö</div>
                                <h4 class="text-xl font-semibold text-gray-700 mb-2">Coming Soon!</h4>
                                <p class="text-gray-500">We're working on bringing you a comprehensive collection of textbooks and study materials.</p>
                            </div>
                        </div>
                        
                        <!-- Videos Section -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üé• Educational Videos</h3>
                            <div id="videosContainer" class="space-y-4">
                                <!-- Videos will be loaded from Supabase -->
                                <div class="text-center py-8 text-gray-500">
                                    Loading videos...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="h-full hidden overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">üë§ Profile</h2>
                            <button onclick="refreshProfileData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <span>üîÑ</span>
                                <span>Refresh Data</span>
                            </button>
                        </div>
                        
                        <!-- Profile Header -->
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-6 text-white mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center text-white font-bold text-3xl" id="profileAvatar">
                                    P
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold" id="profileName">Student</h3>
                                    <p class="text-blue-100" id="profileClassDisplay">Class 2 ‚Ä¢ CBSE</p>
                                    <p class="text-blue-100 text-sm" id="profileSchoolDisplay">School Name</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personal Information -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üë§ Personal Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Full Name *</label>
                                    <input type="text" id="profileFullName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white" placeholder="Enter your full name">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Date of Birth</label>
                                    <input type="date" id="profileDOB" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Gender</label>
                                    <select id="profileGender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                        <option value="prefer_not_to_say">Prefer not to say</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">City</label>
                                    <input type="text" id="profileCity" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white" placeholder="Enter your city">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Email Address</label>
                                    <input type="email" id="profileEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Mobile Number</label>
                                    <input type="tel" id="profilePhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Academic Information -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìö Academic Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Class *</label>
                                    <select id="profileClass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                        <option value="">Select Class</option>
                                        <option value="1">Class 1</option>
                                        <option value="2">Class 2</option>
                                        <option value="3">Class 3</option>
                                        <option value="4">Class 4</option>
                                        <option value="5">Class 5</option>
                                        <option value="6">Class 6</option>
                                        <option value="7">Class 7</option>
                                        <option value="8">Class 8</option>
                                        <option value="9">Class 9</option>
                                        <option value="10">Class 10</option>
                                        <option value="11">Class 11</option>
                                        <option value="12">Class 12</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Board</label>
                                    <select id="profileBoard" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                        <option value="">Select Board</option>
                                        <option value="CBSE">CBSE</option>
                                        <option value="ICSE">ICSE</option>
                                        <option value="State Board">State Board</option>
                                        <option value="International">International</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">School Name</label>
                                    <input type="text" id="profileSchool" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white" placeholder="Enter your school name">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Roll Number</label>
                                    <input type="text" id="profileRollNo" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white" placeholder="Enter your roll number">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Subjects -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìñ Subjects</h3>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">Select Your Subjects</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="subjectsContainer">
                                    <!-- Subjects will be populated here -->
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="text" id="newSubject" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white" placeholder="Add custom subject">
                                <button id="addSubjectBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Add
                                </button>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="saveProfileBtn" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                    üíæ Save Changes
                                </button>
                                <button id="resetProfileBtn" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                    üîÑ Reset to Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="h-full hidden overflow-y-auto p-6">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Settings</h2>
                        
                        <!-- Teacher Avatar Selection -->
                        <div class="bg-white/90 backdrop-blur-xl rounded-2xl border border-gray-200 shadow-2xl p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üë®‚Äçüè´ Teacher Avatar Selection</h3>
                            <p class="text-gray-600 mb-6">Choose your AI teacher's personality and teaching style</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <!-- Roy Sir -->
                                <div class="avatar-option cursor-pointer p-6 border-2 border-gray-200 rounded-xl text-center hover:border-blue-500 transition-all duration-300 hover:shadow-lg" data-avatar="roy_sir" onclick="selectTeacher('roy_sir')">
                                    <img src="images/roy_sir.jpg" alt="Roy Sir" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-blue-200">
                                    <div class="text-lg font-semibold text-gray-800 mb-2">Roy Sir</div>
                                    <div class="text-sm text-gray-600 mb-3">Mathematics & Science Expert</div>
                                    <div class="text-xs text-gray-500 space-y-1">
                                        <div>üéØ Focused on problem-solving</div>
                                        <div>üìä Data-driven explanations</div>
                                        <div>üî¨ Science & Technology</div>
                                        <div>üíº Professional & Structured</div>
                                    </div>
                                    <div class="mt-4 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                                        English & Advanced Topics
                                    </div>
                                </div>
                                
                                <!-- Miss Sapna -->
                                <div class="avatar-option cursor-pointer p-6 border-2 border-gray-200 rounded-xl text-center hover:border-pink-500 transition-all duration-300 hover:shadow-lg" data-avatar="miss_sapna" onclick="selectTeacher('miss_sapna')">
                                    <img src="images/miss_sapna.jpg" alt="Miss Sapna" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-pink-200">
                                    <div class="text-lg font-semibold text-gray-800 mb-2">Miss Sapna</div>
                                    <div class="text-sm text-gray-600 mb-3">Language & Arts Specialist</div>
                                    <div class="text-xs text-gray-500 space-y-1">
                                        <div>üíù Warm & Encouraging</div>
                                        <div>üìö Story-based learning</div>
                                        <div>üé® Creative & Interactive</div>
                                        <div>üåç Cultural & Social</div>
                                    </div>
                                    <div class="mt-4 px-4 py-2 bg-pink-100 text-pink-700 rounded-lg text-sm font-medium">
                                        Hindi, English & Hinglish
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Selection Indicator -->
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex items-center space-x-3">
                                    <span class="text-blue-600">‚úÖ</span>
                                    <span class="text-gray-700">Currently selected: </span>
                                    <span id="currentTeacherName" class="font-semibold text-blue-700">Roy Sir</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Preferences -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üîî Notification Preferences</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Daily Quiz Reminders</div>
                                        <div class="text-sm text-gray-500">Get notified when new daily questions are available</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dailyQuizNotifications" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Assessment Results</div>
                                        <div class="text-sm text-gray-500">Get notified when your test results are ready</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="assessmentNotifications" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Study Reminders</div>
                                        <div class="text-sm text-gray-500">Get gentle reminders to study regularly</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="studyReminders" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Email Notifications</div>
                                        <div class="text-sm text-gray-500">Receive important updates via email</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="emailNotifications" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Appearance Settings -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üé® Appearance</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Theme</label>
                                    <select id="themeSelector" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                        <option value="light">Light Theme (Default)</option>
                                        <option value="dark">Dark Theme</option>
                                        <option value="auto">Auto (System)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Font Size</label>
                                    <select id="fontSizeSelector" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white">
                                        <option value="small">Small</option>
                                        <option value="medium" selected>Medium (Default)</option>
                                        <option value="large">Large</option>
                                        <option value="extra-large">Extra Large</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Color Scheme</label>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="color-option cursor-pointer p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 transition-colors" data-color="blue">
                                            <div class="w-8 h-8 bg-blue-500 rounded mx-auto mb-2"></div>
                                            <div class="text-xs text-gray-700">Blue</div>
                                        </div>
                                        <div class="color-option cursor-pointer p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 transition-colors" data-color="purple">
                                            <div class="w-8 h-8 bg-purple-500 rounded mx-auto mb-2"></div>
                                            <div class="text-xs text-gray-700">Purple</div>
                                        </div>
                                        <div class="color-option cursor-pointer p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 transition-colors" data-color="green">
                                            <div class="w-8 h-8 bg-green-500 rounded mx-auto mb-2"></div>
                                            <div class="text-xs text-gray-700">Green</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Privacy Settings -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üîí Privacy & Security</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Profile Visibility</div>
                                        <div class="text-sm text-gray-500">Allow other students to see your profile</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="profileVisibility" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Leaderboard Visibility</div>
                                        <div class="text-sm text-gray-500">Show your name on leaderboards</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="leaderboardVisibility" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Data Collection</div>
                                        <div class="text-sm text-gray-500">Allow us to collect usage data for improvement</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dataCollection" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-medium text-gray-700">Auto-logout</div>
                                        <div class="text-sm text-gray-500">Automatically log out after inactivity</div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="autoLogout" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Actions -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üë§ Account Actions</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <div>
                                        <div class="font-medium text-gray-700">Export Data</div>
                                        <div class="text-sm text-gray-500">Download your learning data and progress</div>
                                    </div>
                                    <button id="exportDataBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                        Export
                                    </button>
                                </div>
                                
                                <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div>
                                        <div class="font-medium text-gray-700">Reset Progress</div>
                                        <div class="text-sm text-gray-500">Clear all your quiz scores and assessment history</div>
                                    </div>
                                    <button id="resetProgressBtn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                                        Reset
                                    </button>
                                </div>
                                
                                <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-200">
                                    <div>
                                        <div class="font-medium text-gray-700">Delete Account</div>
                                        <div class="text-sm text-gray-500">Permanently delete your account and all data</div>
                                    </div>
                                    <button id="deleteAccountBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Settings -->
                        <div class="bg-white/80 rounded-lg p-6 border border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="saveSettingsBtn" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                    üíæ Save Settings
                                </button>
                                <button id="resetSettingsBtn" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                    üîÑ Reset to Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentSection = 'classroomSection';
        // Camera and mic variables will be declared globally

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Student Dashboard...');
            initializeDashboard();
        });

        // Remove duplicate function - keeping only the async version below

        function initializeChat() {
            console.log('üí¨ Initializing chat...');
            
            const sendButton = document.getElementById('sendButton');
            const chatInput = document.getElementById('chatInput');
            
            if (sendButton && chatInput) {
                sendButton.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Welcome message will be handled by showWelcomeMessage() in main initialization
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                // Add user message
                const userMessage = {
                    type: 'user',
                    content: message,
                    timestamp: new Date()
                };
                addMessageToChat(userMessage);
                
                input.value = '';
                
                // Show typing indicator
                const typingIndicator = {
                    type: 'ai',
                    content: 'Typing...',
                    teacher: 'Roy Sir',
                    timestamp: new Date()
                };
                addMessageToChat(typingIndicator);
                
                try {
                    // Send to AI API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            grade: currentUser?.class || '2',
                            subject: 'General',
                            language: 'en',
                            userProfile: currentUser
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Remove typing indicator
                        const typingMsg = document.querySelector('#chatMessages .justify-start:last-child');
                        if (typingMsg) typingMsg.remove();
                        
                        // Add AI response
                        const aiMessage = {
                            type: 'ai',
                            content: data.reply || data.response || 'I understand your question. Let me help you with that.',
                            teacher: 'Roy Sir',
                            timestamp: new Date()
                        };
                        addMessageToChat(aiMessage);
                        
                    } else {
                        throw new Error('API request failed');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Chat API error:', error);
                    
                    // Remove typing indicator
                    const typingMsg = document.querySelector('#chatMessages .justify-start:last-child');
                    if (typingMsg) typingMsg.remove();
                    
                    // Add fallback response
                    const fallbackMessage = {
                        type: 'ai',
                        content: `I understand you're asking about "${message}". Let me help you with that. This is a sample response while we connect to the AI system.`,
                        teacher: 'Roy Sir',
                        timestamp: new Date()
                    };
                    addMessageToChat(fallbackMessage);
                }
            }
        }



        async function loadUserData() {
            console.log('üë§ Loading user data...');
            
            // Load user data from Supabase or localStorage
            await loadUserDataFromSupabase();
            
            updateProfileDisplay();
        }

        async function loadUserDataFromSupabase() {
            try {
                console.log('üîó Loading user data from Supabase...');
                
                // Get session data
                const session = JSON.parse(localStorage.getItem('session'));
                console.log('üîë Session data:', session);
                
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, using default data');
                    currentUser = {
                        name: 'Please enter',
                        email: 'Please enter',
                        class: 'Please enter',
                        board: 'CBSE',
                        school: 'Please enter',
                        city: 'Please enter',
                        phone: 'Please enter'
                    };
                    updateSidebarUserInfo();
                    return;
                }
                
                console.log('üîê Attempting to fetch profile with token:', session.access_token.substring(0, 20) + '...');
                
                // Fetch user profile from Supabase
                const response = await fetch('/api/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                
                console.log('üì° Profile API response status:', response.status);
                
                if (response.ok) {
                    const userData = await response.json();
                    console.log('üìä Raw user data from Supabase:', userData);
                    
                    // Map Supabase fields to our expected format
                    currentUser = {
                        name: userData.first_name && userData.last_name ? `${userData.first_name} ${userData.last_name}` : userData.name || 'Student',
                        email: userData.email || 'student@example.com',
                        class: userData.class || '2',
                        board: userData.board || 'CBSE',
                        school: userData.school_name || userData.school || 'School Name',
                        city: userData.city || 'City',
                        phone: userData.phone || userData.parent_phone || 'Phone Number',
                        dob: userData.dob || '',
                        gender: userData.gender || '',
                        rollNo: userData.roll_number || userData.rollNo || ''
                    };
                    
                    console.log('‚úÖ User data processed and loaded:', currentUser);
                } else {
                    const errorText = await response.text();
                    console.warn('‚ö†Ô∏è Failed to fetch user data:', response.status, errorText);
                    currentUser = {
                        name: 'Student',
                        email: 'student@example.com',
                        class: '2',
                        board: 'CBSE',
                        school: 'School Name',
                        city: 'City',
                        phone: 'Phone Number'
                    };
                }
                
            } catch (error) {
                console.error('‚ùå Error loading user data:', error);
                currentUser = {
                    name: 'Student',
                    email: 'student@example.com',
                    class: '2',
                    board: 'CBSE',
                    school: 'School Name',
                    city: 'City',
                    phone: 'Phone Number'
                };
            }
        }

        function updateProfileDisplay() {
            if (!currentUser) return;
            
            console.log('üë§ Updating profile display with:', currentUser);
            
            // Update sidebar user info
            const userName = document.getElementById('userName');
            const userClass = document.getElementById('userClass');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userName) userName.textContent = currentUser.name || 'Please enter';
            if (userClass) userClass.textContent = currentUser.class || 'Please enter';
            if (userAvatar) userAvatar.textContent = (currentUser.name || 'P').charAt(0).toUpperCase();
            
            // Update profile header
            const profileName = document.getElementById('profileName');
            const profileClassDisplay = document.getElementById('profileClassDisplay');
            const profileSchoolDisplay = document.getElementById('profileSchoolDisplay');
            const profileAvatar = document.getElementById('profileAvatar');
            
            if (profileName) profileName.textContent = currentUser.name;
            if (profileClassDisplay) profileClassDisplay.textContent = `Class ${currentUser.class} ‚Ä¢ ${currentUser.board || 'CBSE'}`;
            if (profileSchoolDisplay) profileSchoolDisplay.textContent = currentUser.school || 'School Name';
            if (profileAvatar) profileAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Update personal information
            const profileFullName = document.getElementById('profileFullName');
            const profileDOB = document.getElementById('profileDOB');
            const profileGender = document.getElementById('profileGender');
            const profileCity = document.getElementById('profileCity');
            const profileEmail = document.getElementById('profileEmail');
            const profilePhone = document.getElementById('profilePhone');
            
            if (profileFullName) profileFullName.value = currentUser.name;
            if (profileDOB) profileDOB.value = currentUser.dob || '';
            if (profileGender) profileGender.value = currentUser.gender || '';
            if (profileCity) profileCity.value = currentUser.city || '';
            if (profileEmail) profileEmail.value = currentUser.email || '';
            if (profilePhone) profilePhone.value = currentUser.phone || '';
            
            // Update academic information
            const profileClass = document.getElementById('profileClass');
            const profileBoard = document.getElementById('profileBoard');
            const profileSchool = document.getElementById('profileSchool');
            const profileRollNo = document.getElementById('profileRollNo');
            
            if (profileClass) profileClass.value = currentUser.class;
            if (profileBoard) profileBoard.value = currentUser.board || '';
            if (profileSchool) profileSchool.value = currentUser.school || '';
            if (profileRollNo) profileRollNo.value = currentUser.rollNo || '';
            
            // Load subjects
            loadUserSubjects();
            
            console.log('‚úÖ Profile display updated successfully');
        }

        function updateSubjectsDisplay() {
            if (!currentUser || !currentUser.subjects) return;
            
            const subjectsContainer = document.getElementById('subjectsList');
            if (!subjectsContainer) return;
            
            subjectsContainer.innerHTML = currentUser.subjects.map(subject => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-700">${subject}</span>
                    <button onclick="removeSubject(this)" class="text-red-500 hover:text-red-700">
                        <span class="text-xl">√ó</span>
                    </button>
                </div>
            `).join('');
        }

        function showSection(sectionName, event = null) {
            console.log('üîß Showing section:', sectionName);
            
            // Hide all sections
            const allSections = document.querySelectorAll('[id$="Section"]');
            console.log('üìã Found sections:', allSections.length);
            allSections.forEach(section => {
                section.classList.add('hidden');
                console.log('üôà Hiding section:', section.id);
            });
            
            // Remove active class from all nav items
            const allNavItems = document.querySelectorAll('.nav-item');
            allNavItems.forEach(item => {
                item.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                item.classList.add('text-gray-700', 'hover:bg-gray-100');
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName);
            console.log('üéØ Target section found:', !!targetSection, sectionName);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('üëÅÔ∏è Showing section:', sectionName);
                currentSection = sectionName;
                localStorage.setItem('currentSection', sectionName);
                
                // Add active class to clicked nav item
                if (event && event.target.closest('.nav-item')) {
                    const navItem = event.target.closest('.nav-item');
                    navItem.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    navItem.classList.add('active', 'bg-blue-100', 'text-blue-700');
                    console.log('‚úÖ Updated nav item styling');
                }
            } else {
                console.error('‚ùå Section not found:', sectionName);
            }
                
                console.log('‚úÖ Section shown:', sectionName);
                
                // Refresh data for specific sections
                if (sectionName === 'profileSection') {
                    refreshProfileData();
                } else if (sectionName === 'dailyQuizSection') {
                    refreshQuizData();
                } else if (sectionName === 'assessmentSection') {
                    refreshAssessmentData();
                }
            } else {
                console.error('‚ùå Section not found:', sectionName);
            }
        }

        async function refreshProfileData() {
            console.log('üîÑ Refreshing profile data...');
            await loadUserDataFromSupabase();
            updateProfileDisplay();
        }

        function refreshQuizData() {
            console.log('üîÑ Refreshing quiz data...');
            // Refresh quiz data if needed
        }

        function refreshAssessmentData() {
            console.log('üîÑ Refreshing assessment data...');
            // Refresh assessment data if needed
        }

        // Camera and OCR functionality
        // Camera variables
        let cameraStream = null;
        let cameraVideo = null;

        async function startCameraScan() {
            try {
                console.log('üì∑ Starting camera scan...');
                
                // Check if camera is already active
                if (window.cameraStream) {
                    stopCamera();
                    return;
                }

                // Create camera modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.id = 'cameraModal';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-2xl w-full p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Camera Scanner</h3>
                            <button onclick="closeCameraModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                        
                        <div class="mb-4">
                            <video id="cameraVideo" autoplay playsinline class="w-full h-64 bg-gray-100 rounded-lg"></video>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="captureImage()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                üì∏ Capture & Scan
                            </button>
                            <button onclick="stopCamera()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                Stop Camera
                            </button>
                        </div>
                        
                        <div id="ocrResult" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                            <h4 class="font-semibold text-gray-800 mb-2">OCR Result:</h4>
                            <div id="ocrText" class="text-gray-700"></div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Start camera
                await startCamera();
                
            } catch (error) {
                console.error('‚ùå Error starting camera:', error);
                alert('Could not access camera. Please check permissions.');
            }
        }

        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                cameraVideo = document.getElementById('cameraVideo');
                if (cameraVideo) {
                    cameraVideo.srcObject = cameraStream;
                }
                
                console.log('‚úÖ Camera started successfully');
                
            } catch (error) {
                console.error('‚ùå Camera access error:', error);
                
                // Fallback to file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        processImageFile(file);
                    }
                };
                input.click();
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            if (cameraVideo) {
                cameraVideo.srcObject = null;
            }
            
            console.log('üîá Camera stopped');
        }

        function closeCameraModal() {
            stopCamera();
            const modal = document.getElementById('cameraModal');
            if (modal) {
                modal.remove();
            }
        }

        async function captureImage() {
            if (!cameraVideo) return;
            
            try {
                // Create canvas to capture image
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = cameraVideo.videoWidth;
                canvas.height = cameraVideo.videoHeight;
                
                context.drawImage(cameraVideo, 0, 0);
                
                // Convert to blob
                canvas.toBlob(async (blob) => {
                    if (blob) {
                        await processImageFile(blob);
                    }
                }, 'image/jpeg', 0.8);
                
            } catch (error) {
                console.error('‚ùå Error capturing image:', error);
            }
        }

        async function processImageFile(file) {
            try {
                console.log('üîç Processing image for OCR...');
                
                // Show loading
                const ocrResult = document.getElementById('ocrResult');
                const ocrText = document.getElementById('ocrText');
                
                if (ocrResult && ocrText) {
                    ocrResult.classList.remove('hidden');
                    ocrText.textContent = 'Processing image...';
                }
                
                // Create FormData for upload
                const formData = new FormData();
                formData.append('image', file);
                
                // Send to OCR API
                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.text) {
                        const extractedText = data.text;
                        
                        // Display OCR result
                        if (ocrText) {
                            ocrText.textContent = extractedText;
                        }
                        
                        // Add to chat
                        const message = {
                            type: 'ai',
                            content: `I can see the following text in your image:\n\n"${extractedText}"\n\nHow can I help you with this?`,
                            teacher: 'Roy Sir',
                            timestamp: new Date()
                        };
                        
                        addMessageToChat(message);
                        
                        // Close camera modal
                        closeCameraModal();
                        
                    } else {
                        if (ocrText) {
                            ocrText.textContent = 'No text found in image.';
                        }
                    }
                } else {
                    if (ocrText) {
                        ocrText.textContent = 'Error processing image.';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå OCR processing error:', error);
                const ocrText = document.getElementById('ocrText');
                if (ocrText) {
                    ocrText.textContent = 'Error processing image.';
                }
            }
        }

        // Assessment Functions
        function initializeAssessment() {
            console.log('üìã Initializing assessment features...');
            
            const startQuickTestBtn = document.getElementById('startQuickTest');
            const createCustomTestBtn = document.getElementById('createCustomTest');
            
            if (startQuickTestBtn) {
                startQuickTestBtn.addEventListener('click', startQuickTest);
            }
            
            if (createCustomTestBtn) {
                createCustomTestBtn.addEventListener('click', createCustomTest);
            }
        }

        function startQuickTest() {
            const subject = document.getElementById('testSubject').value;
            const duration = document.getElementById('testDuration').value;
            const difficulty = document.getElementById('testDifficulty').value;
            
            if (!subject) {
                alert('Please select a subject first!');
                return;
            }
            
            console.log('üöÄ Starting quick test:', { subject, duration, difficulty });
            
            // Show loading state
            const btn = document.getElementById('startQuickTest');
            const originalText = btn.textContent;
            btn.textContent = 'Generating Test...';
            btn.disabled = true;
            
            // Generate test using AI
            generateTest({
                type: 'quick',
                subject: subject,
                duration: parseInt(duration),
                difficulty: difficulty,
                questions: getQuestionCount(duration)
            }).then(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }).catch(error => {
                console.error('Error generating test:', error);
                alert('Failed to generate test. Please try again.');
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }

        function createCustomTest() {
            const topic = document.getElementById('customTestTopic').value.trim();
            const questions = document.getElementById('customTestQuestions').value;
            
            if (!topic) {
                alert('Please enter a topic for your custom test!');
                return;
            }
            
            console.log('üéØ Creating custom test:', { topic, questions });
            
            // Show loading state
            const btn = document.getElementById('createCustomTest');
            const originalText = btn.textContent;
            btn.textContent = 'Creating Test...';
            btn.disabled = true;
            
            // Generate custom test using AI
            generateTest({
                type: 'custom',
                topic: topic,
                questions: parseInt(questions),
                subject: 'custom'
            }).then(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }).catch(error => {
                console.error('Error creating custom test:', error);
                alert('Failed to create custom test. Please try again.');
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }

        async function generateTest(testConfig) {
            console.log('üß† Generating test with AI:', testConfig);
            
            try {
                // Try to get AI-generated test from backend
                const response = await fetch('/api/ai/generate-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: testConfig.subject,
                        classLevel: parseInt(currentUser?.class?.replace('Class ', '').replace('Please enter', '2') || '2'),
                        board: currentUser?.board || 'CBSE',
                        numberOfQuestions: testConfig.questions || 10,
                        duration: testConfig.duration || 15
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.questions && data.questions.length > 0) {
                        const testData = {
                            id: Date.now(),
                            title: `${testConfig.subject.charAt(0).toUpperCase() + testConfig.subject.slice(1)} Test`,
                            type: testConfig.type,
                            questions: data.questions.map(q => ({
                                type: 'mcq',
                                question: q.question,
                                options: q.options,
                                correct: q.correctAnswer,
                                explanation: q.explanation
                            })),
                            timeLimit: testConfig.duration || 15,
                            points: 5 + (data.questions.length * 2)
                        };
                        
                        showTest(testData);
                        return testData;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not generate AI test, using fallback:', error);
            }

            // Fallback to simulated test
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const testData = createSampleTest(testConfig);
                    showTest(testData);
                    resolve(testData);
                }, 1000);
            });
        }

        function createSampleTest(config) {
            const subjects = {
                'mathematics': ['Addition', 'Subtraction', 'Multiplication', 'Division', 'Fractions'],
                'science': ['Plants', 'Animals', 'Human Body', 'Matter', 'Energy'],
                'english': ['Grammar', 'Vocabulary', 'Reading', 'Writing', 'Speaking'],
                'hindi': ['‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£', '‡§∂‡§¨‡•ç‡§¶‡§æ‡§µ‡§≤‡•Ä', '‡§™‡§†‡§®', '‡§≤‡•á‡§ñ‡§®', '‡§¨‡•ã‡§≤‡§®‡§æ'],
                'evs': ['Family', 'Neighborhood', 'Transport', 'Communication', 'Safety'],
                'social_studies': ['History', 'Geography', 'Civics', 'Culture', 'Economy']
            };
            
            const questions = [];
            const questionCount = config.questions || 10;
            
            for (let i = 0; i < questionCount; i++) {
                const questionType = i < questionCount * 0.4 ? 'mcq' : (i < questionCount * 0.7 ? 'fill_blank' : 'true_false');
                
                if (questionType === 'mcq') {
                    questions.push({
                        type: 'mcq',
                        question: `Sample ${config.subject} question ${i + 1}?`,
                        options: ['Option A', 'Option B', 'Option C', 'Option D'],
                        correct: Math.floor(Math.random() * 4)
                    });
                } else if (questionType === 'fill_blank') {
                    questions.push({
                        type: 'fill_blank',
                        question: `Complete: The capital of India is _____.`,
                        answer: 'New Delhi'
                    });
                } else {
                    questions.push({
                        type: 'true_false',
                        question: `True or False: Sample statement ${i + 1}.`,
                        correct: Math.random() > 0.5
                    });
                }
            }
            
            return {
                id: Date.now(),
                title: `${config.subject.charAt(0).toUpperCase() + config.subject.slice(1)} Test`,
                type: config.type,
                questions: questions,
                timeLimit: config.duration || 15,
                points: 5 + (questions.length * 2)
            };
        }

        function showTest(testData) {
            console.log('üìù Showing test:', testData);
            
            // Create test modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'testModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] flex flex-col">
                    <div class="p-6 border-b border-gray-200 flex-shrink-0">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">${testData.title}</h2>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Time Remaining</div>
                                <div id="testTimer" class="text-xl font-bold text-blue-600">${testData.timeLimit}:00</div>
                            </div>
                        </div>
                        <div class="mt-2 text-gray-600">
                            <span class="font-medium">Questions:</span> ${testData.questions.length} ‚Ä¢ 
                            <span class="font-medium">Points:</span> ${testData.points} ‚Ä¢ 
                            <span class="font-medium">Type:</span> ${testData.type}
                        </div>
                    </div>
                    
                    <div class="p-6 flex-1 overflow-y-auto" style="max-height: 60vh;">
                        <div id="testQuestions" class="space-y-6">
                            ${testData.questions.map((q, index) => createQuestionHTML(q, index)).join('')}
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                        <div class="flex justify-between items-center">
                            <div class="text-gray-600">
                                <span id="answeredCount">0</span> of ${testData.questions.length} questions answered
                            </div>
                            <button id="submitTest" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                                Submit Test
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            setupTestEventListeners(testData);
            
            // Start timer
            startTestTimer(testData.timeLimit);
        }

        function createQuestionHTML(question, index) {
            if (question.type === 'mcq') {
                return `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">${index + 1}. ${question.question}</h3>
                        <div class="space-y-2">
                            ${question.options.map((option, optIndex) => `
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="q${index}" value="${optIndex}" class="w-4 h-4 text-blue-600">
                                    <span class="text-gray-700">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (question.type === 'fill_blank') {
                return `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">${index + 1}. ${question.question}</h3>
                        <input type="text" name="q${index}" placeholder="Type your answer here" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                `;
            } else {
                return `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">${index + 1}. ${question.question}</h3>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="q${index}" value="true" class="w-4 h-4 text-blue-600">
                                <span class="text-gray-700">True</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="q${index}" value="false" class="w-4 h-4 text-blue-600">
                                <span class="text-gray-700">False</span>
                            </label>
                        </div>
                    </div>
                `;
            }
        }

        function setupTestEventListeners(testData) {
            const submitBtn = document.getElementById('submitTest');
            const answeredCount = document.getElementById('answeredCount');
            
            // Update answered count
            const inputs = document.querySelectorAll('#testModal input');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    const answered = document.querySelectorAll('#testModal input:checked, #testModal input[type="text"]:not([value=""])').length;
                    answeredCount.textContent = answered;
                });
            });
            
            // Submit test
            submitBtn.addEventListener('click', () => {
                submitTest(testData);
            });
        }

        function startTestTimer(minutes) {
            let timeLeft = minutes * 60;
            const timerElement = document.getElementById('testTimer');
            
            const timer = setInterval(() => {
                const minutesLeft = Math.floor(timeLeft / 60);
                const secondsLeft = timeLeft % 60;
                timerElement.textContent = `${minutesLeft}:${secondsLeft.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    alert('Time is up! Submitting test automatically.');
                    submitTest();
                }
                timeLeft--;
            }, 1000);
        }

        function submitTest(testData) {
            console.log('üì§ Submitting test...');
            
            // Calculate score
            const score = calculateTestScore(testData);
            
            // Show results
            showTestResults(testData, score);
            
            // Close test modal
            const modal = document.getElementById('testModal');
            if (modal) {
                modal.remove();
            }
        }

        function calculateTestScore(testData) {
            // This would calculate actual score based on user answers
            // For now, return a sample score
            const correctAnswers = Math.floor(testData.questions.length * 0.8);
            const points = correctAnswers * 2 + 5; // 2 points per correct answer + 5 for taking test
            
            // Update user points
            updateAssessmentPoints(points);
            
            return {
                correct: correctAnswers,
                total: testData.questions.length,
                percentage: Math.round((correctAnswers / testData.questions.length) * 100),
                points: points
            };
        }

        async function updateAssessmentPoints(points) {
            const userPoints = window.userPoints || {
                quizPoints: 0,
                assessmentPoints: 0,
                totalPoints: 0,
                dailyStreak: 0,
                lastQuizDate: null
            };
            
            // Add assessment points
            userPoints.assessmentPoints += points;
            userPoints.totalPoints += points;
            
            // Save to localStorage
            localStorage.setItem('userPoints', JSON.stringify(userPoints));
            window.userPoints = userPoints;
            
            // Save to Supabase
            await savePointsToSupabase(points, 'assessment');
            
            // Update display if on daily quiz section
            const quizPointsElement = document.getElementById('quizPoints');
            const totalPointsElement = document.getElementById('totalPoints');
            
            if (quizPointsElement) quizPointsElement.textContent = userPoints.quizPoints;
            if (totalPointsElement) totalPointsElement.textContent = userPoints.totalPoints;
        }

        async function savePointsToSupabase(points, type) {
            try {
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, points saved locally only');
                    return;
                }
                
                const response = await fetch('/api/points/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        points: points,
                        type: type, // 'quiz' or 'assessment'
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Points saved to Supabase successfully');
                } else {
                    console.warn('‚ö†Ô∏è Failed to save points to Supabase');
                }
                
            } catch (error) {
                console.error('‚ùå Error saving points to Supabase:', error);
            }
        }

        function showTestResults(testData, score) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full p-6 text-center">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Test Completed!</h2>
                    <div class="space-y-3 mb-6">
                        <div class="text-3xl font-bold text-green-600">${score.percentage}%</div>
                        <div class="text-gray-600">${score.correct} out of ${score.total} correct</div>
                        <div class="text-lg font-semibold text-blue-600">+${score.points} points earned!</div>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                        Continue
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function getQuestionCount(duration) {
            const durationMap = {
                '5': 5,
                '10': 10,
                '15': 15,
                '20': 20,
                '30': 25
            };
            return durationMap[duration] || 10;
        }

        // Daily Quiz Functions
        function initializeDailyQuiz() {
            console.log('üéØ Initializing daily quiz features...');
            
            const submitBtn = document.getElementById('submitDailyAnswer');
            const skipBtn = document.getElementById('skipQuestion');
            const globalLeaderboardBtn = document.getElementById('showGlobalLeaderboard');
            const classLeaderboardBtn = document.getElementById('showClassLeaderboard');
            
            if (submitBtn) submitBtn.addEventListener('click', submitDailyAnswer);
            if (skipBtn) skipBtn.addEventListener('click', skipDailyQuestion);
            if (globalLeaderboardBtn) globalLeaderboardBtn.addEventListener('click', () => showLeaderboard('global'));
            if (classLeaderboardBtn) classLeaderboardBtn.addEventListener('click', () => showLeaderboard('class'));
            
            // Load daily quiz data
            loadDailyQuizData();
        }

        function loadDailyQuizData() {
            console.log('üéØ Loading daily quiz data...');
            
            // Load user points and streak
            loadUserPoints();
            
            // Load today's question
            loadTodayQuestion();
            
            // Load question history
            loadQuestionHistory();
            
            // Load initial leaderboard
            showLeaderboard('global');
        }

        function loadUserPoints() {
            // Get points from localStorage or initialize
            const userPoints = JSON.parse(localStorage.getItem('userPoints')) || {
                quizPoints: 0,
                assessmentPoints: 0,
                totalPoints: 0,
                dailyStreak: 0,
                lastQuizDate: null
            };
            
            // Update display
            document.getElementById('quizPoints').textContent = userPoints.quizPoints;
            document.getElementById('totalPoints').textContent = userPoints.totalPoints;
            document.getElementById('dailyStreak').textContent = userPoints.dailyStreak;
            
            // Store in global variable
            window.userPoints = userPoints;
        }

        function loadTodayQuestion() {
            console.log('üéØ Loading today\'s question...');
            
            const today = new Date().toDateString();
            const lastQuestionDate = localStorage.getItem('lastQuestionDate');
            
            if (lastQuestionDate === today) {
                // Load existing question
                const savedQuestion = JSON.parse(localStorage.getItem('todayQuestion'));
                if (savedQuestion) {
                    displayTodayQuestion(savedQuestion);
                    return;
                }
            }
            
            // Generate new question
            generateDailyQuestion();
        }

        async function generateDailyQuestion() {
            console.log('üß† Generating daily question...');
            
            const questionContent = document.getElementById('dailyQuestionContent');
            questionContent.innerHTML = '<p class="text-gray-500">Generating today\'s question...</p>';
            
            try {
                // Try to get AI-generated question from backend
                const response = await fetch('/api/ai/generate-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: 'General',
                        classLevel: parseInt(currentUser?.class?.replace('Class ', '') || '2'),
                        board: currentUser?.board || 'CBSE',
                        numberOfQuestions: 1,
                        duration: 5
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.questions && data.questions.length > 0) {
                        const aiQuestion = data.questions[0];
                        const question = {
                            id: Date.now(),
                            subject: 'General',
                            question: aiQuestion.question,
                            options: aiQuestion.options,
                            correctAnswer: aiQuestion.correctAnswer,
                            explanation: aiQuestion.explanation,
                            points: 10,
                            date: new Date().toDateString()
                        };
                        
                        // Save question for today
                        localStorage.setItem('todayQuestion', JSON.stringify(question));
                        localStorage.setItem('lastQuestionDate', new Date().toDateString());
                        
                        // Display question
                        displayTodayQuestion(question);
                        return;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not generate AI question, using fallback:', error);
            }

            // Fallback to simulated question
            setTimeout(() => {
                const question = createDailyQuestion();
                
                // Save question for today
                localStorage.setItem('todayQuestion', JSON.stringify(question));
                localStorage.setItem('lastQuestionDate', new Date().toDateString());
                
                // Display question
                displayTodayQuestion(question);
                
            }, 1000);
        }

        function createDailyQuestion() {
            const userClass = currentUser?.class || '2';
            const subjects = ['Mathematics', 'Science', 'English', 'Hindi', 'EVS'];
            const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
            
            // Generate question based on class and subject
            const question = generateSubjectQuestion(randomSubject, userClass);
            
            return {
                id: Date.now(),
                subject: randomSubject,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                explanation: question.explanation,
                points: 10,
                date: new Date().toDateString()
            };
        }

        function generateSubjectQuestion(subject, userClass) {
            const classLevel = parseInt(userClass);
            
            if (subject === 'Mathematics') {
                if (classLevel <= 3) {
                    return {
                        question: `What is ${2 + 3}?`,
                        options: ['4', '5', '6', '7'],
                        correctAnswer: 1,
                        explanation: '2 + 3 = 5. This is basic addition for young learners.'
                    };
                } else if (classLevel <= 5) {
                    return {
                        question: `What is 8 √ó 7?`,
                        options: ['54', '56', '58', '60'],
                        correctAnswer: 1,
                        explanation: '8 √ó 7 = 56. Practice your multiplication tables!'
                    };
                } else {
                    return {
                        question: `What is 15% of 200?`,
                        options: ['25', '30', '35', '40'],
                        correctAnswer: 1,
                        explanation: '15% of 200 = (15/100) √ó 200 = 30.'
                    };
                }
            } else if (subject === 'Science') {
                if (classLevel <= 3) {
                    return {
                        question: 'Which part of a plant helps it make food?',
                        options: ['Roots', 'Leaves', 'Stem', 'Flowers'],
                        correctAnswer: 1,
                        explanation: 'Leaves help plants make food through photosynthesis using sunlight.'
                    };
                } else if (classLevel <= 5) {
                    return {
                        question: 'What is the process by which plants make their own food called?',
                        options: ['Respiration', 'Photosynthesis', 'Digestion', 'Excretion'],
                        correctAnswer: 1,
                        explanation: 'Photosynthesis is the process where plants use sunlight to make food.'
                    };
                } else {
                    return {
                        question: 'What is the chemical formula for water?',
                        options: ['H2O', 'CO2', 'O2', 'N2'],
                        correctAnswer: 0,
                        explanation: 'H2O represents water - 2 hydrogen atoms and 1 oxygen atom.'
                    };
                }
            } else if (subject === 'English') {
                if (classLevel <= 3) {
                    return {
                        question: 'Which word is a noun in "The cat runs fast"?',
                        options: ['The', 'cat', 'runs', 'fast'],
                        correctAnswer: 1,
                        explanation: 'A noun is a person, place, or thing. "Cat" is a thing.'
                    };
                } else if (classLevel <= 5) {
                    return {
                        question: 'What is the past tense of "run"?',
                        options: ['runned', 'ran', 'running', 'runs'],
                        correctAnswer: 1,
                        explanation: 'The past tense of "run" is "ran".'
                    };
                } else {
                    return {
                        question: 'Identify the figure of speech: "Life is a journey."',
                        options: ['Simile', 'Metaphor', 'Personification', 'Alliteration'],
                        correctAnswer: 1,
                        explanation: 'This is a metaphor - comparing life to a journey without using "like" or "as".'
                    };
                }
            } else if (subject === 'Hindi') {
                if (classLevel <= 3) {
                    return {
                        question: '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç "‡§™‡§æ‡§®‡•Ä" ‡§ï‡§æ ‡§Ö‡§∞‡•ç‡§• ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?',
                        options: ['Fire', 'Water', 'Air', 'Earth'],
                        correctAnswer: 1,
                        explanation: '"‡§™‡§æ‡§®‡•Ä" means water in Hindi.'
                    };
                } else if (classLevel <= 5) {
                    return {
                        question: '"‡§Æ‡•à‡§Ç ‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å" ‡§Æ‡•á‡§Ç ‡§ï‡•å‡§® ‡§∏‡§æ ‡§ï‡§æ‡§≤ ‡§π‡•à?',
                        options: ['‡§≠‡•Ç‡§§‡§ï‡§æ‡§≤', '‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§ï‡§æ‡§≤', '‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡§æ‡§≤', '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡§æ‡§≤'],
                        correctAnswer: 1,
                        explanation: '‡§Ø‡§π ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§ï‡§æ‡§≤ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ "‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å" ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡•§'
                    };
                } else {
                    return {
                        question: '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç "‡§∏‡§∞‡•ç‡§µ‡§®‡§æ‡§Æ" ‡§ï‡§ø‡§∏‡•á ‡§ï‡§π‡§§‡•á ‡§π‡•à‡§Ç?',
                        options: ['‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ', '‡§∏‡§∞‡•ç‡§µ‡§®‡§æ‡§Æ', '‡§µ‡§ø‡§∂‡•á‡§∑‡§£', '‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ'],
                        correctAnswer: 1,
                        explanation: '‡§∏‡§∞‡•ç‡§µ‡§®‡§æ‡§Æ ‡§µ‡•á ‡§∂‡§¨‡•ç‡§¶ ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§∏‡§Ç‡§ú‡•ç‡§û‡§æ ‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§'
                    };
                }
            } else { // EVS
                if (classLevel <= 3) {
                    return {
                        question: 'Which mode of transport flies in the sky?',
                        options: ['Car', 'Train', 'Airplane', 'Ship'],
                        correctAnswer: 2,
                        explanation: 'Airplanes fly in the sky, making them a mode of air transport.'
                    };
                } else if (classLevel <= 5) {
                    return {
                        question: 'What is the capital of India?',
                        options: ['Mumbai', 'Delhi', 'Kolkata', 'Chennai'],
                        correctAnswer: 1,
                        explanation: 'New Delhi is the capital of India.'
                    };
                } else {
                    return {
                        question: 'Which is the largest planet in our solar system?',
                        options: ['Earth', 'Mars', 'Jupiter', 'Saturn'],
                        correctAnswer: 2,
                        explanation: 'Jupiter is the largest planet in our solar system.'
                    };
                }
            }
        }

        function displayTodayQuestion(question) {
            console.log('üéØ Displaying today\'s question:', question);
            
            const questionContent = document.getElementById('dailyQuestionContent');
            const questionOptions = document.getElementById('dailyQuestionOptions');
            
            questionContent.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-sm text-blue-600 mb-2">${question.subject}</div>
                    <div class="text-lg font-medium text-gray-800">${question.question}</div>
                </div>
            `;
            
            questionOptions.innerHTML = question.options.map((option, index) => `
                <label class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <input type="radio" name="dailyAnswer" value="${index}" class="w-4 h-4 text-blue-600">
                    <span class="text-gray-700">${option}</span>
                </label>
            `).join('');
            
            // Enable submit button
            document.getElementById('submitDailyAnswer').disabled = false;
        }

        function submitDailyAnswer() {
            console.log('üéØ Submitting daily quiz answer...');
            
            const selectedAnswer = document.querySelector('input[name="dailyAnswer"]:checked');
            
            if (!selectedAnswer) {
                alert('Please select an answer first!');
                return;
            }
            
            const answer = parseInt(selectedAnswer.value);
            const question = JSON.parse(localStorage.getItem('todayQuestion'));
            
            if (!question) {
                alert('No question found. Please refresh the page.');
                return;
            }
            
            const isCorrect = answer === question.correctAnswer;
            const pointsEarned = isCorrect ? question.points : 0;
            
            console.log('‚úÖ Answer submitted:', { answer, correct: question.correctAnswer, isCorrect, pointsEarned });
            
            // Update user points
            updateUserPoints(pointsEarned, isCorrect);
            
            // Show result with celebration
            showDailyQuizResult(isCorrect, pointsEarned, question);
            
            // Update question history
            updateQuestionHistory(question, isCorrect, answer);
        }

        async function updateUserPoints(pointsEarned, isCorrect) {
            const userPoints = window.userPoints || {
                quizPoints: 0,
                assessmentPoints: 0,
                totalPoints: 0,
                dailyStreak: 0,
                lastQuizDate: null
            };
            
            // Add quiz points
            userPoints.quizPoints += pointsEarned;
            userPoints.totalPoints += pointsEarned;
            
            // Update daily streak
            const today = new Date().toDateString();
            if (isCorrect && userPoints.lastQuizDate !== today) {
                userPoints.dailyStreak += 1;
                userPoints.lastQuizDate = today;
            }
            
            // Save to localStorage
            localStorage.setItem('userPoints', JSON.stringify(userPoints));
            window.userPoints = userPoints;
            
            // Save to Supabase if points earned
            if (pointsEarned > 0) {
                await savePointsToSupabase(pointsEarned, 'quiz');
            }
            
            // Update display
            document.getElementById('quizPoints').textContent = userPoints.quizPoints;
            document.getElementById('totalPoints').textContent = userPoints.totalPoints;
            document.getElementById('dailyStreak').textContent = userPoints.dailyStreak;
        }

        function showDailyQuizResult(isCorrect, pointsEarned, question) {
            // Create celebration modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'quizResultModal';
            
            if (isCorrect) {
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-md w-full p-6 text-center">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h2 class="text-2xl font-bold text-green-600 mb-4">Correct Answer!</h2>
                        <div class="text-lg text-gray-700 mb-4">+${pointsEarned} points earned!</div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-4">
                            <div class="text-sm text-green-600 font-medium">Explanation:</div>
                            <div class="text-gray-700">${question.explanation}</div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                            Continue
                        </button>
                    </div>
                `;
                
                // Add celebration effects
                addCelebrationEffects();
            } else {
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-md w-full p-6 text-center">
                        <div class="text-6xl mb-4">üí™</div>
                        <h2 class="text-2xl font-bold text-blue-600 mb-4">Keep Learning!</h2>
                        <div class="text-lg text-gray-700 mb-4">No points this time, but you learned something!</div>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                            <div class="text-sm text-blue-600 font-medium">Correct Answer:</div>
                            <div class="text-gray-700">${question.options[question.correctAnswer]}</div>
                            <div class="text-sm text-blue-600 font-medium mt-2">Explanation:</div>
                            <div class="text-gray-700">${question.explanation}</div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            Continue
                        </button>
                    </div>
                `;
            }
            
            document.body.appendChild(modal);
        }

        function addCelebrationEffects() {
            // Add balloons, stars, and sparkles
            const celebrationContainer = document.createElement('div');
            celebrationContainer.className = 'fixed inset-0 pointer-events-none z-40';
            celebrationContainer.id = 'celebrationEffects';
            
            // Create balloons
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createBalloon(celebrationContainer);
                }, i * 200);
            }
            
            // Create stars
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createStar(celebrationContainer);
                }, i * 150);
            }
            
            // Create sparkles
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    createSparkle(celebrationContainer);
                }, i * 100);
            }
            
            document.body.appendChild(celebrationContainer);
            
            // Remove after animation
            setTimeout(() => {
                if (celebrationContainer) {
                    celebrationContainer.remove();
                }
            }, 5000);
        }

        function createBalloon(container) {
            const balloon = document.createElement('div');
            balloon.className = 'absolute text-4xl animate-bounce';
            balloon.style.left = Math.random() * 100 + '%';
            balloon.style.top = '100%';
            balloon.style.animationDuration = '3s';
            balloon.innerHTML = 'üéà';
            
            container.appendChild(balloon);
            
            // Animate balloon floating up
            setTimeout(() => {
                balloon.style.transition = 'all 3s ease-out';
                balloon.style.top = '-10%';
                balloon.style.transform = 'rotate(' + (Math.random() * 60 - 30) + 'deg)';
            }, 100);
        }

        function createStar(container) {
            const star = document.createElement('div');
            star.className = 'absolute text-2xl animate-pulse';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDuration = '2s';
            star.innerHTML = '‚≠ê';
            
            container.appendChild(star);
            
            // Remove star after animation
            setTimeout(() => {
                if (star.parentNode) {
                    star.remove();
                }
            }, 2000);
        }

        function createSparkle(container) {
            const sparkle = document.createElement('div');
            sparkle.className = 'absolute text-lg animate-spin';
            sparkle.style.left = Math.random() * 100 + '%';
            sparkle.style.top = Math.random() * 100 + '%';
            sparkle.style.animationDuration = '1s';
            sparkle.innerHTML = '‚ú®';
            
            container.appendChild(sparkle);
            
            // Remove sparkle after animation
            setTimeout(() => {
                if (sparkle.parentNode) {
                    sparkle.remove();
                }
            }, 1000);
        }

        function skipDailyQuestion() {
            const question = JSON.parse(localStorage.getItem('todayQuestion'));
            if (question) {
                updateQuestionHistory(question, false, -1); // -1 indicates skipped
            }
            
            // Show skip message
            alert('Question skipped. You can try again tomorrow!');
        }

        function updateQuestionHistory(question, isCorrect, userAnswer) {
            const history = JSON.parse(localStorage.getItem('questionHistory')) || [];
            
            const historyItem = {
                ...question,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                answeredAt: new Date().toISOString()
            };
            
            history.unshift(historyItem);
            
            // Keep only last 10 questions
            if (history.length > 10) {
                history.pop();
            }
            
            localStorage.setItem('questionHistory', JSON.stringify(history));
            
            // Reload question history display
            loadQuestionHistory();
        }

        function loadQuestionHistory() {
            const history = JSON.parse(localStorage.getItem('questionHistory')) || [];
            const historyContainer = document.getElementById('questionHistory');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 text-center">No questions answered yet.</p>';
                return;
            }
            
            historyContainer.innerHTML = history.map(item => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-sm font-medium text-gray-600">${item.subject}</span>
                                <span class="text-xs px-2 py-1 rounded ${item.isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${item.isCorrect ? 'Correct' : (item.userAnswer === -1 ? 'Skipped' : 'Wrong')}
                                </span>
                            </div>
                            <div class="text-gray-800 text-sm mb-2">${item.question}</div>
                            <div class="text-xs text-gray-500">
                                ${new Date(item.answeredAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${item.isCorrect ? 'text-green-600' : 'text-gray-400'}">
                                ${item.isCorrect ? '+' + item.points : '0'}
                            </div>
                            <div class="text-xs text-gray-500">points</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function showLeaderboard(type) {
            console.log('üèÜ Showing leaderboard:', type);
            
            const globalBtn = document.getElementById('showGlobalLeaderboard');
            const classBtn = document.getElementById('showClassLeaderboard');
            const leaderboardContent = document.getElementById('leaderboardContent');
            
            // Update button styles
            if (type === 'global') {
                globalBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors';
                classBtn.className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors';
            } else {
                globalBtn.className = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors';
                classBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors';
            }
            
            // Show loading
            leaderboardContent.innerHTML = '<div class="text-center text-gray-500">Loading leaderboard...</div>';
            
            try {
                // Fetch real leaderboard data from Supabase
                const leaderboardData = await generateLeaderboardData(type);
                displayLeaderboard(leaderboardData, type);
            } catch (error) {
                console.error('‚ùå Error loading leaderboard:', error);
                leaderboardContent.innerHTML = '<div class="text-center text-red-500">Failed to load leaderboard. Please try again.</div>';
            }
        }

        async function generateLeaderboardData(type) {
            try {
                console.log('üèÜ Fetching leaderboard data from Supabase...');
                
                // Get session data
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, using mock data');
                    return getMockLeaderboardData(type);
                }
                
                // Get user's city for city-specific leaderboard
                const userCity = currentUser?.city || 'all';
                
                // Fetch students with points from Supabase
                const response = await fetch('/api/students/leaderboard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ type, city: userCity })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Leaderboard data fetched:', data);
                    
                    // Return the structured data with India Top 3 and City Top 3
                    return data;
                } else {
                    console.warn('‚ö†Ô∏è Failed to fetch leaderboard, using mock data');
                    return getMockLeaderboardData(type);
                }
                
            } catch (error) {
                console.error('‚ùå Error fetching leaderboard:', error);
                return getMockLeaderboardData(type);
            }
        }
        
        function getMockLeaderboardData(type) {
            // Fallback mock data if Supabase is unavailable - shows empty positions
            const mockData = [
                { name: 'No students yet', class: '-', points: 0, rank: 1, avatar: '?' },
                { name: 'Position available', class: '-', points: 0, rank: 2, avatar: '?' },
                { name: 'Position available', class: '-', points: 0, rank: 3, avatar: '?' }
            ];
            
            if (type === 'global') {
                mockData.push(
                    { name: 'Position available', class: '-', points: 0, rank: 4, avatar: '?' },
                    { name: 'Position available', class: '-', points: 0, rank: 5, avatar: '?' }
                );
            }
            
            return mockData;
        }

        function displayLeaderboard(data, type) {
            const leaderboardContent = document.getElementById('leaderboardContent');
            
            let html = '';
            
            // Display India Top 3
            if (data.indiaTop3 && data.indiaTop3.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">üáÆüá≥</span>
                            India Top 3
                        </h3>
                        <div class="space-y-3">
                            ${data.indiaTop3.map(user => `
                                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                            ${user.avatar}
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-800">${user.name}</div>
                                            <div class="text-sm text-gray-500">Class ${user.class} ‚Ä¢ ${user.city || 'City'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-yellow-600">${user.points}</div>
                                        <div class="text-xs text-gray-500">points</div>
                                    </div>
                                    <div class="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                        ${user.rank}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Display City Top 3
            if (data.cityTop3 && data.cityTop3.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">üèôÔ∏è</span>
                            ${currentUser?.city || 'Your City'} Top 3
                        </h3>
                        <div class="space-y-3">
                            ${data.cityTop3.map(user => `
                                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                            ${user.avatar}
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-800">${user.name}</div>
                                            <div class="text-sm text-gray-500">Class ${user.class}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-blue-600">${user.points}</div>
                                        <div class="text-xs text-gray-500">points</div>
                                    </div>
                                    <div class="w-8 h-8 bg-blue-400 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                        ${user.rank}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Display Class Top 3 (if available)
            if (data.classTop3 && data.classTop3.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="mr-2">üìö</span>
                            Class Top 3
                        </h3>
                        <div class="space-y-3">
                            ${data.classTop3.map(user => `
                                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                            ${user.avatar}
                                        </div>
                                        <div>
                                            <div class="font-medium text-gray-800">${user.name}</div>
                                            <div class="text-sm text-gray-500">Class ${user.class} ‚Ä¢ ${user.city || 'City'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-green-600">${user.points}</div>
                                        <div class="text-xs text-gray-500">points</div>
                                    </div>
                                    <div class="w-8 h-8 bg-green-400 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                        ${user.rank}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // If no data available, show placeholder
            if (!html) {
                html = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üèÜ</div>
                        <p>No leaderboard data available yet.</p>
                        <p class="text-sm">Start earning points to appear on the leaderboard!</p>
                    </div>
                `;
            }
            
            leaderboardContent.innerHTML = html;
            
            // Update user's rank position (if data is available)
            if (data.indiaTop3 && data.indiaTop3.length > 0) {
                updateUserRank(data.indiaTop3);
            }
        }

        function updateUserRank(leaderboardData) {
            const currentUserPoints = window.userPoints?.totalPoints || 0;
            const userRank = leaderboardData.findIndex(user => user.points === currentUserPoints) + 1;
            
            if (userRank > 0) {
                document.getElementById('rankPosition').textContent = userRank;
            } else {
                document.getElementById('rankPosition').textContent = '-';
            }
        }

        // Profile Management Functions
        function initializeProfile() {
            console.log('üë§ Initializing profile features...');
            
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const resetProfileBtn = document.getElementById('resetProfileBtn');
            const addSubjectBtn = document.getElementById('addSubjectBtn');
            
            if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfile);
            if (resetProfileBtn) resetProfileBtn.addEventListener('click', resetProfile);
            if (addSubjectBtn) addSubjectBtn.addEventListener('click', addCustomSubject);
            
            // Load profile data
            loadProfileData();
        }

        async function loadProfileData() {
            console.log('üë§ Loading profile data from Supabase...');
            
            try {
                // Get session data
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, using local data');
                    loadProfileFromLocal();
                    return;
                }
                
                // Fetch user profile from Supabase
                const response = await fetch('/api/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                
                if (response.ok) {
                    const profileData = await response.json();
                    console.log('‚úÖ Profile data loaded from Supabase:', profileData);
                    
                    // Update current user with real data, use 'Please enter' for empty fields
                    currentUser = {
                        ...currentUser,
                        name: profileData.name || 'Please enter',
                        email: profileData.email || 'Please enter',
                        class: profileData.class || 'Please enter',
                        board: profileData.board || 'CBSE',
                        school: profileData.school || 'Please enter',
                        city: profileData.city || 'Please enter',
                        phone: profileData.phone || 'Please enter'
                    };
                    
                    // Update display
                    updateProfileDisplay();
                    updateSidebarUserInfo();
                    
                    // Load subjects
                    loadUserSubjectsFromSupabase();
                } else {
                    console.warn('‚ö†Ô∏è Failed to fetch profile, using local data');
                    loadProfileFromLocal();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading profile:', error);
                loadProfileFromLocal();
            }
        }

        function loadProfileFromLocal() {
            console.log('üì± Loading profile from local storage...');
            
            // Load from localStorage or use default
            const savedProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
            
            // Merge with current user data, but ensure we have proper defaults
            currentUser = {
                name: savedProfile.name || 'Please enter',
                email: savedProfile.email || 'Please enter',
                class: savedProfile.class || 'Please enter',
                board: savedProfile.board || 'CBSE',
                school: savedProfile.school || 'Please enter',
                city: savedProfile.city || 'Please enter',
                phone: savedProfile.phone || 'Please enter',
                ...savedProfile
            };
            
            console.log('üë§ Current user data:', currentUser);
            
            // Update display
            updateProfileDisplay();
            
            // Load subjects from local
            loadUserSubjects();
        }

        async function loadUserSubjectsFromSupabase() {
            try {
                console.log('üìö Loading subjects from Supabase...');
                
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, using default subjects');
                    loadUserSubjects();
                    return;
                }
                
                // Fetch subjects from Supabase
                const response = await fetch('/api/subjects', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                
                if (response.ok) {
                    const subjects = await response.json();
                    console.log('‚úÖ Subjects loaded from Supabase:', subjects);
                    displaySubjects(subjects);
                } else {
                    console.warn('‚ö†Ô∏è Failed to fetch subjects, using defaults');
                    loadUserSubjects();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading subjects:', error);
                loadUserSubjects();
            }
        }

        function loadUserSubjects() {
            const subjectsContainer = document.getElementById('subjectsContainer');
            if (!subjectsContainer) return;
            
            // Get user subjects from localStorage or use defaults
            const userSubjects = JSON.parse(localStorage.getItem('userSubjects')) || [
                'Mathematics', 'Science', 'English', 'Hindi', 'EVS'
            ];
            
            displaySubjects(userSubjects);
        }

        function displaySubjects(subjects) {
            const subjectsContainer = document.getElementById('subjectsContainer');
            if (!subjectsContainer) return;
            
            subjectsContainer.innerHTML = subjects.map(subject => `
                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <span class="text-gray-700 font-medium">${subject}</span>
                    <button onclick="removeSubject('${subject}')" class="text-red-500 hover:text-red-700 text-lg">
                        √ó
                    </button>
                </div>
            `).join('');
        }

        function addCustomSubject() {
            const newSubjectInput = document.getElementById('newSubject');
            const subjectName = newSubjectInput.value.trim();
            
            if (!subjectName) {
                alert('Please enter a subject name');
                return;
            }
            
            // Get current subjects
            const currentSubjects = JSON.parse(localStorage.getItem('userSubjects')) || [
                'Mathematics', 'Science', 'English', 'Hindi', 'EVS'
            ];
            
            // Check if subject already exists
            if (currentSubjects.includes(subjectName)) {
                alert('This subject already exists!');
                return;
            }
            
            // Add new subject
            currentSubjects.push(subjectName);
            localStorage.setItem('userSubjects', JSON.stringify(currentSubjects));
            
            // Reload subjects display
            loadUserSubjects();
            
            // Clear input
            newSubjectInput.value = '';
            
            console.log('‚úÖ Added new subject:', subjectName);
        }

        function removeSubject(subjectName) {
            // Get current subjects
            const currentSubjects = JSON.parse(localStorage.getItem('userSubjects')) || [
                'Mathematics', 'Science', 'English', 'Hindi', 'EVS'
            ];
            
            // Remove subject
            const updatedSubjects = currentSubjects.filter(subject => subject !== subjectName);
            localStorage.setItem('userSubjects', JSON.stringify(updatedSubjects));
            
            // Reload subjects display
            loadUserSubjects();
            
            console.log('‚úÖ Removed subject:', subjectName);
        }

        async function saveProfile() {
            console.log('üíæ Saving profile...');
            
            // Validate required fields
            const fullName = document.getElementById('profileFullName').value.trim();
            const userClass = document.getElementById('profileClass').value;
            
            if (!fullName) {
                alert('Full Name is required!');
                return;
            }
            
            if (!userClass) {
                alert('Class is required!');
                return;
            }
            
            // Collect all profile data
            const profileData = {
                name: fullName,
                class: userClass,
                dob: document.getElementById('profileDOB').value,
                gender: document.getElementById('profileGender').value,
                city: document.getElementById('profileCity').value,
                board: document.getElementById('profileBoard').value,
                school: document.getElementById('profileSchool').value,
                rollNo: document.getElementById('profileRollNo').value,
                email: currentUser.email,
                phone: currentUser.phone
            };
            
            try {
                // Save to Supabase if session exists
                const session = JSON.parse(localStorage.getItem('session'));
                if (session?.access_token) {
                    console.log('üíæ Saving profile to Supabase...');
                    
                    const response = await fetch('/api/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify(profileData)
                    });
                    
                    if (response.ok) {
                        console.log('‚úÖ Profile saved to Supabase successfully');
                    } else {
                        console.warn('‚ö†Ô∏è Failed to save to Supabase, using local storage only');
                    }
                }
                
                // Update current user
                currentUser = { ...currentUser, ...profileData };
                
                // Save to localStorage as backup
                localStorage.setItem('userProfile', JSON.stringify(profileData));
                
                // Update display
                updateProfileDisplay();
                
                // Update sidebar
                const userName = document.getElementById('userName');
                const userClassDisplay = document.getElementById('userClass');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userName) userName.textContent = currentUser.name;
                if (userClassDisplay) userClassDisplay.textContent = `Class ${currentUser.class}`;
                if (userAvatar) userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
                
                // Show success message
                showProfileSaveSuccess();
                
                console.log('‚úÖ Profile saved successfully:', profileData);
                
            } catch (error) {
                console.error('‚ùå Error saving profile:', error);
                alert('Failed to save profile. Please try again.');
            }
        }

        function resetProfile() {
            console.log('üîÑ Resetting profile...');
            
            if (confirm('Are you sure you want to reset your profile to default values? This will clear all your custom data.')) {
                // Clear saved profile
                localStorage.removeItem('userProfile');
                
                // Reset current user to defaults
                currentUser = {
                name: 'Student',
                email: 'student@example.com',
                class: '2',
                board: 'CBSE',
                school: 'School Name',
                city: 'City',
                phone: 'Phone Number',
                dob: '',
                gender: '',
                rollNo: ''
                };
                
                // Update display
                updateProfileDisplay();
                
                // Show reset message
                showProfileResetMessage();
                
                console.log('‚úÖ Profile reset to defaults');
            }
        }

        function showProfileSaveSuccess() {
            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">‚úÖ</span>
                    <span>Profile saved successfully!</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        function showProfileResetMessage() {
            // Create reset notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">üîÑ</span>
                    <span>Profile reset to defaults!</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Settings Management Functions
        function initializeSettings() {
            console.log('‚öôÔ∏è Initializing settings features...');
            
            // Initialize avatar selection
            initializeAvatarSelection();
            
            // Initialize notification toggles
            initializeNotificationToggles();
            
            // Initialize appearance settings
            initializeAppearanceSettings();
            
            // Initialize privacy settings
            initializePrivacySettings();
            
            // Initialize account action buttons
            initializeAccountActions();
            
            // Initialize save/reset buttons
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const resetSettingsBtn = document.getElementById('resetSettingsBtn');
            
            if (saveSettingsBtn) saveSettingsBtn.addEventListener('click', saveSettings);
            if (resetSettingsBtn) resetSettingsBtn.addEventListener('click', resetSettings);
            
            // Load saved settings
            loadSettings();
        }

        function initializeAvatarSelection() {
            const avatarOptions = document.querySelectorAll('.avatar-option');
            
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    avatarOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
                    
                    // Add active class to selected option
                    this.classList.add('border-blue-500', 'bg-blue-50');
                    
                    // Update current avatar display
                    const avatarName = this.querySelector('.text-sm.font-medium').textContent;
                    document.getElementById('currentAvatarDisplay').textContent = avatarName;
                    
                    // Save selection
                    const avatarType = this.dataset.avatar;
                    localStorage.setItem('selectedAvatar', avatarType);
                    
                    console.log('‚úÖ Avatar selected:', avatarType);
                });
            });
        }

        function initializeNotificationToggles() {
            const notificationToggles = document.querySelectorAll('input[type="checkbox"]');
            
            notificationToggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const settingName = this.id;
                    const isEnabled = this.checked;
                    
                    // Save setting
                    localStorage.setItem(`setting_${settingName}`, isEnabled);
                    
                    console.log('‚úÖ Notification setting updated:', settingName, isEnabled);
                });
            });
        }

        function initializeAppearanceSettings() {
            const themeSelector = document.getElementById('themeSelector');
            const fontSizeSelector = document.getElementById('fontSizeSelector');
            const colorOptions = document.querySelectorAll('.color-option');
            
            if (themeSelector) {
                themeSelector.addEventListener('change', function() {
                    localStorage.setItem('setting_theme', this.value);
                    applyTheme(this.value);
                });
            }
            
            if (fontSizeSelector) {
                fontSizeSelector.addEventListener('change', function() {
                    localStorage.setItem('setting_fontSize', this.value);
                    applyFontSize(this.value);
                });
            }
            
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    colorOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
                    
                    // Add active class to selected option
                    this.classList.add('border-blue-500', 'bg-blue-50');
                    
                    // Save and apply color scheme
                    const colorScheme = this.dataset.color;
                    localStorage.setItem('setting_colorScheme', colorScheme);
                    applyColorScheme(colorScheme);
                    
                    console.log('‚úÖ Color scheme selected:', colorScheme);
                });
            });
        }

        function initializePrivacySettings() {
            const privacyToggles = document.querySelectorAll('#profileVisibility, #leaderboardVisibility, #dataCollection, #autoLogout');
            
            privacyToggles.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const settingName = this.id;
                    const isEnabled = this.checked;
                    
                    // Save setting
                    localStorage.setItem(`setting_${settingName}`, isEnabled);
                    
                    console.log('‚úÖ Privacy setting updated:', settingName, isEnabled);
                });
            });
        }

        function initializeAccountActions() {
            const exportDataBtn = document.getElementById('exportDataBtn');
            const resetProgressBtn = document.getElementById('resetProgressBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportUserData);
            if (resetProgressBtn) resetProgressBtn.addEventListener('click', resetUserProgress);
            if (deleteAccountBtn) deleteAccountBtn.addEventListener('click', deleteUserAccount);
        }

        function loadSettings() {
            console.log('‚öôÔ∏è Loading saved settings...');
            
            // Load avatar selection
            const savedAvatar = localStorage.getItem('selectedAvatar') || 'roy_sir';
            const avatarOption = document.querySelector(`[data-avatar="${savedAvatar}"]`);
            if (avatarOption) {
                avatarOption.click(); // This will trigger the click event and update display
            }
            
            // Load notification settings
            const notificationSettings = [
                'dailyQuizNotifications', 'assessmentNotifications', 
                'studyReminders', 'emailNotifications'
            ];
            
            notificationSettings.forEach(setting => {
                const element = document.getElementById(setting);
                if (element) {
                    const savedValue = localStorage.getItem(`setting_${setting}`);
                    if (savedValue !== null) {
                        element.checked = savedValue === 'true';
                    }
                }
            });
            
            // Load appearance settings
            const savedTheme = localStorage.getItem('setting_theme') || 'light';
            const savedFontSize = localStorage.getItem('setting_fontSize') || 'medium';
            const savedColorScheme = localStorage.getItem('setting_colorScheme') || 'blue';
            
            const themeSelector = document.getElementById('themeSelector');
            const fontSizeSelector = document.getElementById('fontSizeSelector');
            
            if (themeSelector) themeSelector.value = savedTheme;
            if (fontSizeSelector) fontSizeSelector.value = savedFontSize;
            
            // Apply color scheme
            const colorOption = document.querySelector(`[data-color="${savedColorScheme}"]`);
            if (colorOption) {
                colorOption.click();
            }
            
            // Load privacy settings
            const privacySettings = [
                'profileVisibility', 'leaderboardVisibility', 
                'dataCollection', 'autoLogout'
            ];
            
            privacySettings.forEach(setting => {
                const element = document.getElementById(setting);
                if (element) {
                    const savedValue = localStorage.getItem(`setting_${setting}`);
                    if (savedValue !== null) {
                        element.checked = savedValue === 'true';
                    }
                }
            });
            
            console.log('‚úÖ Settings loaded successfully');
        }

        function saveSettings() {
            console.log('üíæ Saving settings...');
            
            // Settings are automatically saved when changed
            // This function can be used for additional validation or API calls
            
            showSettingsSaveSuccess();
            console.log('‚úÖ Settings saved successfully');
        }

        function resetSettings() {
            console.log('üîÑ Resetting settings to defaults...');
            
            if (confirm('Are you sure you want to reset all settings to default values? This will clear all your custom preferences.')) {
                // Clear all settings from localStorage
                const settingsKeys = [
                    'selectedAvatar', 'setting_theme', 'setting_fontSize', 'setting_colorScheme',
                    'setting_dailyQuizNotifications', 'setting_assessmentNotifications',
                    'setting_studyReminders', 'setting_emailNotifications',
                    'setting_profileVisibility', 'setting_leaderboardVisibility',
                    'setting_dataCollection', 'setting_autoLogout'
                ];
                
                settingsKeys.forEach(key => localStorage.removeItem(key));
                
                // Reload settings
                loadSettings();
                
                showSettingsResetMessage();
                console.log('‚úÖ Settings reset to defaults');
            }
        }

        function applyTheme(theme) {
            console.log('üé® Applying theme:', theme);
            
            // Remove existing theme classes
            document.body.classList.remove('theme-light', 'theme-dark');
            
            // Add new theme class
            if (theme === 'dark') {
                document.body.classList.add('theme-dark');
            } else {
                document.body.classList.add('theme-light');
            }
        }

        function applyFontSize(size) {
            console.log('üìù Applying font size:', size);
            
            // Remove existing font size classes
            document.body.classList.remove('text-sm', 'text-base', 'text-lg', 'text-xl');
            
            // Add new font size class
            const sizeMap = {
                'small': 'text-sm',
                'medium': 'text-base',
                'large': 'text-lg',
                'extra-large': 'text-xl'
            };
            
            if (sizeMap[size]) {
                document.body.classList.add(sizeMap[size]);
            }
        }

        function applyColorScheme(scheme) {
            console.log('üé® Applying color scheme:', scheme);
            
            // This would update CSS variables or classes for color schemes
            // For now, just log the change
        }

        function exportUserData() {
            console.log('üì§ Exporting user data...');
            
            // Create export data object
            const exportData = {
                user: currentUser,
                points: window.userPoints || {},
                profile: JSON.parse(localStorage.getItem('userProfile') || '{}'),
                subjects: JSON.parse(localStorage.getItem('userSubjects') || '[]'),
                settings: {
                    avatar: localStorage.getItem('selectedAvatar'),
                    theme: localStorage.getItem('setting_theme'),
                    fontSize: localStorage.getItem('setting_fontSize'),
                    colorScheme: localStorage.getItem('setting_colorScheme')
                },
                exportDate: new Date().toISOString()
            };
            
            // Create and download file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `tution-app-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            showExportSuccess();
            console.log('‚úÖ User data exported successfully');
        }

        function resetUserProgress() {
            console.log('üîÑ Resetting user progress...');
            
            if (confirm('Are you sure you want to reset all your progress? This will clear:\n\n‚Ä¢ All quiz points\n‚Ä¢ Assessment history\n‚Ä¢ Daily streak\n‚Ä¢ Question history\n\nThis action cannot be undone!')) {
                // Clear progress data
                localStorage.removeItem('userPoints');
                localStorage.removeItem('questionHistory');
                localStorage.removeItem('todayQuestion');
                localStorage.removeItem('lastQuestionDate');
                
                // Reset window variables
                window.userPoints = {
                    quizPoints: 0,
                    assessmentPoints: 0,
                    totalPoints: 0,
                    dailyStreak: 0,
                    lastQuizDate: null
                };
                
                // Update displays if on relevant sections
                const quizPointsElement = document.getElementById('quizPoints');
                const totalPointsElement = document.getElementById('totalPoints');
                const dailyStreakElement = document.getElementById('dailyStreak');
                
                if (quizPointsElement) quizPointsElement.textContent = '0';
                if (totalPointsElement) totalPointsElement.textContent = '0';
                if (dailyStreakElement) dailyStreakElement.textContent = '0';
                
                showProgressResetMessage();
                console.log('‚úÖ User progress reset successfully');
            }
        }

        function deleteUserAccount() {
            console.log('üóëÔ∏è Deleting user account...');
            
            if (confirm('‚ö†Ô∏è WARNING: This action is PERMANENT and cannot be undone!\n\nThis will delete:\n‚Ä¢ Your entire account\n‚Ä¢ All learning data\n‚Ä¢ All progress and points\n‚Ä¢ Profile information\n\nAre you absolutely sure you want to delete your account?')) {
                // Show final confirmation
                if (confirm('This is your final warning. Click OK to permanently delete your account.')) {
                    // Clear all data
                    localStorage.clear();
                    
                    // Redirect to login page
                    window.location.href = '/login.html';
                    
                    console.log('‚úÖ User account deleted successfully');
                }
            }
        }

        function showSettingsSaveSuccess() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">‚úÖ</span>
                    <span>Settings saved successfully!</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        function showSettingsResetMessage() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">üîÑ</span>
                    <span>Settings reset to defaults!</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        function showExportSuccess() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">üì§</span>
                    <span>Data exported successfully!</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        function showProgressResetMessage() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">üîÑ</span>
                    <span>Progress reset successfully!</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }



        // Initialize with dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });





                // Update points functions
        function updateQuizPoints(points) {
            userPoints.quizPoints += points;
            userPoints.totalPoints += points;
            updatePointsDisplay();
            localStorage.setItem('userPoints', JSON.stringify(userPoints));
        }

        function updateAssessmentPoints(points) {
            userPoints.assessmentPoints += points;
            userPoints.totalPoints += points;
            updatePointsDisplay();
            localStorage.setItem('userPoints', JSON.stringify(userPoints));
        }

        function updateDailyStreak() {
            const today = new Date().toDateString();
            if (userPoints.lastQuizDate !== today) {
                userPoints.dailyStreak += 1;
                userPoints.lastQuizDate = today;
                updatePointsDisplay();
                localStorage.setItem('userPoints', JSON.stringify(userPoints));
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('üöÄ Initializing Student Dashboard...');
            
            try {
                // Setup mobile sidebar toggle
                const mobileToggle = document.getElementById('mobileSidebarToggle');
                const sidebar = document.getElementById('sidebar');
                
                if (mobileToggle && sidebar) {
                    mobileToggle.addEventListener('click', function() {
                        sidebar.classList.toggle('-translate-x-full');
                    });
                }
                
                // Load user data first
                await loadUserData();
                
                // Initialize components
                initializeChat();
                initializeDailyQuiz();
                initializeAssessment();
                initializeStudyMaterials();
                initializeHomework();
                initializeProfile();
                initializeSettings();
                
                console.log('‚úÖ Dashboard initialized successfully');
                
                // Show welcome message only once and auto-start TTS
                setTimeout(() => {
                    showWelcomeMessage();
                    // Auto-start TTS for welcome message
                    const welcomeMessage = `Hello ${currentUser?.name || 'Student'}! Welcome to your personalized learning dashboard. I'm here to help you with your studies. How can I assist you today?`;
                    speakText(welcomeMessage, 'Roy Sir');
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
            }
        }

        // TTS (Text-to-Speech) functionality
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;

        function speakText(text, teacher = 'Roy Sir') {
            if (!speechSynthesis) {
                console.warn('‚ö†Ô∏è Speech synthesis not supported');
                return;
            }

            // Stop any current speech
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            // Create new utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // Set voice based on teacher
            if (teacher === 'Roy Sir') {
                // Try to find Microsoft Ravi English India Male voice
                const voices = speechSynthesis.getVoices();
                const raviVoice = voices.find(voice => 
                    voice.name.includes('Ravi') || 
                    voice.name.includes('Microsoft') ||
                    (voice.lang.includes('en') && voice.lang.includes('IN'))
                );
                
                if (raviVoice) {
                    currentUtterance.voice = raviVoice;
                    console.log('‚úÖ Using Roy Sir voice:', raviVoice.name);
                } else {
                    console.log('‚ö†Ô∏è Roy Sir voice not found, using default');
                }
            } else if (teacher === 'Miss Sapna') {
                // Try to find Google Hindi voice
                const voices = speechSynthesis.getVoices();
                const hindiVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.lang.includes('hi')
                );
                
                if (hindiVoice) {
                    currentUtterance.voice = hindiVoice;
                    console.log('‚úÖ Using Miss Sapna voice:', hindiVoice.name);
                } else {
                    console.log('‚ö†Ô∏è Miss Sapna voice not found, using default');
                }
            }

            // Set properties
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;

            // Event handlers
            currentUtterance.onstart = () => console.log('üîä TTS started');
            currentUtterance.onend = () => console.log('üîä TTS ended');
            currentUtterance.onerror = (event) => {
                console.error('‚ùå TTS error:', event);
                // Try to recover from TTS error
                if (event.error === 'not-allowed') {
                    console.warn('‚ö†Ô∏è TTS not allowed, trying alternative voice');
                    currentUtterance.voice = null; // Use default voice
                    speechSynthesis.speak(currentUtterance);
                }
            };

            // Speak
            speechSynthesis.speak(currentUtterance);
        }

        function stopSpeech() {
            if (speechSynthesis && currentUtterance) {
                speechSynthesis.cancel();
                currentUtterance = null;
                console.log('üîá Speech stopped');
            }
        }

        function playTTS() {
            // Replay the last AI message
            const lastMessage = document.querySelector('#chatMessages .justify-start:last-child');
            if (lastMessage) {
                const messageText = lastMessage.textContent;
                speakText(messageText, 'Roy Sir');
            } else {
                speakText('Hello! How can I help you today?', 'Roy Sir');
            }
        }

        function stopTTS() {
            stopSpeech();
        }

        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                message.type === 'user' 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-100 text-gray-800'
            }`;
            messageBubble.textContent = message.content;
            
            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom with smooth behavior
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
            
            // Auto-speak AI messages
            if (message.type === 'ai' && message.teacher) {
                speakText(message.content, message.teacher);
            }
        }

        function showWelcomeMessage() {
            const welcomeMessage = {
                type: 'ai',
                content: `Hello ${currentUser?.name || 'Student'}! Welcome to your personalized learning dashboard. I'm here to help you with your studies. How can I assist you today?`,
                teacher: 'Roy Sir',
                timestamp: new Date()
            };
            
            addMessageToChat(welcomeMessage);
        }

        // Mic (Speech-to-Text) functionality
        function startMic() {
            try {
                console.log('üé§ Starting microphone...');
                
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Speech recognition not supported in this browser.');
                    return;
                }
                
                // Initialize speech recognition
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                window.recognition = new SpeechRecognition();
                window.recognition.continuous = false;
                window.recognition.interimResults = false;
                window.recognition.lang = 'en-US';
                
                window.recognition.onstart = () => {
                    console.log('üé§ Microphone started');
                    // Update UI to show mic is active
                    const micButton = document.querySelector('[onclick="startMic()"]');
                    if (micButton) {
                        micButton.classList.add('bg-red-500');
                        micButton.classList.remove('bg-blue-100');
                    }
                };
                
                window.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('üé§ Speech recognized:', transcript);
                    
                    // Add to chat input
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) {
                        chatInput.value = transcript;
                    }
                    
                    // Stop mic
                    stopMic();
                };
                
                window.recognition.onerror = (event) => {
                    console.error('‚ùå Speech recognition error:', event.error);
                    stopMic();
                };
                
                window.recognition.onend = () => {
                    console.log('üé§ Microphone stopped');
                    stopMic();
                };
                
                window.recognition.start();
                
            } catch (error) {
                console.error('‚ùå Error starting microphone:', error);
                alert('Could not start microphone. Please check permissions.');
            }
        }
        
        function stopMic() {
            if (window.recognition) {
                window.recognition.stop();
                window.recognition = null;
            }
            
            // Update UI
            const micButton = document.querySelector('[onclick="startMic()"]');
            if (micButton) {
                micButton.classList.remove('bg-red-500');
                micButton.classList.add('bg-blue-100');
            }
            
            console.log('üîá Microphone stopped');
        }

        // Study Materials Functions
        function initializeStudyMaterials() {
            console.log('üìö Initializing Study Materials...');
            loadVideosFromSupabase();
        }

        async function loadVideosFromSupabase() {
            try {
                console.log('üé• Loading videos from Supabase...');
                
                // Get session data
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, showing placeholder');
                    showVideosPlaceholder();
                    return;
                }
                
                // Fetch videos from Supabase
                const response = await fetch('/api/videos', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });
                
                if (response.ok) {
                    const videos = await response.json();
                    displayVideos(videos);
                } else {
                    console.warn('‚ö†Ô∏è Failed to fetch videos, showing placeholder');
                    showVideosPlaceholder();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading videos:', error);
                showVideosPlaceholder();
            }
        }

        function displayVideos(videos) {
            const videosContainer = document.getElementById('videosContainer');
            if (!videosContainer) return;
            
            if (!videos || videos.length === 0) {
                videosContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üé•</div>
                        <p>No videos available yet.</p>
                        <p class="text-sm">Check back soon for educational content!</p>
                    </div>
                `;
                return;
            }
            
            videosContainer.innerHTML = videos.map(video => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-12 bg-red-500 rounded flex items-center justify-center text-white text-sm font-bold">
                                ‚ñ∂Ô∏è
                            </div>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-1">${video.title}</h4>
                            <p class="text-sm text-gray-600 mb-2">${video.subject} ‚Ä¢ ${video.class}</p>
                            <p class="text-sm text-gray-500 mb-3">${video.description || 'Educational video content'}</p>
                            <a href="${video.youtube_url}" target="_blank" class="inline-flex items-center px-3 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
                                <span class="mr-2">Watch on YouTube</span>
                                <span>‚Üó</span>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showVideosPlaceholder() {
            const videosContainer = document.getElementById('videosContainer');
            if (!videosContainer) return;
            
            videosContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üé•</div>
                    <p>Videos will be loaded from your learning database.</p>
                    <p class="text-sm">Please check back later or contact your teacher.</p>
                </div>
            `;
        }

        // Homework Functions
        function initializeHomework() {
            console.log('üìù Initializing Homework...');
            // Homework section is now just a placeholder for school registration
        }




            



        // Missing Functions

        function updatePointsDisplay() {
            console.log('üìä Updating points display...');
            
            const quizPointsElement = document.getElementById('quizPoints');
            const assessmentPointsElement = document.getElementById('assessmentPoints');
            const totalPointsElement = document.getElementById('totalPoints');
            const dailyStreakElement = document.getElementById('dailyStreak');
            
            if (quizPointsElement) quizPointsElement.textContent = userPoints?.quizPoints || 0;
            if (assessmentPointsElement) assessmentPointsElement.textContent = userPoints?.assessmentPoints || 0;
            if (totalPointsElement) totalPointsElement.textContent = userPoints?.totalPoints || 0;
            if (dailyStreakElement) dailyStreakElement.textContent = userPoints?.dailyStreak || 0;
            
            console.log('‚úÖ Points display updated');
        }

        function updateUserDisplay() {
            console.log('üë§ Updating user display...');
            
            const userName = document.getElementById('userName');
            const userClass = document.getElementById('userClass');
            const userAvatar = document.getElementById('userAvatar');
            const userName2 = document.getElementById('userName2');
            const userClass2 = document.getElementById('userClass2');
            const userAvatar2 = document.getElementById('userAvatar2');
            
            if (userName) userName.textContent = currentUser?.name || 'Student';
            if (userClass) userClass.textContent = `Class ${currentUser?.class || '2'}`;
            if (userAvatar) userAvatar.textContent = (currentUser?.name || 'S').charAt(0).toUpperCase();
            if (userName2) userName2.textContent = currentUser?.name || 'Student';
            if (userClass2) userClass2.textContent = `Class ${currentUser?.class || '2'}`;
            if (userAvatar2) userAvatar2.textContent = (currentUser?.name || 'S').charAt(0).toUpperCase();
            
            console.log('‚úÖ User display updated');
        }

        // Initialize with dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        // Assessment Functions
        function initializeAssessment() {
            console.log('üìã Initializing Assessment...');
            
            // Add event listeners for test creation buttons
            const createQuickTestBtn = document.getElementById('createQuickTest');
            const createCustomTestBtn = document.getElementById('createCustomTest');
            
            if (createQuickTestBtn) {
                createQuickTestBtn.addEventListener('click', createQuickTest);
            }
            
            if (createCustomTestBtn) {
                createCustomTestBtn.addEventListener('click', createCustomTest);
            }
            
            console.log('‚úÖ Assessment initialized');
        }

        async function createQuickTest() {
            try {
                console.log('üöÄ Creating quick test...');
                
                const subject = document.getElementById('quickTestSubject').value;
                const questions = parseInt(document.getElementById('quickTestQuestions').value);
                
                if (!subject) {
                    alert('Please select a subject for the quick test.');
                    return;
                }
                
                // Show loading state
                const button = document.getElementById('createQuickTest');
                const originalText = button.textContent;
                button.textContent = 'Generating...';
                button.disabled = true;
                
                // Generate test using AI based on syllabus
                const test = await generateAITest(subject, questions, 30);
                
                if (test) {
                    showTestPopup(test, 'Quick Test');
                }
                
            } catch (error) {
                console.error('‚ùå Error creating quick test:', error);
                alert('Failed to create quick test. Please try again.');
            } finally {
                // Restore button state
                const button = document.getElementById('createQuickTest');
                button.textContent = 'Create Test';
                button.disabled = false;
            }
        }

        async function createCustomTest() {
            try {
                console.log('üéØ Creating custom test...');
                
                const topic = document.getElementById('customTestTopic').value;
                const questions = parseInt(document.getElementById('customTestQuestions').value);
                
                if (!topic) {
                    alert('Please enter a topic for the custom test.');
                    return;
                }
                
                // Show loading state
                const button = document.getElementById('createCustomTest');
                const originalText = button.textContent;
                button.textContent = 'Generating...';
                button.disabled = true;
                
                // Generate test using AI based on topic and syllabus
                const test = await generateAITest(topic, questions, 45);
                
                if (test) {
                    showTestPopup(test, 'Custom Test');
                }
                
            } catch (error) {
                console.error('‚ùå Error creating custom test:', error);
                alert('Failed to create custom test. Please try again.');
            } finally {
                // Restore button state
                const button = document.getElementById('createCustomTest');
                button.textContent = 'Create Test';
                button.disabled = false;
            }
        }

        async function generateAITest(subject, numberOfQuestions, duration) {
            try {
                console.log('ü§ñ Generating AI test for:', subject, 'Questions:', numberOfQuestions);
                
                const response = await fetch('/api/ai/generate-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: subject,
                        classLevel: currentUser?.class || '2',
                        board: currentUser?.board || 'CBSE',
                        numberOfQuestions: numberOfQuestions,
                        duration: duration
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const testData = await response.json();
                console.log('‚úÖ AI test generated successfully:', testData);
                
                return {
                    subject: subject,
                    questions: testData.questions,
                    duration: duration,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('‚ùå Error generating AI test:', error);
                
                // Fallback to sample test if AI fails
                console.log('üîÑ Falling back to sample test...');
                return createSampleTest(subject, numberOfQuestions, duration);
            }
        }

        function createSampleTest(subject, numberOfQuestions, duration) {
            console.log('üìù Creating sample test for:', subject);
            
            // Create sample questions based on subject
            const questions = [];
            const subjects = {
                'Mathematics': [
                    'What is 2 + 3?',
                    'How many sides does a triangle have?',
                    'What comes after 9?',
                    'What is 5 - 2?',
                    'How many fingers do you have on one hand?'
                ],
                'Science': [
                    'What color is the sky?',
                    'What do plants need to grow?',
                    'What animal says "meow"?',
                    'What is the opposite of hot?',
                    'What do we use to see?'
                ],
                'English': [
                    'What letter comes after A?',
                    'How do you say "hello"?',
                    'What is the opposite of big?',
                    'What do we use to write?',
                    'How do you spell "cat"?'
                ],
                'Hindi': [
                    '‡§ï ‡§ï‡§æ ‡§â‡§ö‡•ç‡§ö‡§æ‡§∞‡§£ ‡§ï‡•à‡§∏‡•á ‡§π‡•ã‡§§‡§æ ‡§π‡•à?',
                    '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç "‡§®‡§Æ‡§∏‡•ç‡§§‡•á" ‡§ï‡§æ ‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à?',
                    '‡§ï‡§ø‡§§‡§®‡•á ‡§∏‡•ç‡§µ‡§∞ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç?',
                    '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç "‡§™‡§æ‡§®‡•Ä" ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?',
                    '‡§ï‡•å‡§® ‡§∏‡§æ ‡§¶‡§ø‡§® ‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§ï‡§æ ‡§™‡§π‡§≤‡§æ ‡§¶‡§ø‡§® ‡§π‡•à?'
                ]
            };
            
            const subjectQuestions = subjects[subject] || subjects['Mathematics'];
            
            for (let i = 0; i < Math.min(numberOfQuestions, subjectQuestions.length); i++) {
                questions.push({
                    question: subjectQuestions[i],
                    options: ['Option A', 'Option B', 'Option C', 'Option D'],
                    correctAnswer: Math.floor(Math.random() * 4),
                    explanation: 'This is a sample question for demonstration purposes.'
                });
            }
            
            return {
                subject: subject,
                questions: questions,
                duration: duration,
                timestamp: new Date().toISOString()
            };
        }

        function showTestPopup(test, testType) {
            console.log('üìã Showing test popup:', test);
            
            // Create test popup HTML
            const popupHTML = `
                <div id="testPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[90vh] overflow-y-auto w-full mx-4" style="scroll-behavior: smooth;">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">${testType}: ${test.subject}</h2>
                            <button onclick="closeTestPopup()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-lg font-bold text-blue-600">${test.questions.length}</div>
                                    <div class="text-sm text-blue-600">Questions</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-green-600">${test.duration}</div>
                                    <div class="text-sm text-green-600">Minutes</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-purple-600">5 + ${test.questions.length * 2}</div>
                                    <div class="text-sm text-purple-600">Max Points</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="testQuestions" class="space-y-6" style="max-height: 60vh; overflow-y: auto; scroll-behavior: smooth;">
                            ${test.questions.map((q, index) => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-800 mb-3">Question ${index + 1}: ${q.question}</h3>
                                    <div class="space-y-2">
                                        ${q.options.map((option, optIndex) => `
                                            <label class="flex items-center space-x-3 cursor-pointer">
                                                <input type="radio" name="q${index}" value="${optIndex}" class="text-blue-600">
                                                <span class="text-gray-700">${option}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                            <button onclick="closeTestPopup()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button onclick="submitTest()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                Submit Test
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add popup to body
            document.body.insertAdjacentHTML('beforeend', popupHTML);
        }

        function closeTestPopup() {
            const popup = document.getElementById('testPopup');
            if (popup) {
                popup.remove();
            }
        }

        function submitTest() {
            console.log('üìù Submitting test...');
            
            // Calculate score
            const questions = document.querySelectorAll('[id^="testQuestions"] > div');
            let correctAnswers = 0;
            let totalQuestions = questions.length;
            
            questions.forEach((question, index) => {
                const selectedAnswer = question.querySelector(`input[name="q${index}"]:checked`);
                if (selectedAnswer) {
                    const answerValue = parseInt(selectedAnswer.value);
                    // For sample questions, assume first option is correct
                    if (answerValue === 0) {
                        correctAnswers++;
                    }
                }
            });
            
            const score = Math.round((correctAnswers / totalQuestions) * 100);
            const pointsEarned = 5 + (correctAnswers * 2); // Base points + points per correct answer
            
            // Update user points
            updateAssessmentPoints(pointsEarned);
            
            // Show results
            showTestResults(score, pointsEarned, totalQuestions, correctAnswers);
            
            // Close test popup
            closeTestPopup();
        }

        function showTestResults(score, pointsEarned, totalQuestions, correctAnswers) {
            const resultsHTML = `
                <div id="testResults" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Test Results</h2>
                        
                        <div class="mb-6">
                            <div class="text-6xl mb-2">${score >= 80 ? 'üéâ' : score >= 60 ? 'üëç' : 'üìö'}</div>
                            <div class="text-3xl font-bold ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                ${score}%
                            </div>
                        </div>
                        
                        <div class="space-y-2 mb-6 text-gray-600">
                            <div>Correct Answers: ${correctAnswers}/${totalQuestions}</div>
                            <div>Points Earned: ${pointsEarned}</div>
                        </div>
                        
                        <button onclick="closeTestResults()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Continue
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', resultsHTML);
        }

        function closeTestResults() {
            const results = document.getElementById('testResults');
            if (results) {
                results.remove();
            }
        }

        // Daily Quiz Functions
        function initializeDailyQuiz() {
            console.log('üéØ Initializing Daily Quiz...');
            
            // Generate today's question
            generateDailyQuestion();
            
            // Load leaderboard
            generateLeaderboardData('global');
            
            console.log('‚úÖ Daily Quiz initialized');
        }

        async function generateDailyQuestion() {
            try {
                console.log('ü§ñ Generating daily question...');
                
                // Try to get AI-generated question first
                const response = await fetch('/api/ai/generate-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'Mathematics', // Default subject for daily quiz
                        classLevel: currentUser?.class || '2',
                        board: currentUser?.board || 'CBSE',
                        numberOfQuestions: 1,
                        duration: 5
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.questions && data.questions.length > 0) {
                        displayDailyQuestion(data.questions[0]);
                        return;
                    }
                }
                
                // Fallback to sample question
                console.log('üîÑ Using fallback question...');
                const fallbackQuestion = createDailyQuestion();
                displayDailyQuestion(fallbackQuestion);
                
            } catch (error) {
                console.error('‚ùå Error generating daily question:', error);
                const fallbackQuestion = createDailyQuestion();
                displayDailyQuestion(fallbackQuestion);
            }
        }

        function createDailyQuestion() {
            const questions = [
                {
                    question: 'What is 5 + 3?',
                    options: ['6', '7', '8', '9'],
                    correctAnswer: 2,
                    explanation: '5 + 3 = 8'
                },
                {
                    question: 'How many days are in a week?',
                    options: ['5', '6', '7', '8'],
                    correctAnswer: 2,
                    explanation: 'There are 7 days in a week'
                },
                {
                    question: 'What color is grass?',
                    options: ['Blue', 'Red', 'Green', 'Yellow'],
                    correctAnswer: 2,
                    explanation: 'Grass is typically green'
                }
            ];
            
            return questions[Math.floor(Math.random() * questions.length)];
        }

        function displayDailyQuestion(question) {
            const questionContent = document.getElementById('dailyQuestionContent');
            const questionOptions = document.getElementById('dailyQuestionOptions');
            
            if (questionContent && questionOptions) {
                questionContent.innerHTML = `<p class="text-lg">${question.question}</p>`;
                
                questionOptions.innerHTML = question.options.map((option, index) => `
                    <label class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <input type="radio" name="dailyAnswer" value="${index}" class="text-blue-600">
                        <span class="text-gray-700">${option}</span>
                    </label>
                `).join('');
            }
        }

        // Add event listener for daily quiz submission
        document.addEventListener('DOMContentLoaded', function() {
            const submitDailyAnswer = document.getElementById('submitDailyAnswer');
            if (submitDailyAnswer) {
                submitDailyAnswer.addEventListener('click', submitDailyAnswer);
            }
        });

        
        // Remove duplicate displayDailyQuestion function
        // The one above is the correct one
        
        // Test submission and points system
        async function submitTest() {
            try {
                console.log('üìù Submitting test...');
                
                const testPopup = document.getElementById('testPopup');
                if (!testPopup) {
                    console.error('‚ùå Test popup not found');
                    return;
                }
                
                // Get all questions and answers
                const questions = [];
                const radioGroups = testPopup.querySelectorAll('input[type="radio"]');
                let answeredCount = 0;
                
                // Group radio buttons by question
                const questionGroups = {};
                radioGroups.forEach(radio => {
                    const questionName = radio.name;
                    if (!questionGroups[questionName]) {
                        questionGroups[questionName] = [];
                    }
                    questionGroups[questionName].push(radio);
                });
                
                // Check if all questions are answered
                Object.keys(questionGroups).forEach(questionName => {
                    const selected = questionGroups[questionName].find(radio => radio.checked);
                    if (selected) {
                        answeredCount++;
                    }
                });
                
                if (answeredCount < Object.keys(questionGroups).length) {
                    alert('Please answer all questions before submitting.');
                    return;
                }
                
                // Calculate score and points
                const totalQuestions = Object.keys(questionGroups).length;
                const basePoints = 5; // Base points for taking test
                const pointsPerCorrect = 2; // Points per correct answer
                
                // For now, we'll assume all answers are correct (you can implement actual scoring logic)
                const correctAnswers = totalQuestions; // This should be calculated based on actual answers
                const totalPoints = basePoints + (correctAnswers * pointsPerCorrect);
                
                console.log(`üìä Test completed: ${correctAnswers}/${totalQuestions} correct, ${totalPoints} points earned`);
                
                // Update user points in Supabase
                await savePointsToSupabase(totalPoints, 'assessment');
                
                // Show results
                showTestResults(totalQuestions, correctAnswers, totalPoints);
                
                // Close test popup
                closeTestPopup();
                
                // Refresh leaderboard
                setTimeout(() => {
                    refreshLeaderboard();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error submitting test:', error);
                alert('Failed to submit test. Please try again.');
            }
        }
        
        // Show test results
        function showTestResults(totalQuestions, correctAnswers, pointsEarned) {
            const resultsHTML = `
                <div id="testResults" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Test Completed!</h2>
                        
                        <div class="space-y-4 mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Questions:</span>
                                <span class="font-semibold">${totalQuestions}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Correct:</span>
                                <span class="font-semibold text-green-600">${correctAnswers}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Score:</span>
                                <span class="font-semibold text-blue-600">${Math.round((correctAnswers/totalQuestions) * 100)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Points Earned:</span>
                                <span class="font-semibold text-purple-600">${pointsEarned}</span>
                            </div>
                        </div>
                        
                        <button onclick="closeTestResults()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            Continue
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', resultsHTML);
        }
        
        // Close test results
        function closeTestResults() {
            const results = document.getElementById('testResults');
            if (results) {
                results.remove();
            }
        }
        
        // Close test popup
        function closeTestPopup() {
            const popup = document.getElementById('testPopup');
            if (popup) {
                popup.remove();
            }
        }
        
        // Update user points (for daily quiz)
        async function updateUserPoints(points, isCorrect) {
            if (isCorrect) {
                console.log(`üéâ Daily quiz correct! Adding ${points} points`);
                
                // Save points to Supabase
                const success = await savePointsToSupabase(points, 'quiz');
                
                if (success) {
                    // Update local user data
                    currentUser.quizPoints = (currentUser.quizPoints || 0) + points;
                    currentUser.totalPoints = (currentUser.totalPoints || 0) + points;
                    
                    // Update profile display
                    updateProfileDisplay();
                    
                    // Refresh leaderboard
                    setTimeout(() => {
                        refreshLeaderboard();
                    }, 1000);
                }
            }
        }
        
        // Save points to Supabase
        async function savePointsToSupabase(points, type) {
            try {
                console.log(`üí∞ Saving ${points} points to Supabase (type: ${type})`);
                
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) {
                    console.warn('‚ö†Ô∏è No session found, cannot save points');
                    return false;
                }
                
                const response = await fetch('/api/points/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        points: points,
                        type: type
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Points saved successfully:', result);
                    
                    // Update local user data
                    if (type === 'quiz') {
                        currentUser.quizPoints = (currentUser.quizPoints || 0) + points;
                    } else if (type === 'assessment') {
                        currentUser.assessmentPoints = (currentUser.assessmentPoints || 0) + points;
                    }
                    
                    // Update total points
                    currentUser.totalPoints = (currentUser.totalPoints || 0) + points;
                    
                    // Update profile display
                    updateProfileDisplay();
                    
                    return true;
                } else {
                    console.error('‚ùå Failed to save points:', response.status);
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Error saving points:', error);
                return false;
            }
        }

        // Leaderboard refresh timer (every 5 minutes)
        function startLeaderboardRefreshTimer() {
            console.log('üîÑ Starting leaderboard refresh timer (every 5 minutes)');
            
            // Refresh immediately
            refreshLeaderboard();
            
            // Set interval for every 5 minutes
            setInterval(() => {
                console.log('üîÑ Auto-refreshing leaderboard...');
                refreshLeaderboard();
            }, 5 * 60 * 1000); // 5 minutes
        }
        
        // Refresh quiz data
        async function refreshQuizData() {
            try {
                console.log('üîÑ Refreshing quiz data...');
                
                // Update daily quiz if available
                const dailyQuestionContent = document.getElementById('dailyQuestionContent');
                if (dailyQuestionContent) {
                    const question = await generateDailyQuestion();
                    if (question) {
                        displayDailyQuestion(question);
                    }
                }
                
                // Refresh quiz leaderboard
                await refreshQuizLeaderboard();
                
            } catch (error) {
                console.error('‚ùå Error refreshing quiz data:', error);
            }
        }
        
        // Refresh assessment data
        async function refreshAssessmentData() {
            try {
                console.log('üîÑ Refreshing assessment data...');
                
                // Refresh assessment leaderboard
                await refreshAssessmentLeaderboard();
                
                // Update points display
                updateAssessmentPointsDisplay();
                
            } catch (error) {
                console.error('‚ùå Error refreshing assessment data:', error);
            }
        }
        
        // Refresh quiz leaderboard
        async function refreshQuizLeaderboard() {
            try {
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) return;
                
                const response = await fetch('/api/students/leaderboard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        type: 'quiz',
                        city: currentUser?.city
                    })
                });
                
                if (response.ok) {
                    const leaderboardData = await response.json();
                    console.log('üìä Quiz leaderboard refreshed:', leaderboardData);
                }
                
            } catch (error) {
                console.error('‚ùå Error refreshing quiz leaderboard:', error);
            }
        }
        
        // Refresh assessment leaderboard
        async function refreshAssessmentLeaderboard() {
            try {
                const session = JSON.parse(localStorage.getItem('session'));
                if (!session?.access_token) return;
                
                const response = await fetch('/api/students/leaderboard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        type: 'assessment',
                        city: currentUser?.city
                    })
                });
                
                if (response.ok) {
                    const leaderboardData = await response.json();
                    console.log('üìä Assessment leaderboard refreshed:', leaderboardData);
                }
                
            } catch (error) {
                console.error('‚ùå Error refreshing assessment leaderboard:', error);
            }
        }
        
        // Update assessment points display
        function updateAssessmentPointsDisplay() {
            try {
                // Update points summary in assessment section
                const totalPoints = (currentUser?.totalPoints || 0) + (currentUser?.assessmentPoints || 0);
                const testsTaken = currentUser?.testsTaken || 0;
                const averageScore = currentUser?.averageScore || 0;
                
                // Find and update the points summary section
                const pointsSummary = document.querySelector('#assessmentSection .bg-gradient-to-r');
                if (pointsSummary) {
                    const totalPointsEl = pointsSummary.querySelector('.text-2xl.font-bold');
                    if (totalPointsEl) {
                        totalPointsEl.textContent = totalPoints;
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error updating assessment points display:', error);
            }
        }
        
        // Display daily question
        function displayDailyQuestion(question) {
            try {
                const questionContent = document.getElementById('dailyQuestionContent');
                const questionOptions = document.getElementById('dailyQuestionOptions');
                
                if (questionContent && questionOptions) {
                    questionContent.innerHTML = `<p class="text-lg">${question.question}</p>`;
                    
                    questionOptions.innerHTML = question.options.map((option, index) => `
                        <label class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                            <input type="radio" name="dailyAnswer" value="${index}" class="text-blue-600">
                            <span class="text-gray-700">${option}</span>
                        </label>
                    `).join('');
                    
                    // Reset submit button
                    const submitBtn = document.getElementById('submitDailyAnswer');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Answer';
                    }
                }
            } catch (error) {
                console.error('‚ùå Error displaying daily question:', error);
            }
        }
        
        // Display daily question
        function displayDailyQuestion(question) {
            try {
                const questionContent = document.getElementById('dailyQuestionContent');
                const questionOptions = document.getElementById('dailyQuestionOptions');
                
                if (questionContent && questionOptions) {
                    questionContent.innerHTML = `<p class="text-lg">${question.question}</p>`;
                    
                    questionOptions.innerHTML = question.options.map((option, index) => `
                        <label class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                            <input type="radio" name="dailyAnswer" value="${index}" class="text-blue-600">
                            <span class="text-gray-700">${option}</span>
                        </label>
                    `).join('');
                    
                    // Reset submit button
                    const submitBtn = document.getElementById('submitDailyAnswer');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Answer';
                    }
                }
            } catch (error) {
                console.error('‚ùå Error displaying daily question:', error);
            }
        }
        
        // Update profile form with current user data
        function updateProfileForm() {
            try {
                if (!currentUser) return;
                
                // Update form fields
                const formFields = {
                    'profileFullName': currentUser.name || '',
                    'profileDOB': currentUser.dob || '',
                    'profileGender': currentUser.gender || '',
                    'profileCity': currentUser.city || '',
                    'profileEmail': currentUser.email || '',
                    'profilePhone': currentUser.phone || '',
                    'profileClass': currentUser.class || '',
                    'profileBoard': currentUser.board || '',
                    'profileSchool': currentUser.school || '',
                    'profileRollNo': currentUser.rollNo || ''
                };
                
                Object.keys(formFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        if (field.type === 'select-one') {
                            field.value = formFields[fieldId];
                        } else {
                            field.value = formFields[fieldId];
                        }
                    }
                });
                
                console.log('‚úÖ Profile form updated with current data');
                
            } catch (error) {
                console.error('‚ùå Error updating profile form:', error);
            }
        }
        
        // Refresh leaderboard data
        async function refreshLeaderboard() {
            try {
                console.log('üîÑ Refreshing leaderboard data...');
                
                // Refresh quiz leaderboard
                if (typeof refreshQuizData === 'function') {
                    refreshQuizData();
                }
                
                // Refresh assessment leaderboard
                if (typeof refreshAssessmentData === 'function') {
                    refreshAssessmentData();
                }
                
                // Refresh profile data
                if (typeof refreshProfileData === 'function') {
                    refreshProfileData();
                }
                
                console.log('‚úÖ Leaderboard refreshed successfully');
                
            } catch (error) {
                console.error('‚ùå Error refreshing leaderboard:', error);
            }
        }
        
        // Start the leaderboard refresh timer when dashboard initializes
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                startLeaderboardRefreshTimer();
            }, 2000); // Start after 2 seconds to ensure dashboard is loaded
        });
        
        // Refresh profile data
        async function refreshProfileData() {
            try {
                console.log('üîÑ Refreshing profile data...');
                
                // Reload user data from Supabase
                await loadUserDataFromSupabase();
                
                // Update profile display
                updateProfileDisplay();
                
                // Update profile form fields
                updateProfileForm();
                
                console.log('‚úÖ Profile data refreshed successfully');
                
            } catch (error) {
                console.error('‚ùå Error refreshing profile data:', error);
            }
        }
        
        // Update profile form with current user data
        function updateProfileForm() {
            try {
                if (!currentUser) return;
                
                // Update form fields
                const formFields = {
                    'profileFullName': currentUser.name || '',
                    'profileDOB': currentUser.dob || '',
                    'profileGender': currentUser.gender || '',
                    'profileCity': currentUser.city || '',
                    'profileEmail': currentUser.email || '',
                    'profilePhone': currentUser.phone || '',
                    'profileClass': currentUser.class || '',
                    'profileBoard': currentUser.board || '',
                    'profileSchool': currentUser.school || '',
                    'profileRollNo': currentUser.rollNo || ''
                };
                
                Object.keys(formFields).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        if (field.type === 'select-one') {
                            field.value = formFields[fieldId];
                        } else {
                            field.value = formFields[fieldId];
                        }
                    }
                });
                
                console.log('‚úÖ Profile form updated with current data');
                
            } catch (error) {
                console.error('‚ùå Error updating profile form:', error);
            }
        }
        
        // Teacher Personality Functions
        let currentTeacher = 'roy_sir'; // Default teacher
        
        // Teacher personalities and characteristics
        const teacherPersonalities = {
            roy_sir: {
                name: 'Roy Sir',
                image: 'images/roy_sir.jpg',
                personality: 'Professional, structured, and focused on problem-solving. He explains concepts with data-driven approaches and emphasizes science and technology.',
                teachingStyle: 'English & Advanced Topics',
                greeting: 'Hello! I\'m Roy Sir, your mathematics and science expert. I\'m here to help you understand complex concepts through structured problem-solving approaches.',
                color: 'blue',
                specialties: ['Mathematics', 'Science', 'Technology', 'Problem Solving']
            },
            miss_sapna: {
                name: 'Miss Sapna',
                image: 'images/miss_sapna.jpg',
                personality: 'Warm, encouraging, and creative. She uses story-based learning and makes lessons interactive and culturally relevant.',
                teachingStyle: 'Hindi, English & Hinglish',
                greeting: 'Namaste! I\'m Miss Sapna, your language and arts specialist. I love making learning fun through stories and creative activities!',
                color: 'pink',
                specialties: ['Languages', 'Arts', 'Creative Writing', 'Cultural Studies']
            }
        };
        
        // Select teacher function
        function selectTeacher(teacherId) {
            console.log(`üé≠ Selecting teacher: ${teacherId}`);
            
            // Update current teacher
            currentTeacher = teacherId;
            const teacher = teacherPersonalities[teacherId];
            
            // Update avatar in chat header
            const avatarImg = document.getElementById('welcomeTeacherAvatar');
            const avatarName = document.getElementById('avatarName');
            
            if (avatarImg && avatarName) {
                avatarImg.src = teacher.image;
                avatarName.textContent = teacher.name;
            }
            
            // Update current selection display
            const currentTeacherName = document.getElementById('currentTeacherName');
            if (currentTeacherName) {
                currentTeacherName.textContent = teacher.name;
            }
            
            // Update avatar selection visual feedback
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('border-blue-500', 'border-pink-500', 'bg-blue-50', 'bg-pink-50');
                option.classList.add('border-gray-200');
            });
            
            const selectedOption = document.querySelector(`[data-avatar="${teacherId}"]`);
            if (selectedOption) {
                selectedOption.classList.remove('border-gray-200');
                selectedOption.classList.add(`border-${teacher.color}-500`, `bg-${teacher.color}-50`);
            }
            
            // Save selection to localStorage
            localStorage.setItem('selectedTeacher', teacherId);
            
            // Show teacher change notification
            showTeacherChangeNotification(teacher);
            
            console.log(`‚úÖ Teacher changed to: ${teacher.name}`);
        }
        
        // Show teacher change notification
        function showTeacherChangeNotification(teacher) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 bg-${teacher.color}-100 border border-${teacher.color}-300 text-${teacher.color}-800 px-6 py-4 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${teacher.image}" alt="${teacher.name}" class="w-8 h-8 rounded-full">
                    <div>
                        <div class="font-semibold">Teacher Changed!</div>
                        <div class="text-sm">Now learning with ${teacher.name}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Get teacher personality for AI responses
        function getTeacherPersonality() {
            return teacherPersonalities[currentTeacher];
        }
        
        // Enhanced AI response with teacher personality
        function sendMessageWithPersonality(message) {
            const teacher = getTeacherPersonality();
            
            // Add teacher personality context to the message
            const personalityContext = `You are ${teacher.name}, ${teacher.personality}. Respond in character as this teacher. ${teacher.greeting}`;
            
            // Send the message with personality context
            sendMessage(message, personalityContext);
        }
        
        // Load saved teacher selection on page load
        function loadSavedTeacher() {
            const savedTeacher = localStorage.getItem('selectedTeacher');
            if (savedTeacher && teacherPersonalities[savedTeacher]) {
                selectTeacher(savedTeacher);
            } else {
                // Default to Roy Sir
                selectTeacher('roy_sir');
            }
        }
        
        // Initialize teacher selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTeacher();
        });
        
        // TTS Functions with Teacher Voice
        function playTTS() {
            const teacher = getTeacherPersonality();
            const lastMessage = document.querySelector('#chatMessages .message:last-child .message-content');
            
            if (lastMessage) {
                const text = lastMessage.textContent;
                
                // Use different voice settings based on teacher
                const voiceSettings = {
                    roy_sir: { 
                        rate: 0.9, 
                        pitch: 1.0, 
                        volume: 1.0,
                        voiceName: 'Microsoft Ravi - English (India)'
                    },
                    miss_sapna: { 
                        rate: 1.0, 
                        pitch: 1.1, 
                        volume: 1.0,
                        voiceName: 'Google ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä'
                    }
                };
                
                const settings = voiceSettings[currentTeacher] || voiceSettings.roy_sir;
                
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = settings.rate;
                    utterance.pitch = settings.pitch;
                    utterance.volume = settings.volume;
                    
                    // Set specific voice for each teacher
                    const voices = speechSynthesis.getVoices();
                    const targetVoice = voices.find(voice => voice.name === settings.voiceName);
                    
                    if (targetVoice) {
                        utterance.voice = targetVoice;
                        console.log(`üîä Using ${settings.voiceName} for ${teacher.name}`);
                    } else {
                        console.log(`‚ö†Ô∏è Voice ${settings.voiceName} not found, using default`);
                    }
                    
                    speechSynthesis.speak(utterance);
                    console.log(`üîä Playing TTS with ${teacher.name}'s voice: ${settings.voiceName}`);
                }
            }
        }
        
        function stopTTS() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                console.log('üîá TTS stopped');
            }
        }
    </script>
</body>
</html>
