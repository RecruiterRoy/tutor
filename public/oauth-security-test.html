<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Security Test - tution.app</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-middleware.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full">
        <h1 class="text-2xl font-bold text-center mb-6">OAuth Security Test</h1>
        
        <div class="space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h2 class="font-semibold text-blue-800 mb-2">Security Features:</h2>
                <ul class="list-disc list-inside text-blue-700 space-y-1">
                    <li>✅ Only Google OAuth and verified email users allowed</li>
                    <li>✅ Complete profile required (all fields filled)</li>
                    <li>✅ Email verification required for email users</li>
                    <li>✅ No bypassing of OAuth process</li>
                    <li>✅ Automatic redirects based on authentication status</li>
                </ul>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="testAuthentication()" class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700">
                    Test Authentication
                </button>
                <button onclick="testOAuthVerification()" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700">
                    Test OAuth Verification
                </button>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="testLoginBypass()" class="flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700">
                    Test Login Bypass
                </button>
                <button onclick="testDashboardAccess()" class="flex-1 bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700">
                    Test Dashboard Access
                </button>
            </div>
            
            <div id="status" class="p-4 rounded-lg bg-gray-50">
                Ready to test OAuth security...
            </div>
            
            <div id="logs" class="p-4 bg-gray-100 rounded-lg max-h-64 overflow-y-auto">
                <div class="text-sm font-mono">
                    <div>Waiting for tests...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `text-sm font-mono ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-800'}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `p-4 rounded-lg ${
                type === 'error' ? 'bg-red-50 text-red-800' : 
                type === 'success' ? 'bg-green-50 text-green-800' : 
                'bg-blue-50 text-blue-800'
            }`;
        }
        
        async function testAuthentication() {
            try {
                log('Testing authentication check...');
                updateStatus('Testing authentication...', 'info');
                
                const authResult = await AuthMiddleware.checkAuthentication();
                
                if (authResult.isAuthenticated) {
                    log(`✅ Authentication passed for: ${authResult.user.email}`, 'success');
                    log(`Provider: ${authResult.provider}`, 'success');
                    updateStatus('Authentication test passed', 'success');
                } else {
                    log(`❌ Authentication failed: ${authResult.reason}`, 'error');
                    updateStatus('Authentication test failed', 'error');
                }
                
            } catch (error) {
                log(`❌ Authentication test error: ${error.message}`, 'error');
                updateStatus('Authentication test error', 'error');
            }
        }
        
        async function testOAuthVerification() {
            try {
                log('Testing OAuth verification...');
                updateStatus('Testing OAuth verification...', 'info');
                
                const { data: { session } } = await AuthMiddleware.supabase.auth.getSession();
                
                if (!session) {
                    log('❌ No session found for OAuth verification test', 'error');
                    updateStatus('No session for OAuth test', 'error');
                    return;
                }
                
                const oauthResult = await AuthMiddleware.verifyOAuthCompletion(session.user);
                
                if (oauthResult.isValid) {
                    log(`✅ OAuth verification passed for provider: ${oauthResult.provider}`, 'success');
                    updateStatus('OAuth verification test passed', 'success');
                } else {
                    log(`❌ OAuth verification failed: ${oauthResult.reason}`, 'error');
                    if (oauthResult.missingFields) {
                        log(`Missing fields: ${oauthResult.missingFields.join(', ')}`, 'error');
                    }
                    updateStatus('OAuth verification test failed', 'error');
                }
                
            } catch (error) {
                log(`❌ OAuth verification test error: ${error.message}`, 'error');
                updateStatus('OAuth verification test error', 'error');
            }
        }
        
        async function testLoginBypass() {
            try {
                log('Testing login bypass prevention...');
                updateStatus('Testing login bypass prevention...', 'info');
                
                // Simulate a user trying to access dashboard without proper OAuth
                const authResult = await AuthMiddleware.checkAuthentication();
                
                if (!authResult.isAuthenticated) {
                    log('✅ Login bypass prevented - user redirected appropriately', 'success');
                    log(`Reason: ${authResult.reason}`, 'success');
                    updateStatus('Login bypass prevention working', 'success');
                } else {
                    log('❌ Login bypass possible - user authenticated without proper OAuth', 'error');
                    updateStatus('Login bypass prevention failed', 'error');
                }
                
            } catch (error) {
                log(`❌ Login bypass test error: ${error.message}`, 'error');
                updateStatus('Login bypass test error', 'error');
            }
        }
        
        async function testDashboardAccess() {
            try {
                log('Testing dashboard access control...');
                updateStatus('Testing dashboard access control...', 'info');
                
                const authResult = await AuthMiddleware.checkAuthentication();
                const currentPage = 'dashboard';
                
                const shouldAllow = AuthMiddleware.handleAuthenticationRedirect(authResult, currentPage);
                
                if (shouldAllow) {
                    log('✅ Dashboard access allowed - user properly authenticated', 'success');
                    updateStatus('Dashboard access control working', 'success');
                } else {
                    log('✅ Dashboard access denied - user redirected appropriately', 'success');
                    log(`Reason: ${authResult.reason}`, 'success');
                    updateStatus('Dashboard access control working', 'success');
                }
                
            } catch (error) {
                log(`❌ Dashboard access test error: ${error.message}`, 'error');
                updateStatus('Dashboard access test error', 'error');
            }
        }
        
        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('OAuth Security Test Page Loaded');
            updateStatus('Ready to test OAuth security features');
        });
    </script>
</body>
</html>
