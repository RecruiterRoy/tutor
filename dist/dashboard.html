<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TUTOR.AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/public/js/config.js"></script>
    <script src="/public/js/auth.js"></script>
    <script src="/public/js/enhancedAIService.js"></script>
    <script src="/public/js/imageSearch.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .gradient-border {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2px;
            border-radius: 16px;
        }
        
        .gradient-border-content {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 14px;
            padding: 1.5rem;
        }
        
        .chat-container {
            height: 60vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd1, #6a4299);
        }
        
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-left: auto;
            max-width: 85%;
            animation: slideInRight 0.3s ease-out;
        }
        
        .message-ai {
            background: rgba(255, 255, 255, 0.15);
            margin-right: auto;
            max-width: 85%;
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            margin-right: auto;
            max-width: 100px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        .nav-item {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(4px);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 2px;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .voice-recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1s infinite;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        /* Markdown Content Styles */
        .prose {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: white;
            line-height: 1.6;
        }
        .prose p {
            margin-bottom: 1em;
        }
        .prose ul, .prose ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        .prose img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        .prose code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 0.3em;
            font-family: monospace;
        }
        .prose pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin: 1em 0;
        }
        .prose blockquote {
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 1em;
            margin-left: 0;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
            margin: 1em 0;
        }
        .prose h1, .prose h2, .prose h3, .prose h4 {
            margin: 1em 0 0.5em 0;
            font-weight: 600;
        }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.3em; }
        .prose h3 { font-size: 1.1em; }
        
        /* Enhanced AI Features */
        .knowledge-bank-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            animation: slideInLeft 0.3s ease-out;
        }
        
        .kb-info-content h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .kb-info-content p {
            margin: 4px 0;
            font-size: 13px;
        }
        
        .weekly-reminder,
        .monthly-test-reminder {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
        }
        
        .reminder-content h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .reminder-content h4 {
            margin: 15px 0 8px 0;
            font-size: 14px;
        }
        
        .reminder-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .reminder-content li {
            margin: 4px 0;
            font-size: 13px;
        }
        
        .reminder-content button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            margin: 10px 5px 0 0;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .reminder-content button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Mermaid Diagram Styles */
        .mermaid-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
            min-height: 100px;
            position: relative;
        }

        .mermaid-loading {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .mermaid-error {
            color: #f87171;
            padding: 0.5rem;
        }

        .mermaid-error.hidden {
            display: none;
        }

        .mermaid svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            background: transparent !important;
        }

        .mermaid .label {
            color: white !important;
            font-family: 'Inter', sans-serif;
        }
        
        /* Avatar Animation Styles */
        .talking-animation {
            animation: talking 0.8s infinite alternate ease-in-out;
        }

        .blinking-animation {
            animation: blink 4s infinite ease-in-out;
        }

        @keyframes talking {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }

        @keyframes blink {
            0%, 96%, 100% { transform: scaleY(1); }
            98% { transform: scaleY(0.1); }
        }

        .avatar-eyes {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            top: 30%;
        }

        .avatar-mouth {
            position: absolute;
            width: 20px;
            height: 8px;
            background: #ff6b6b;
            border-radius: 0 0 10px 10px;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.2s ease;
        }

        .talking .avatar-mouth {
            animation: mouthTalk 0.3s infinite alternate;
        }

        @keyframes mouthTalk {
            0% { height: 8px; border-radius: 0 0 10px 10px; }
            100% { height: 4px; border-radius: 10px; }
        }

        /* Avatar Container */
        .avatar-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin-right: 15px;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            object-fit: cover;
            position: relative;
        }

        .avatar-eyes-container {
            position: absolute;
            width: 100%;
            top: 30%;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .avatar-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-top: 10px;
            text-align: center;
        }

        /* Settings Page Avatar Styles */
        .avatar-selection-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .avatar-selection-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .avatar-selection-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .avatar-container-settings {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            position: relative;
        }

        .avatar-image-settings {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            border: 3px solid rgba(255,255,255,0.3);
            object-fit: cover;
        }

        /* Media Controls */
        .media-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .media-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 6px 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .media-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .media-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Chat Avatar Styles */
        .avatar-container-chat {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .avatar-image-chat {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            object-fit: cover;
        }

        /* Chat Avatar Animation Elements */
        .avatar-eyes-container-chat {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .avatar-eyes-chat {
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 25%;
            animation: blink-chat 4s infinite ease-in-out;
            display: none; /* Hide the white dots */
        }

        .avatar-eyes-chat:first-child {
            left: 25%;
        }

        .avatar-eyes-chat:last-child {
            right: 25%;
        }

        .avatar-mouth-chat {
            position: absolute;
            width: 16px;
            height: 6px;
            background: #ff6b6b;
            border-radius: 0 0 8px 8px;
            top: 55%;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.2s ease;
            display: none; /* Hide the mouth dot */
        }

        .talking-chat .avatar-mouth-chat {
            animation: mouthTalk-chat 0.3s infinite alternate;
        }

        @keyframes blink-chat {
            0%, 96%, 100% { transform: scaleY(1); }
            98% { transform: scaleY(0.1); }
        }

        @keyframes mouthTalk-chat {
            0% { height: 6px; border-radius: 0 0 8px 8px; }
            100% { height: 3px; border-radius: 8px; }
        }

        /* Chat Media Controls */
        .media-controls-chat {
            display: flex;
            gap: 6px;
        }

        .media-btn-chat {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 10px;
        }

        .media-btn-chat:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .media-btn-chat:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 50vh;
            }
            .message-user, .message-ai {
                max-width: 90%;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-20 md:w-56 bg-slate-800/90 flex flex-col items-center py-6 space-y-4">
            <button class="nav-item active w-full py-3 px-2 text-white text-left font-semibold rounded-lg mb-2" onclick="showSection('dashboard')" id="navDashboard">🏠 <span class="hidden md:inline">Dashboard</span></button>
            <button class="nav-item w-full py-3 px-2 text-white text-left font-semibold rounded-lg mb-2" onclick="showSection('progress')" id="navProgress">📈 <span class="hidden md:inline">Progress</span></button>
            <button class="nav-item w-full py-3 px-2 text-white text-left font-semibold rounded-lg mb-2" onclick="showSection('settings')" id="navSettings">⚙️ <span class="hidden md:inline">Settings</span></button>
        </div>
        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-y-auto">
            <!-- Top Bar -->
            <div class="bg-slate-800/90 backdrop-blur-lg border-b border-white/10 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <span class="text-white font-bold text-lg">T</span>
                        </div>
                        <h1 class="text-white text-2xl font-bold">TUTOR.AI</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-white text-sm font-medium" id="topBarUserName">Loading...</p>
                            <p class="text-gray-400 text-xs" id="topBarUserClass">Loading...</p>
                        </div>
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span id="topBarInitials" class="text-white font-bold text-sm">L</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Section Content -->
            <div class="flex-1 flex flex-col overflow-y-auto">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section-content flex-1 flex flex-col p-4 md:p-6 overflow-y-auto">
                    <!-- Chat Section -->
                    <div id="chatSection">
                        <div class="max-w-6xl mx-auto">
                            <div class="glass-effect rounded-2xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center space-x-4">
                                        <div class="avatar-container-chat">
                                            <img id="teacher-avatar-chat" class="avatar-image-chat" 
                                                 src="/public/images/teacher-avatar2.png" alt="Teacher Avatar">
                                            <div class="avatar-eyes-container-chat">
                                                <div class="avatar-eyes-chat"></div>
                                                <div class="avatar-eyes-chat"></div>
                                            </div>
                                            <div class="avatar-mouth-chat"></div>
                                        </div>
                                        <div>
                                            <h2 id="teacher-name-chat" class="text-xl font-bold text-white">Roy Sir</h2>
                                            <p class="text-gray-300 text-sm">Ask me anything about your studies!</p>
                                            <div class="media-controls-chat mt-2">
                                                <button class="media-btn-chat" onclick="playCurrentAnswer()">▶️</button>
                                                <button class="media-btn-chat" onclick="pauseCurrentAnswer()">⏸️</button>
                                                <button class="media-btn-chat" onclick="resumeCurrentAnswer()">⏯️</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 bg-green-500 rounded-full pulse-animation"></div>
                                        <span class="text-green-400 text-sm font-medium">AI Online</span>
                                    </div>
                                </div>

                                <!-- Chat Container -->
                                <div class="gradient-border mb-6">
                                    <div class="gradient-border-content">
                                        <div id="chatMessages" class="chat-container space-y-4 mb-4">
                                            <!-- Messages will be inserted here -->
                                        </div>
                                        <!-- Chat Input -->
                                        <div class="flex space-x-3">
                                            <input 
                                                type="text" 
                                                id="chatInput" 
                                                placeholder="Type your question here..." 
                                                class="flex-1 px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                onkeypress="handleChatKeyPress(event)"
                                            >
                                            <button id="voiceButton" class="px-4 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-xl hover:from-green-600 hover:to-blue-600 transition-all duration-300 font-semibold relative" title="Voice Input">
                                                <span id="voiceIcon">🎤</span>
                                                <span id="voiceStatus" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full opacity-0 transition-opacity duration-300"></span>
                                            </button>
                                            <button id="sendButton" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-300 font-semibold">
                                                Send
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <button onclick="sendQuickMessage('Help me with Math problems', 'Math')" class="glass-effect p-4 rounded-2xl text-center hover:bg-white/20 transition-all duration-300 group">
                                        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">🔢</div>
                                        <p class="text-white font-medium text-sm">Math Help</p>
                                    </button>
                                    <button onclick="sendQuickMessage('Explain this Science concept', 'Science')" class="glass-effect p-4 rounded-2xl text-center hover:bg-white/20 transition-all duration-300 group">
                                        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">🧪</div>
                                        <p class="text-white font-medium text-sm">Science</p>
                                    </button>
                                    <button onclick="sendQuickMessage('Help with English grammar', 'English')" class="glass-effect p-4 rounded-2xl text-center hover:bg-white/20 transition-all duration-300 group">
                                        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">📝</div>
                                        <p class="text-white font-medium text-sm">English</p>
                                    </button>
                                    <button onclick="sendQuickMessage('Create a study plan for me')" class="glass-effect p-4 rounded-2xl text-center hover:bg-white/20 transition-all duration-300 group">
                                        <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">📅</div>
                                        <p class="text-white font-medium text-sm">Study Plan</p>
                                    </button>
                                </div>

                                <!-- Study Materials Panel -->
                                <div class="glass-effect rounded-2xl p-4 mt-4">
                                    <h3 class="text-white font-bold mb-2">Study Materials</h3>
                                    <div id="bookList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-64 overflow-y-auto">
                                        <!-- Books will be loaded here -->
                                        <p class="text-gray-400 col-span-full">Loading books for your class...</p>
                                    </div>
                                </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div id="progressSection" class="section-content flex-1 flex-col p-4 md:p-6 hidden overflow-y-auto">
                    <div class="max-w-6xl mx-auto">
                        <div class="glass-effect rounded-2xl p-6">
                            <h2 class="text-2xl font-bold text-white mb-4">Learning Progress</h2>
                            <div class="mb-4 flex items-center space-x-4">
                                <label class="text-white text-sm">Final Exam in:</label>
                                <select id="examMonth" class="bg-purple-700 text-white rounded px-2 py-1">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4" selected>April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                                <select id="examYear" class="bg-purple-700 text-white rounded px-2 py-1"></select>
                            </div>
                            <div class="mb-2 text-white text-sm" id="monthsTillExam">Months till final exam: </div>
                            <div class="mb-4 text-white text-sm" id="progressTillDate">Progress made till date: 0%</div>
                            <div class="mb-4">
                                <label class="text-white text-sm">Subjects:</label>
                                <div id="subjectsList" class="flex flex-col space-y-2 mt-2"></div>
                                <button id="addSubjectBtn" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">Add Subject</button>
                            </div>
                            <div id="learning-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="section-content flex-1 flex-col p-4 md:p-6 hidden overflow-y-auto">
                    <div class="max-w-2xl mx-auto">
                        <div class="glass-effect rounded-2xl p-6">
                            <h2 class="text-2xl font-bold text-white mb-4">Settings</h2>
                            
                            <!-- Teacher Avatars -->
                            <div class="mb-6">
                                <label class="text-white text-sm font-medium mb-3 block">Choose Your Teacher:</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="avatar-selection-card" data-teacher="english">
                                        <div class="avatar-container-settings">
                                            <img class="avatar-image-settings" src="/public/images/teacher-avatar2.png" alt="Roy Sir">
                                        </div>
                                        <h3 class="text-white text-center mt-2 font-medium">Roy Sir</h3>
                                        <div class="media-controls mt-2">
                                            <button class="media-btn" id="playBtn-english" onclick="playCurrentAnswer()">▶️</button>
                                            <button class="media-btn" id="pauseBtn-english" onclick="pauseCurrentAnswer()">⏸️</button>
                                            <button class="media-btn" id="resumeBtn-english" onclick="resumeCurrentAnswer()">⏯️</button>
                                        </div>
                                    </div>
                                    <div class="avatar-selection-card" data-teacher="hindi">
                                        <div class="avatar-container-settings">
                                            <img class="avatar-image-settings" src="/public/images/teacher-avatar1.png" alt="Ms. Sapana">
                                        </div>
                                        <h3 class="text-white text-center mt-2 font-medium">Ms. Sapana</h3>
                                        <div class="media-controls mt-2">
                                            <button class="media-btn" id="playBtn-hindi" onclick="playCurrentAnswer()">▶️</button>
                                            <button class="media-btn" id="pauseBtn-hindi" onclick="pauseCurrentAnswer()">⏸️</button>
                                            <button class="media-btn" id="resumeBtn-hindi" onclick="resumeCurrentAnswer()">⏯️</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Language Selection -->
                            <div class="mb-4">
                                <label for="preferredLanguage" class="text-white text-sm">Preferred Language:</label>
                                <select id="preferredLanguage" class="bg-purple-700 text-white rounded px-2 py-1">
                                    <option value="en" selected>English</option>
                                    <option value="hi">हिंदी (Hindi)</option>
                                    <option value="hi-en">Hinglish</option>
                                </select>
                            </div>

                            <!-- Voice Settings -->
                            <div class="mb-4 flex items-center space-x-2">
                                <label for="voiceSelect" class="text-white text-sm">Voice:</label>
                                <select id="voiceSelect" class="bg-purple-700 text-white rounded px-2 py-1"></select>
                            </div>
                            <div class="mb-4">
                                <label class="text-white text-sm">Voice Settings:</label>
                                <div class="flex flex-col space-y-2 mt-2">
                                    <div class="flex items-center gap-2">
                                        <label class="text-white text-sm">Speed:</label>
                                        <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1.0" class="w-32">
                                        <span id="rateValue" class="text-white text-sm">1.0x</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label class="text-white text-sm">Pitch:</label>
                                        <input type="range" id="voicePitch" min="0.5" max="2" step="0.1" value="1.0" class="w-32">
                                        <span id="pitchValue" class="text-white text-sm">1.0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Learning Style -->
                            <div class="mb-4">
                                <label for="learningStyle" class="text-white text-sm">Learning Style:</label>
                                <select id="learningStyle" class="bg-purple-700 text-white rounded px-2 py-1">
                                    <option value="visual">Visual</option>
                                    <option value="auditory">Auditory</option>
                                    <option value="reading">Reading/Writing</option>
                                    <option value="kinesthetic">Kinesthetic</option>
                                </select>
                            </div>

                            <!-- Accessibility -->
                            <div class="mb-4">
                                <label class="text-white text-sm">Accessibility:</label>
                                <div class="flex flex-col space-y-2 mt-2">
                                    <label class="flex items-center gap-2 text-white text-sm">
                                        <input type="checkbox" id="dyslexicFont" class="rounded text-blue-500"> Dyslexia-friendly font
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm">
                                        <input type="checkbox" id="highContrast" class="rounded text-blue-500"> High contrast mode
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm">
                                        <input type="checkbox" id="screenReader" class="rounded text-blue-500"> Screen reader support
                                    </label>
                                </div>
                            </div>

                            <!-- STT Test -->
                            <div class="mb-4">
                                <label class="text-white text-sm">Voice Input Test:</label>
                                <div class="flex flex-col space-y-2 mt-2">
                                    <button onclick="testMicrophone()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                        Test Microphone
                                    </button>
                                    <button onclick="testMicButton()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                                        Test Mic Button
                                    </button>
                                </div>
                            </div>

                            <!-- Account Management -->
                            <div class="mb-4">
                                <label class="text-white text-sm font-medium">Account Management:</label>
                                <div class="flex flex-col space-y-2 mt-2">
                                    <button onclick="signOut()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                                        🚪 Sign Out
                                    </button>
                                    <button onclick="showUserProfile()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                                        👤 View Profile
                                    </button>
                                    <button onclick="openFeedbackModal()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                                        💬 Send Feedback
                                    </button>
                                </div>
                                <p class="text-gray-400 text-xs mt-2">Tell us if you face any issue or have something to say to us</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CORE FUNCTIONS ==========
        
        // Initialize Mermaid before any other scripts
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            flowchart: { 
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose',
            fontFamily: '"Inter", sans-serif'
        });

        // ========== GLOBAL VARIABLES ==========
        const supabaseConfig = window.appConfig || {};
        const supabaseUrl = supabaseConfig.supabaseUrl || 'https://your-project-ref.supabase.co';
        const supabaseKey = supabaseConfig.supabaseAnonKey || 'your-anon-key-here';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let userData = null;
        let chatHistory = [];
        let isRecording = false;
        let recognition = null;
        let recognitionTimeout;
        let speechSynthesis = window.speechSynthesis;
        let currentSpeech = null;
        let currentText = '';
        let pausedPosition = 0;
        let isPlaying = false;
        let autoPlayEnabled = true;

        // ========== UI FUNCTIONS ==========
        
        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `<div class='typing-dot'></div><div class='typing-dot'></div><div class='typing-dot'></div>`;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv && typingDiv.parentNode) {
                typingDiv.parentNode.removeChild(typingDiv);
            }
        }

        function showError(message, duration = 5000) {
            const existing = document.querySelector('.error-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 glass-effect p-4 rounded-xl text-red-400 font-medium flex items-center space-x-2 z-50 error-toast';
            toast.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showSuccess(message, duration = 3000) {
            const existing = document.querySelector('.success-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 glass-effect p-4 rounded-xl text-green-400 font-medium flex items-center space-x-2 z-50 success-toast';
            toast.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showSTTFeedback(message, type = 'info') {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.id = 'sttFeedback';
            feedbackDiv.className = `fixed top-4 right-4 glass-effect p-3 rounded-xl text-sm font-medium z-50 ${
                type === 'success' ? 'text-green-400' : 
                type === 'error' ? 'text-red-400' : 
                'text-blue-400'
            }`;
            feedbackDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : '🎤'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            const existing = document.getElementById('sttFeedback');
            if (existing) existing.remove();
            
            document.body.appendChild(feedbackDiv);
            
            setTimeout(() => {
                if (feedbackDiv.parentNode) {
                    feedbackDiv.remove();
                }
            }, 3000);
        }

        // ========== CHAT FUNCTIONS ==========

        function sendQuickMessage(message, subject = null) {
            if (subject) gptService.setContext(null, subject);
            document.getElementById('chatInput').value = message;
            handleSendMessage();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSendMessage();
            }
            // Shift+Enter will naturally create a line break in the textarea
        }

        async function addMessage(role, content, subject = null, grade = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-${role} p-4 rounded-2xl mb-4`;
            
            // Use plain text only - no markdown processing
            let plainText = content
                .replace(/```[\s\S]*?```/g, '') // Remove code blocks
                .replace(/`([^`]+)`/g, '$1') // Remove inline code
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
                .replace(/\*(.*?)\*/g, '$1') // Remove italic
                .replace(/#{1,6}\s/g, '') // Remove headers
                .replace(/\n{3,}/g, '\n\n') // Remove extra line breaks
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Remove links, keep text
                .replace(/!\[([^\]]*)\]\([^)]+\)/g, '') // Remove images
                .trim();
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="w-10 h-10 ${role === 'user' ? 'bg-gradient-to-r from-blue-500 to-purple-600' : 'bg-gradient-to-r from-green-500 to-blue-600'} rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-bold text-sm">${role === 'user' ? 'You' : 'AI'}</span>
                    </div>
                    <div class="flex-1 overflow-x-auto">
                        <div class="text-white message-content whitespace-pre-wrap">${plainText}</div>
                        <p class="text-gray-400 text-xs mt-2">Just now</p>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Auto-play TTS for AI responses
            if (role === 'ai' && autoPlayEnabled) {
                setTimeout(() => {
                    currentText = cleanTextForTTS(plainText);
                    pausedPosition = 0;
                    playFromPosition();
                }, 500);
            }
        }

        async function handleSendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            sendButton.disabled = true;
            
            try {
                showTypingIndicator();
                
                // Get user profile data to send to API
                const userProfileData = userData || {
                    full_name: currentUser?.user_metadata?.full_name || 'Student',
                    class: userData?.class || 'Class 6',
                    board: userData?.board || 'CBSE',
                    subject: gptService.currentSubject || 'General'
                };
                
                let aiResponse = await gptService.sendMessage(message, userProfileData);
                
                // Remove ALL name-related questions and references
                const firstName = (userData?.full_name || currentUser?.user_metadata?.full_name || 'Student').split(' ')[0];
                
                if(currentTeacher === teachers.hindi) {
                    // Remove Hindi name questions and references
                    aiResponse = aiResponse.replace(/नाम.*?जान.*?सकती?/gi, ''); // Remove "naam jaan sakti/sakta"
                    aiResponse = aiResponse.replace(/आपका नाम.*?बताने.*?के बाद/gi, ''); // Remove "aapka naam batane ke baad"
                    aiResponse = aiResponse.replace(/आपसे personally बात.*?चाहती?/gi, ''); // Remove "personally baat chahungi/chahunga"
                    aiResponse = aiResponse.replace(/क्या आप.*?समझ गए\?/gi, ''); // Remove "do you understand?"
                    aiResponse = aiResponse.replace(/आपका नाम क्या है\?/gi, ''); // Remove "what is your name?"
                    aiResponse = aiResponse.replace(/मैं.*?आपका नाम.*?जानना.*?चाहती?/gi, ''); // Remove "I want to know your name"
                    aiResponse = aiResponse.replace(/Homework देने से पहले.*?नाम.*?जान.*?सकती?/gi, ''); // Remove homework name questions
                    aiResponse = aiResponse.replace(/Aapka naam batane ke baad.*?homework.*?doongi/gi, ''); // Remove homework name references
                } else {
                    // Remove English name questions and references
                    aiResponse = aiResponse.replace(/what.*?your.*?name/gi, ''); // Remove "what is your name"
                    aiResponse = aiResponse.replace(/can.*?know.*?your.*?name/gi, ''); // Remove "can I know your name"
                    aiResponse = aiResponse.replace(/before.*?giving.*?homework.*?name/gi, ''); // Remove homework name questions
                    aiResponse = aiResponse.replace(/after.*?telling.*?name.*?homework/gi, ''); // Remove homework name references
                    aiResponse = aiResponse.replace(/personally.*?talk.*?you/gi, ''); // Remove "personally talk to you"
                    aiResponse = aiResponse.replace(/Remember:.*$/g, ''); // Remove health tips from main response
                }
                
                // Clean up extra whitespace and punctuation
                aiResponse = aiResponse.replace(/\s+/g, ' ').trim();
                aiResponse = aiResponse.replace(/^\s*[,\s]+\s*/, ''); // Remove leading commas and spaces
                aiResponse = aiResponse.replace(/\s*[,\s]+\s*$/, ''); // Remove trailing commas and spaces
                
                removeTypingIndicator();
                
                const userClass = userData?.grade ? `class${userData.grade}` : 'class6';
                const currentSubject = gptService.currentSubject || 'English';
                
                await addMessage('ai', aiResponse, currentSubject, userData?.grade || 6);
            } catch (err) {
                removeTypingIndicator();
                console.error('Chat error:', err);
                
                let errorMessage = 'Sorry, I encountered an error. Please try again.';
                if (err.message.includes('API request failed')) {
                    errorMessage = 'Connection error. Please check your internet connection and try again.';
                } else if (err.message.includes('Invalid response format')) {
                    errorMessage = 'Service temporarily unavailable. Please try again in a moment.';
                } else if (err.message.includes('timeout')) {
                    errorMessage = 'Request timed out. Please try again.';
                }
                
                addMessage('ai', errorMessage, 'General', userData?.grade || 6);
            } finally {
                sendButton.disabled = false;
            }
        }

        // ========== SPEECH FUNCTIONS ==========

        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn('Speech recognition not supported');
                    document.getElementById('voiceButton').style.display = 'none';
                    return;
                }

                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 3;
                recognition.lang = document.getElementById('preferredLanguage')?.value || 'en-US';
                
                if (recognition.grammars && window.SpeechGrammarList) {
                    try {
                        const grammar = new SpeechGrammarList();
                        grammar.addFromString('#JSGF V1.0; grammar commands; public <command> = help | explain | what is | how to | tell me about;', 1);
                        recognition.grammars = grammar;
                    } catch (grammarError) {
                        console.log('Grammar not supported, continuing without it:', grammarError);
                    }
                }

                recognition.onstart = () => {
                    console.log('Speech recognition started');
                    isRecording = true;
                    document.getElementById('voiceIcon').textContent = '🔴';
                    document.getElementById('voiceButton').classList.add('voice-recording');
                    document.getElementById('voiceStatus').style.opacity = '1';
                    showSTTFeedback("Listening... Speak now!", 'info');
                    
                    recognitionTimeout = setTimeout(() => {
                        if (isRecording) {
                            recognition.stop();
                        }
                    }, 10000);
                };

                recognition.onresult = (event) => {
                    if (recognitionTimeout) {
                        clearTimeout(recognitionTimeout);
                    }
                    
                    let interimTranscript = '';
                    let finalTranscript = '';
                    let highestConfidence = 0;
                    let bestTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;
                        const confidence = result[0].confidence || 0;
                        
                        if (result.isFinal) {
                            finalTranscript += transcript;
                            if (confidence > highestConfidence) {
                                highestConfidence = confidence;
                                bestTranscript = transcript;
                            }
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const chatInput = document.getElementById('chatInput');
                    
                    if (finalTranscript) {
                        const finalText = bestTranscript || finalTranscript;
                        
                        if (highestConfidence > 0.6) {
                            chatInput.value = finalText;
                            console.log('Final transcript:', finalText, 'Confidence:', highestConfidence);
                            showSTTFeedback("Voice input received - processing...", 'success');
                            
                            setTimeout(() => {
                                handleSendMessage();
                            }, 500);
                            
                            setTimeout(() => {
                                if (isRecording) {
                                    restartRecognition();
                                }
                            }, 1000);
                        } else {
                            console.log('Low confidence result:', highestConfidence);
                            showSTTFeedback("Couldn't understand clearly. Please try again.", 'error');
                            setTimeout(() => {
                                if (isRecording) {
                                    restartRecognition();
                                }
                            }, 500);
                        }
                    } else if (interimTranscript) {
                        chatInput.value = interimTranscript;
                        console.log('Interim transcript:', interimTranscript);
                        chatInput.style.borderColor = '#10b981';
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    
                    if (recognitionTimeout) {
                        clearTimeout(recognitionTimeout);
                    }
                    
                    switch(event.error) {
                        case 'no-speech':
                            console.log('No speech detected');
                            setTimeout(() => {
                                if (isRecording) {
                                    restartRecognition();
                                }
                            }, 500);
                            return;
                            
                        case 'audio-capture':
                            showSTTFeedback('No microphone found. Please check your audio settings.', 'error');
                            stopRecording();
                            break;
                            
                        case 'not-allowed':
                            showSTTFeedback('Microphone access denied. Please allow microphone access in your browser settings.', 'error');
                            stopRecording();
                            break;
                            
                        case 'network':
                            showSTTFeedback('Network error. Please check your internet connection.', 'error');
                            setTimeout(() => {
                                if (isRecording) {
                                    restartRecognition();
                                }
                            }, 1000);
                            break;
                            
                        default:
                            console.log('Recognition error:', event.error);
                            setTimeout(() => {
                                if (isRecording) {
                                    restartRecognition();
                                }
                            }, 1000);
                    }
                };

                recognition.onend = () => {
                    if (recognitionTimeout) {
                        clearTimeout(recognitionTimeout);
                    }
                    stopRecording();
                    const chatInput = document.getElementById('chatInput');
                    chatInput.style.borderColor = '';
                };

            } catch (error) {
                console.error('Failed to initialize speech recognition:', error);
                showSTTFeedback('Voice input may not work properly in this browser', 'error');
            }
        }

        function restartRecognition() {
            try {
                if (recognition && isRecording) {
                    recognition.start();
                }
            } catch (e) {
                console.log('Recognition restart failed:', e);
                setTimeout(() => {
                    if (isRecording) {
                        try {
                            recognition.start();
                        } catch (e2) {
                            console.log('Recognition restart failed again:', e2);
                        }
                    }
                }, 1000);
            }
        }

        function startRecording() {
            if (!recognition) {
                showSTTFeedback('Voice input not available', 'error');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 44100
                }
            })
            .then(() => {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    showSTTFeedback('Failed to start voice input', 'error');
                }
            })
            .catch(error => {
                console.error('Microphone permission denied:', error);
                showSTTFeedback('Microphone access is required for voice input', 'error');
            });
        }

        function stopRecording() {
            isRecording = false;
            if (recognitionTimeout) {
                clearTimeout(recognitionTimeout);
            }
            document.getElementById('voiceIcon').textContent = '🎤';
            document.getElementById('voiceButton').classList.remove('voice-recording');
            document.getElementById('voiceStatus').style.opacity = '0';
        }

        async function toggleVoiceRecording() {
            console.log('🎤 Voice button clicked!');
            
            if (isRecording) {
                console.log('Stopping voice recording...');
                isRecording = false;
                if (recognition) {
                    recognition.stop();
                }
                stopRecording();
                showSuccess("Voice recording stopped");
                return;
            }

            try {
                console.log('Starting voice recording...');
                if (!recognition) {
                    initSpeechRecognition();
                }
                
                startRecording();
                
            } catch (error) {
                console.error('Microphone error:', error);
                if (error.name === 'NotAllowedError') {
                    showSTTFeedback('Microphone access denied. Please allow microphone access in your browser settings.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showSTTFeedback('No microphone found. Please check your audio settings.', 'error');
                } else {
                    showSTTFeedback('Could not access microphone. Please check permissions.', 'error');
                }
            }
        }

        // ========== TTS FUNCTIONS ==========

        function playCurrentAnswer() {
            console.log('Play button clicked');
            const lastAIMessage = document.querySelector('.message-ai:last-child .message-content');
            if (lastAIMessage) {
                currentText = lastAIMessage.textContent || lastAIMessage.innerText;
                pausedPosition = 0;
                playFromPosition();
            } else {
                showError('No message to play');
            }
        }

        function pauseCurrentAnswer() {
            console.log('Pause button clicked');
            if (currentSpeech) {
                speechSynthesis.pause();
                isPlaying = false;
                autoPlayEnabled = false;
                const elapsed = currentSpeech.elapsedTime || 0;
                pausedPosition = Math.floor(elapsed * 10);
            }
        }

        function resumeCurrentAnswer() {
            console.log('Resume button clicked');
            if (speechSynthesis.paused) {
                speechSynthesis.resume();
                isPlaying = true;
            } else if (currentText && pausedPosition > 0) {
                playFromPosition();
            } else {
                showError('Nothing to resume');
            }
        }

        function cleanTextForTTS(text) {
            // Text is already cleaned, just ensure it's ready for TTS
            return text
                .replace(/\n{3,}/g, '\n\n') // Remove extra line breaks
                .replace(/\s+/g, ' ') // Normalize spaces
                .trim();
        }

        function playFromPosition() {
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            const textToPlay = cleanTextForTTS(currentText.substring(pausedPosition));
            if (!textToPlay.trim()) return;
            
            currentSpeech = new SpeechSynthesisUtterance(textToPlay);
            
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === document.getElementById('voiceSelect').value);
            if (selectedVoice) {
                currentSpeech.voice = selectedVoice;
            }
            
            currentSpeech.rate = parseFloat(document.getElementById('voiceRate').value) || 1.0;
            currentSpeech.pitch = parseFloat(document.getElementById('voicePitch').value) || 1.0;
            
            currentSpeech.onstart = () => {
                isPlaying = true;
                autoPlayEnabled = true;
                const avatarImgChat = document.getElementById('teacher-avatar-chat');
                const mouthChat = document.querySelector('.avatar-mouth-chat');
                if (avatarImgChat) {
                    avatarImgChat.classList.add('talking-animation');
                }
                if (mouthChat) {
                    mouthChat.classList.add('talking-chat');
                }
            };
            
            currentSpeech.onend = () => {
                isPlaying = false;
                pausedPosition = 0;
                const avatarImgChat = document.getElementById('teacher-avatar-chat');
                const mouthChat = document.querySelector('.avatar-mouth-chat');
                if (avatarImgChat) {
                    avatarImgChat.classList.remove('talking-animation');
                }
                if (mouthChat) {
                    mouthChat.classList.remove('talking-chat');
                }
            };
            
            speechSynthesis.speak(currentSpeech);
        }

        // Extract topic from content for image search
        function extractTopicFromContent(content) {
            // Simple topic extraction without image dependencies
            const words = content.toLowerCase().split(' ');
            const topics = ['math', 'science', 'english', 'history', 'geography', 'physics', 'chemistry', 'biology'];
            for (const topic of topics) {
                if (words.includes(topic)) return topic;
            }
            return 'general';
        }

        // Populate voice options with only specific voices
        function populateVoices() {
            const voiceSelect = document.getElementById('voiceSelect');
            if (!voiceSelect) return;
            
            const voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '';
            
            // Define our preferred voices
            const preferredVoices = {
                english: 'Microsoft Ravi - English (India)',
                hindi: 'Google हिन्दी'
            };
            
            // Find and add only our preferred voices
            voices.forEach((voice) => {
                if (voice.name === preferredVoices.english || voice.name === preferredVoices.hindi) {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = voice.name;
                    option.setAttribute('data-language', voice.name === preferredVoices.english ? 'en' : 'hi');
                    voiceSelect.appendChild(option);
                }
            });
            
            // Set default voice based on current teacher
            if (currentTeacher === teachers.hindi) {
                const hindiVoice = voiceSelect.querySelector('[data-language="hi"]');
                if (hindiVoice) hindiVoice.selected = true;
            } else {
                const englishVoice = voiceSelect.querySelector('[data-language="en"]');
                if (englishVoice) englishVoice.selected = true;
            }
            
            console.log('✅ Voices populated with preferred voices only');
        }

        // Update teacher based on language
        function updateTeacher(language) {
            if (language === 'hi' || language === 'hi-en') {
                currentTeacher = teachers.hindi;
            } else {
                currentTeacher = teachers.english;
            }
            
            // Update UI elements
            const teacherNameChat = document.getElementById('teacher-name-chat');
            const teacherAvatarChat = document.getElementById('teacher-avatar-chat');
            
            if (teacherNameChat) {
                teacherNameChat.textContent = currentTeacher.name;
            }
            
            if (teacherAvatarChat) {
                teacherAvatarChat.src = currentTeacher.image;
            }
            
            // Auto-update voice selection based on teacher
            const voiceSelect = document.getElementById('voiceSelect');
            if (voiceSelect) {
                if (currentTeacher === teachers.hindi) {
                    const hindiVoice = voiceSelect.querySelector('[data-language="hi"]');
                    if (hindiVoice) {
                        hindiVoice.selected = true;
                        console.log('✅ Voice changed to Hindi: Google हिन्दी');
                    }
                } else {
                    const englishVoice = voiceSelect.querySelector('[data-language="en"]');
                    if (englishVoice) {
                        englishVoice.selected = true;
                        console.log('✅ Voice changed to English: Microsoft Ravi');
                    }
                }
            }
            
            console.log('✅ Teacher updated to:', currentTeacher.name);
        }

        // ========== TEACHER FUNCTIONS ==========

        const teachers = {
            hindi: {
                name: "Ms. Sapana",
                image: "/public/images/teacher-avatar1.png",
                description: "Empathetic and encouraging Hindi teacher",
                style: "gentle",
                behaviors: {
                    intro: "नमस्ते! मैं आपकी हिंदी शिक्षिका सपना हूं। आज हम साथ में सीखेंगे।",
                    outro: "बहुत अच्छा! आपने अच्छी तरह से सीखा।",
                    storyFrequency: 3600000,
                    maxStoriesPerDay: 3,
                    storiesToday: 0,
                    lastStoryDate: null
                }
            },
            english: {
                name: "Roy Sir",
                image: "/public/images/teacher-avatar2.png",
                description: "Clear and structured English teacher",
                style: "direct",
                behaviors: {
                    intro: "Hello! I'm your English teacher Roy Sir. Let's learn together.",
                    outro: "Excellent work! Keep up the good learning.",
                    healthTipFrequency: 3600000,
                    maxHealthTipsPerDay: 5,
                    healthTipsToday: 0,
                    lastHealthTipDate: null
                }
            }
        };

        let currentTeacher = teachers.english;
        let lastStoryTime = 0;
        let lastHealthTipTime = 0;

        function getPanchatantraStory() {
            const stories = [
                "एक छोटी सी कहानी: बुद्धिमानी हमेशा ताकत से बेहतर होती है।",
                "याद रखो: धैर्य और मेहनत से हर मुश्किल आसान हो जाती है।",
                "एक सीख: दूसरों की मदद करने से हमें भी मदद मिलती है।"
            ];
            return stories[Math.floor(Math.random() * stories.length)];
        }

        function getHealthTip() {
            const tips = [
                "Remember to take a short break and stretch every hour.",
                "Don't forget to drink water while studying.",
                "Good posture helps you focus better.",
                "Take deep breaths to stay relaxed while learning.",
                "A short walk can refresh your mind."
            ];
            return tips[Math.floor(Math.random() * tips.length)];
        }

        // --- Enhanced GPT Service ---
        class GPTService {
            constructor() {
                this.currentGrade = null;
                this.currentSubject = null;
                this.chatHistory = [];
                // Use production API URL for deployed app
                this.baseUrl = (window.getApiBaseUrl ? window.getApiBaseUrl() : 'https://tutor-tq4v.vercel.app') + '/api/chat';
            }
            
            setContext(grade, subject) {
                if (grade) this.currentGrade = grade;
                if (subject) this.currentSubject = subject;
            }
            
            async sendMessage(userMessage, userProfileData) {
                try {
                    this.chatHistory.push({ role: 'user', content: userMessage });
                    
                    const requestBody = {
                        messages: this.chatHistory,
                        grade: this.currentGrade || 'Class 2',
                        subject: this.currentSubject || 'General',
                        response_format: 'markdown',
                        language: document.getElementById('preferredLanguage')?.value || 'en',
                        user_profile: userProfileData
                    };

                    console.log('Sending request to:', this.baseUrl);
                    console.log('Request body:', requestBody);

                    const response = await fetch(this.baseUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.response) {
                        console.error('Invalid response format:', data);
                        throw new Error('Invalid response format from API');
                    }
                    
                    this.chatHistory.push({ role: 'assistant', content: data.response });
                    return data.response;
                    
                } catch (error) {
                    console.error('API Request Error:', error);
                    
                    // Use fallback response when API is not available
                    const fallbackResponse = getFallbackResponse(userMessage);
                    this.chatHistory.push({ role: 'assistant', content: fallbackResponse });
                    
                    return fallbackResponse;
                }
            }
        }
        
        const gptService = new GPTService();

        // --- Enhanced AI Service Integration ---
        // EnhancedAIService is loaded from external file /public/js/enhancedAIService.js
        // No need to redeclare it here

        // Functions are already defined in CHAT FUNCTIONS section above

        // ========== USER MANAGEMENT ==========

        async function loadUserProfile() {
            try {
                console.log('🔄 Loading user profile for:', currentUser.id);
                
                // First try to get user profile from the user_profiles table
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (profileError) {
                    console.log('Profile table error, trying RPC:', profileError);
                    
                    // Fallback to RPC function
                    const { data, error } = await supabaseClient
                        .rpc('get_user_profile', { user_id: currentUser.id });

                    if (error) {
                        console.log('RPC error, trying auth metadata:', error);
                        throw error;
                    }

                    if (data && data.length > 0) {
                        const profile = data[0];
                        updateUserInterface({
                            full_name: profile.full_name,
                            class: profile.class,
                            board: profile.board,
                            board_abbr: profile.board_abbr,
                            phone: profile.phone,
                            city: profile.city,
                            state: profile.state,
                            preferred_language: profile.preferred_language,
                            email: currentUser.email
                        });
                        return;
                    } else {
                        throw new Error('No profile found in RPC');
                    }
                }

                if (profileData) {
                    console.log('✅ User profile loaded:', profileData);
                    updateUserInterface({
                        full_name: profileData.full_name,
                        class: profileData.class,
                        board: profileData.board,
                        board_abbr: profileData.board_abbr,
                        phone: profileData.phone,
                        city: profileData.city,
                        state: profileData.state,
                        preferred_language: profileData.preferred_language,
                        email: currentUser.email
                    });
                } else {
                    throw new Error('No profile data found');
                }
            } catch (error) {
                console.error('❌ Error loading user profile:', error);
                
                // Try to get from user metadata
                const metadata = currentUser.user_metadata || {};
                const fallbackData = {
                    full_name: metadata.full_name || 'Student',
                    class: metadata.class || 'Class 2',
                    board: 'Central Board of Secondary Education',
                    board_abbr: 'CBSE',
                    email: currentUser.email
                };
                
                console.log('⚠️ Using fallback data:', fallbackData);
                updateUserInterface(fallbackData);
            }
        }

        function updateUserInterface(userDataParam) {
            userData = userDataParam;
            
            const name = userData.full_name || 'Student';
            const className = userData.class || 'Class 2';
            const initials = name.charAt(0).toUpperCase();

            document.getElementById('topBarUserName').textContent = name;
            document.getElementById('topBarUserClass').textContent = className;
            document.getElementById('topBarInitials').textContent = initials;
            
            gptService.setContext(className, null);
            
            loadClassBooks();
        }

        // Sign out function
        async function signOut() {
            try {
                if (window.TutorAuth) {
                    await window.TutorAuth.signOut();
                } else if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
                
                // Clear local storage
                localStorage.clear();
                
                // Redirect to index page instead of login to prevent auto sign-in
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Sign out error:', error);
                // Force redirect anyway
                window.location.href = '/index.html';
            }
        }

        function showUserProfile() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-white text-lg font-bold mb-4">👤 User Profile</h3>
                    <div class="space-y-3 text-white">
                        <div>
                            <strong>Name:</strong> ${userData?.full_name || currentUser?.user_metadata?.full_name || 'Not set'}
                        </div>
                        <div>
                            <strong>Email:</strong> ${currentUser?.email || 'Not set'}
                        </div>
                        <div>
                            <strong>Class:</strong> ${userData?.class || 'Not set'}
                        </div>
                        <div>
                            <strong>Board:</strong> ${userData?.board || 'Not set'}
                        </div>
                        <div>
                            <strong>Member Since:</strong> ${new Date(currentUser?.created_at || Date.now()).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">
                            Close
                        </button>
                        <button onclick="signOut()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors">
                            Sign Out
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // --- Feedback Modal Function ---
        function openFeedbackModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-white text-lg font-bold mb-4">💬 Send Feedback</h3>
                    <p class="text-gray-300 text-sm mb-4">Tell us if you face any issue or have something to say to us</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-white text-sm font-medium">Subject:</label>
                            <input type="text" id="feedbackSubject" placeholder="Brief subject of your message" 
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white mt-1 focus:outline-none focus:border-purple-500">
                        </div>
                        
                        <div>
                            <label class="text-white text-sm font-medium">Message:</label>
                            <textarea id="feedbackMessage" rows="5" placeholder="Write your message here..." 
                                      class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white mt-1 focus:outline-none focus:border-purple-500 resize-none"></textarea>
                        </div>
                        
                        <div>
                            <label class="text-white text-sm font-medium">Category:</label>
                            <select id="feedbackCategory" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white mt-1 focus:outline-none focus:border-purple-400">
                                <option value="general">General</option>
                                <option value="feedback">Feedback</option>
                                <option value="books">Books</option>
                                <option value="technical">Technical Issue</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">
                            Cancel
                        </button>
                        <button onclick="submitFeedback()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                            Send Feedback
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Handle avatar selection change
        function handleAvatarSelection(teacher) {
            console.log('🔄 Switching to teacher:', teacher);
            
            // Update selection UI
            document.querySelectorAll('.avatar-selection-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`.avatar-selection-card[data-teacher="${teacher}"]`).classList.add('selected');
            
            // Update teacher
            const language = teacher === 'english' ? 'en' : 'hi';
            updateTeacher(language);
            
            // Update language dropdown
            const langSelect = document.getElementById('preferredLanguage');
            if (langSelect) {
                langSelect.value = language;
            }
            
            // Auto-update voice selection
            const voiceSelect = document.getElementById('voiceSelect');
            if (voiceSelect) {
                if (teacher === 'hindi') {
                    const hindiVoice = voiceSelect.querySelector('[data-language="hi"]');
                    if (hindiVoice) {
                        hindiVoice.selected = true;
                        console.log('✅ Voice auto-changed to Hindi: Google हिन्दी');
                    }
                } else {
                    const englishVoice = voiceSelect.querySelector('[data-language="en"]');
                    if (englishVoice) {
                        englishVoice.selected = true;
                        console.log('✅ Voice auto-changed to English: Microsoft Ravi');
                    }
                }
            }
            
            console.log('✅ Avatar selection updated successfully');
        }

        // Submit Feedback Function
        async function submitFeedback() {
            const subject = document.getElementById('feedbackSubject').value.trim();
            const message = document.getElementById('feedbackMessage').value.trim();
            const category = document.getElementById('feedbackCategory').value;

            if (!subject || !message) {
                showError('Please fill in both subject and message');
                return;
            }

            try {
                // Get current user
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    showError('Please log in to send feedback');
                    return;
                }

                // Insert feedback into database
                const { error } = await supabaseClient
                    .from('user_feedback')
                    .insert({
                        user_id: user.id,
                        subject: subject,
                        message: message,
                        category: category,
                        status: 'unread'
                    });

                if (error) {
                    console.error('Feedback submission error:', error);
                    showError('Failed to send feedback. Please try again.');
                    return;
                }

                // Close modal and show success
                document.querySelector('.fixed').remove();
                showSuccess('Feedback sent successfully! We will review it soon.');

            } catch (error) {
                console.error('Feedback submission error:', error);
                showError('Failed to send feedback. Please try again.');
            }
        }

        // --- Study Materials Functions ---
        async function loadClassBooks() {
            try {
                const bookList = document.getElementById('bookList');
                bookList.innerHTML = '<p class="text-gray-400 col-span-full">Loading books for your class...</p>';
                
                // Get current user's class access
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                // Get user's class access from user_class_access table
                const { data: userAccess, error: accessError } = await supabaseClient
                    .from('user_class_access')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('is_active', true)
                    .single();
                
                if (accessError || !userAccess) {
                    console.error('No class access found for user:', accessError);
                    bookList.innerHTML = '<p class="text-yellow-400 col-span-full">No class access found. Please contact support.</p>';
                    return;
                }
                
                const userClassName = userAccess.class_name; // e.g., "class6"
                console.log(`Loading books for user's class: ${userClassName}`);
                
                // Use the new get_class_books function to fetch books
                const { data: books, error: booksError } = await supabaseClient.rpc('get_class_books', {
                    p_class_name: userClassName,
                    p_subject: null, // null means all subjects
                    p_language: 'English'
                });
                
                if (booksError) {
                    console.error('Error fetching books:', booksError);
                    throw new Error('Failed to fetch books');
                }
                
                if (!books || books.length === 0) {
                    bookList.innerHTML = '<p class="text-gray-400 col-span-full">No books available for your class yet. More books will be added soon!</p>';
                    return;
                }
                
                bookList.innerHTML = '';
                
                // Group books by subject
                const booksBySubject = {};
                books.forEach(book => {
                    if (!booksBySubject[book.subject]) {
                        booksBySubject[book.subject] = [];
                    }
                    booksBySubject[book.subject].push(book);
                });
                
                // Create book cards for each subject
                Object.entries(booksBySubject).forEach(([subject, subjectBooks]) => {
                    const bookCard = document.createElement('div');
                    bookCard.className = 'bg-indigo-600/50 hover:bg-indigo-600/70 p-3 rounded-lg text-white text-sm cursor-pointer transition-all duration-300 flex flex-col';
                    
                    const bookNames = subjectBooks.map(book => book.book_name).join(', ');
                    const totalChapters = subjectBooks.length;
                    const totalSize = subjectBooks.reduce((sum, book) => sum + (book.file_size || 0), 0);
                    const sizeInMB = (totalSize / (1024 * 1024)).toFixed(1);
                    
                    bookCard.innerHTML = `
                        <div class="flex items-center mb-2">
                            <span class="mr-2">${getSubjectIcon(subject)}</span>
                            <span class="font-medium">${subject}</span>
                        </div>
                        <div class="text-xs text-gray-300 mb-2 flex-1">${bookNames}</div>
                        <div class="text-xs text-gray-400 mb-2">${subjectBooks.length} chapters • ${sizeInMB} MB</div>
                        <button class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs transition-colors" onclick="viewSubjectBooks('${subject}', '${userClassName}')">
                            📖 View Books
                        </button>
                    `;
                    bookList.appendChild(bookCard);
                });
                
            } catch (error) {
                console.error('Error loading books:', error);
                document.getElementById('bookList').innerHTML = '<p class="text-red-400 col-span-full">Error loading books. Please try again later.</p>';
            }
        }
        
        async function viewSubjectBooks(subject, className) {
            try {
                // Get books for specific subject
                const { data: books, error: booksError } = await supabaseClient.rpc('get_class_books', {
                    p_class_name: className,
                    p_subject: subject,
                    p_language: 'English'
                });
                
                if (booksError || !books) {
                    showError('Failed to load books for this subject');
                    return;
                }
                
                // Show books in a modal
                showBooksModal(subject, books);
                
            } catch (error) {
                console.error('Error viewing subject books:', error);
                showError('Failed to load books');
            }
        }
        
        function showBooksModal(subject, books) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-xl font-bold">${subject} Books</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${books.map(book => `
                            <div class="bg-indigo-600/30 p-4 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <span class="mr-2">📚</span>
                                    <span class="font-medium text-white">${book.book_name}</span>
                                </div>
                                <div class="text-xs text-gray-300 mb-2">Chapter ${book.chapter_number}: ${book.chapter_name}</div>
                                <div class="text-xs text-gray-400 mb-3">${(book.file_size / (1024 * 1024)).toFixed(1)} MB</div>
                                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition-colors" onclick="downloadBookFromStorage('${book.file_path}', '${book.book_name} - Chapter ${book.chapter_number}')">
                                    📥 Download
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function downloadBookFromStorage(filePath, fileName) {
            try {
                showSuccess(`Preparing download for ${fileName}...`);
                
                const { data: { publicUrl }, error } = supabase.storage
                    .from('educational-content')
                    .getPublicUrl(filePath);
                
                if (error) {
                    throw error;
                }
                
                const link = document.createElement('a');
                link.href = publicUrl;
                link.download = `${fileName}.pdf`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(`Download started for ${fileName}`);
                
            } catch (error) {
                console.error('Download error:', error);
                showError('Failed to download book. Please try again.');
            }
        }
        
        function getSubjectIcon(subject) {
            const icons = {
                'English': '📝',
                'Hindi': '🇮🇳',
                'Maths': '🔢',
                'Science': '🧪',
                'Physics': '⚛️',
                'Chemistry': '🧬',
                'Biology': '🌱',
                'History': '🏛️',
                'Geography': '🌍',
                'Economics': '💰',
                'Accountancy': '📊',
                'Business Studies': '💼',
                'Computer': '💻',
                'Sanskrit': '🕉️',
                'Physical Education': '🏃‍♂️',
                'Informatics Practices': '💻',
                'Home Science': '🏠'
            };
            return icons[subject] || '📚';
        }

        // ========== PROGRESS SECTION ==========

        function updateExamYearDropdown() {
            const examYear = document.getElementById('examYear');
            const now = new Date();
            const nextYear = now.getMonth() >= 3 ? now.getFullYear() + 1 : now.getFullYear();
            examYear.innerHTML = '';
            for (let y = nextYear; y <= nextYear + 5; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === nextYear) opt.selected = true;
                examYear.appendChild(opt);
            }
        }
        
        function updateMonthsTillExam() {
            const month = parseInt(document.getElementById('examMonth').value) - 1;
            const year = parseInt(document.getElementById('examYear').value);
            const now = new Date();
            const examDate = new Date(year, month, 1);
            let months = (examDate.getFullYear() - now.getFullYear()) * 12 + (examDate.getMonth() - now.getMonth());
            if (months < 0) months = 0;
            document.getElementById('monthsTillExam').textContent = `Months till final exam: ${months}`;
        }
        
        function renderSubjects() {
            const subjectsList = document.getElementById('subjectsList');
            subjectsList.innerHTML = '';
            window.progressSubjects = window.progressSubjects || [
                { name: 'Math', progress: 0 },
                { name: 'Science', progress: 0 },
                { name: 'English', progress: 0 }
            ];
            window.progressSubjects.forEach((subj, idx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2';
                row.innerHTML = `<input type='text' value='${subj.name}' class='bg-white/10 text-white rounded px-2 py-1 w-32' onchange='window.progressSubjects[${idx}].name=this.value'>
                    <input type='number' min='0' max='100' value='${subj.progress}' class='bg-white/10 text-white rounded px-2 py-1 w-20' onchange='window.progressSubjects[${idx}].progress=parseInt(this.value)'>
                    <span class='text-white text-sm'>% Complete</span>
                    <button onclick='window.progressSubjects.splice(${idx},1);renderSubjects();' class='text-red-400 ml-2'>&times;</button>`;
                subjectsList.appendChild(row);
            });
        }

        // ========== INITIALIZATION ==========

        // Global Supabase client variable
        let supabaseClient = null;

        async function initSupabase() {
            try {
                // Check if Supabase is already initialized
                if (supabaseClient) {
                    console.log('ℹ️ Supabase already initialized');
                    return supabaseClient;
                }

                // Wait for Supabase to load if not already available
                if (typeof window.supabase === 'undefined') {
                    console.log('⏳ Waiting for Supabase to load...');
                    await new Promise((resolve) => {
                        const checkSupabase = () => {
                            if (typeof window.supabase !== 'undefined') {
                                resolve();
                            } else {
                                setTimeout(checkSupabase, 100);
                            }
                        };
                        checkSupabase();
                    });
                }

                // Initialize Supabase client
                const supabaseUrl = 'https://xhuljxuxnlwtocfmwiid.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWxqeHV4bmx3dG9jZm13aWlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MzQ4MTYsImV4cCI6MjA2NzMxMDgxNn0.udHlokpxgR45eS6Pl0OWj7YT1RwW6FUAvGFTed03EIU';
                
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log('✅ Supabase initialized successfully');
                return supabaseClient;

            } catch (error) {
                console.error('❌ Supabase initialization failed:', error);
                throw error;
            }
        }

        async function initDashboard() {
            try {
                console.log('🚀 Initializing dashboard...');
                
                // Initialize Supabase first
                supabaseClient = await initSupabase();
                
                // Check authentication
                const { data: { session }, error: authError } = await supabaseClient.auth.getSession();
                
                if (authError) {
                    console.error('Auth error:', authError);
                    throw authError;
                }
                
                if (!session || !session.user) {
                    console.log('❌ No authenticated user found, redirecting to login');
                    window.location.href = '/login.html';
                    return;
                }
                
                console.log('✅ User authenticated:', session.user.email);
                currentUser = session.user;
                await loadUserProfile();
                
                // Debug the system after initialization
                setTimeout(() => {
                    debugChatSystem();
                    testSTT(); // Test STT functionality
                    makeMicVisible(); // Ensure microphone button is visible
                    testMicButton(); // Test microphone button specifically
                }, 1000);
                
                // Initialize voice services
                if (speechSynthesis) {
                    speechSynthesis.onvoiceschanged = populateVoices;
                    setTimeout(populateVoices, 500);
                }
                
                initSpeechRecognition();
                
                // Setup event listeners
                document.getElementById('sendButton').addEventListener('click', handleSendMessage);
                
                // Add Shift+Enter functionality for line breaks
                document.getElementById('chatInput').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        // Insert a line break
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        this.value = this.value.substring(0, start) + '\n' + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 1;
                    } else if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
                
                document.getElementById('voiceButton').addEventListener('click', toggleVoiceRecording);
                
                // Voice settings controls
                document.getElementById('voiceRate').addEventListener('input', (e) => {
                    document.getElementById('rateValue').textContent = `${e.target.value}x`;
                });
                
                document.getElementById('voicePitch').addEventListener('input', (e) => {
                    document.getElementById('pitchValue').textContent = e.target.value;
                });
                
                // Initialize teacher avatar - Roy Sir (English) is default
                updateTeacher('en');
                
                // Add avatar selection functionality
                document.querySelectorAll('.avatar-selection-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const teacher = this.getAttribute('data-teacher');
                        handleAvatarSelection(teacher);
                    });
                });
                
                // Set Roy Sir as selected by default
                document.querySelector('.avatar-selection-card[data-teacher="english"]')?.classList.add('selected');
                
                // Update when language changes
                const langSelect = document.getElementById('preferredLanguage');
                if (langSelect) {
                    langSelect.addEventListener('change', (e) => {
                        updateTeacher(e.target.value);
                        
                        // Update avatar selection in settings
                        const teacher = e.target.value === 'hi' ? 'hindi' : 'english';
                        document.querySelectorAll('.avatar-selection-card').forEach(c => c.classList.remove('selected'));
                        document.querySelector(`.avatar-selection-card[data-teacher="${teacher}"]`)?.classList.add('selected');
                    });
                }
                
                console.log('Dashboard initialized successfully');
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showError('Failed to initialize dashboard');
            }
        }

        // ========== DEBUG FUNCTIONS ==========

        function debugChatSystem() {
            console.log('=== Chat System Debug Info ===');
            console.log('Current User:', currentUser);
            console.log('User Data:', userData);
            console.log('Current Teacher:', currentTeacher);
            console.log('GPT Service Context:', {
                grade: gptService.currentGrade,
                subject: gptService.currentSubject
            });
            console.log('Chat History Length:', gptService.chatHistory.length);
            console.log('==============================');
        }

        function testSTT() {
            console.log('=== Testing STT System ===');
            console.log('Speech Recognition available:', !!(window.SpeechRecognition || window.webkitSpeechRecognition));
            console.log('Microphone available:', !!navigator.mediaDevices);
            console.log('Current recording state:', isRecording);
            console.log('Recognition object:', recognition);
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(() => {
                    console.log('✅ Microphone access granted');
                    showSTTFeedback('Microphone test successful!', 'success');
                })
                .catch(error => {
                    console.log('❌ Microphone access failed:', error);
                    showSTTFeedback('Microphone test failed: ' + error.message, 'error');
                });
        }

        function testMicButton() {
            console.log('=== Testing Microphone Button ===');
            const voiceButton = document.getElementById('voiceButton');
            const voiceIcon = document.getElementById('voiceIcon');
            
            if (voiceButton) {
                console.log('✅ Voice button found in DOM');
                console.log('Button display:', voiceButton.style.display);
                console.log('Button visibility:', voiceButton.style.visibility);
                console.log('Button opacity:', voiceButton.style.opacity);
                console.log('Button text content:', voiceButton.textContent);
                
                makeMicVisible();
                voiceButton.click();
                console.log('✅ Voice button clicked for testing');
            } else {
                console.error('❌ Voice button NOT found in DOM');
            }
            
            if (voiceIcon) {
                console.log('✅ Voice icon found:', voiceIcon.textContent);
            } else {
                console.error('❌ Voice icon NOT found');
            }
        }

        function makeMicVisible() {
            const voiceButton = document.getElementById('voiceButton');
            if (voiceButton) {
                voiceButton.style.display = 'block';
                voiceButton.style.visibility = 'visible';
                voiceButton.style.opacity = '1';
                voiceButton.style.border = '2px solid #10b981';
                voiceButton.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
                console.log('✅ Microphone button made visible');
            } else {
                console.error('❌ Voice button not found in DOM');
            }
        }

        // ========== START APPLICATION ==========

        // Start the application
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Dashboard DOM loaded');
            await initDashboard();
        });

        // Initialize progress section
        updateExamYearDropdown();
        updateMonthsTillExam();
        renderSubjects();

        // --- Image Integration Functions ---
        async function loadRelevantImages(subject, grade, topic) {
            try {
                // First, try to load from local extracted images
                const localImages = await loadLocalImages(subject, grade, topic);
                if (localImages.length > 0) {
                    console.log(`✅ Found ${localImages.length} local images for ${subject} ${grade} ${topic}`);
                    return localImages;
                }
                
                // If no local images, search web for relevant images
                console.log(`🔍 No local images found, searching web for ${subject} ${grade} ${topic}`);
                const webImages = await searchWebImages(subject, grade, topic);
                return webImages;
                
            } catch (error) {
                console.error('Error loading images:', error);
                return [];
            }
        }

        async function loadLocalImages(subject, grade, topic) {
            try {
                // Load the image index file
                const response = await fetch('/extracted_images/index.json');
                if (!response.ok) {
                    console.log('📁 No local image index found');
                    return [];
                }
                
                const imageIndex = await response.json();
                
                // Filter images by subject, grade, and topic
                const relevantImages = imageIndex.filter(img => {
                    const matchesSubject = img.subject.toLowerCase().includes(subject.toLowerCase());
                    const matchesGrade = img.grade.toString() === grade.toString();
                    const matchesTopic = img.topic && img.topic.toLowerCase().includes(topic.toLowerCase());
                    
                    return matchesSubject && matchesGrade && (matchesTopic || !topic);
                });
                
                // Convert to display format
                return relevantImages.slice(0, 6).map(img => ({
                    url: `/extracted_images/${img.imgPath}`,
                    description: `${img.subject} - ${img.bookName} - ${img.topic || 'General'}`,
                    source: 'local'
                }));
                
            } catch (error) {
                console.error('Error loading local images:', error);
                return [];
            }
        }

        async function searchWebImages(subject, grade, topic) {
            try {
                // Use a simple web search API (you can replace with your preferred service)
                const searchQuery = `${subject} ${grade} class ${topic} educational diagram`;
                
                // For now, return placeholder images (replace with actual API call)
                const placeholderImages = [
                    {
                        url: `https://source.unsplash.com/400x300/?${encodeURIComponent(searchQuery)}`,
                        description: `${subject} ${grade} - ${topic}`,
                        source: 'web'
                    },
                    {
                        url: `https://source.unsplash.com/400x300/?${encodeURIComponent(subject + ' ' + 'education')}`,
                        description: `${subject} educational content`,
                        source: 'web'
                    }
                ];
                
                console.log(`🌐 Found ${placeholderImages.length} web images for ${searchQuery}`);
                return placeholderImages;
                
            } catch (error) {
                console.error('Error searching web images:', error);
                return [];
            }
        }

        function displayImagesInChat(images, messageDiv) {
            if (!images || images.length === 0) return;
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            
            images.forEach(img => {
                const imgElement = document.createElement('div');
                imgElement.className = 'bg-gray-800 rounded-lg p-2 relative';
                
                // Add source indicator
                const sourceBadge = img.source === 'local' ? 
                    '<span class="absolute top-2 left-2 bg-green-500 text-white text-xs px-2 py-1 rounded">📁 Local</span>' :
                    '<span class="absolute top-2 left-2 bg-blue-500 text-white text-xs px-2 py-1 rounded">🌐 Web</span>';
                
                imgElement.innerHTML = `
                    ${sourceBadge}
                    <img src="${img.url}" 
                         alt="${img.description}" 
                         class="w-full h-32 object-cover rounded"
                         onclick="openImageModal('${img.url}', '${img.description}')"
                         style="cursor: pointer;"
                         onerror="this.style.display='none'; this.nextElementSibling.textContent='Image not available';">
                    <p class="text-xs text-gray-400 mt-2">${img.description}</p>
                `;
                imageContainer.appendChild(imgElement);
            });
            
            messageDiv.appendChild(imageContainer);
        }

        function openImageModal(imageSrc, description) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full p-4">
                    <img src="${imageSrc}" alt="${description}" class="max-w-full max-h-full object-contain">
                    <p class="text-white text-center mt-2">${description}</p>
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-white text-2xl">&times;</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // --- Fallback Responses for when API is not available ---
        function getFallbackResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Simple keyword-based responses
            if (message.includes('hello') || message.includes('hi') || message.includes('namaste')) {
                return currentTeacher === teachers.hindi 
                    ? "नमस्ते! मैं आपकी मदद करने के लिए यहाँ हूं। आप क्या सीखना चाहते हैं?"
                    : "Hello! I'm here to help you learn. What would you like to study today?";
            }
            
            if (message.includes('math') || message.includes('गणित')) {
                return currentTeacher === teachers.hindi
                    ? "गणित एक बहुत महत्वपूर्ण विषय है। आइए इसे सरल तरीके से सीखें। कौन सा टॉपिक आपको मुश्किल लग रहा है?"
                    : "Math is a very important subject. Let's learn it in a simple way. Which topic are you finding difficult?";
            }
            
            if (message.includes('science') || message.includes('विज्ञान')) {
                return currentTeacher === teachers.hindi
                    ? "विज्ञान हमारे आसपास की दुनिया को समझने में मदद करता है। किस विषय के बारे में जानना चाहते हैं?"
                    : "Science helps us understand the world around us. What topic would you like to learn about?";
            }
            
            if (message.includes('english') || message.includes('अंग्रेजी')) {
                return currentTeacher === teachers.hindi
                    ? "अंग्रेजी एक अंतरराष्ट्रीय भाषा है। आइए इसे सरल तरीके से सीखें।"
                    : "English is an international language. Let's learn it in a simple way. What would you like to practice?";
            }
            
            if (message.includes('help') || message.includes('मदद')) {
                return currentTeacher === teachers.hindi
                    ? "मैं आपकी मदद करने के लिए यहाँ हूं। आप मुझसे कुछ भी पूछ सकते हैं।"
                    : "I'm here to help you. You can ask me anything about your studies.";
            }
            
            // Default response
            return currentTeacher === teachers.hindi
                ? "यह एक अच्छा सवाल है। आइए इसे साथ में समझें। क्या आप और कुछ बताना चाहते हैं?"
                : "That's a good question. Let's understand it together. Would you like to tell me more about what you're studying?";
        }

        // --- API Health Check ---
        async function checkAPIHealth() {
            try {
                const baseUrl = (window.getApiBaseUrl ? window.getApiBaseUrl() : 'https://tutor-tq4v.vercel.app');
                const response = await fetch(`${baseUrl}/api/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    console.log('✅ API is healthy and available');
                    return true;
                } else {
                    console.warn('⚠️ API returned status:', response.status);
                    return false;
                }
            } catch (error) {
                console.warn('⚠️ API health check failed:', error.message);
                return false;
            }
        }

        // Initialize API health check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const isAPIHealthy = await checkAPIHealth();
            if (!isAPIHealthy) {
                console.log('ℹ️ Using fallback responses - API not available');
            }
        });
    </script>
</body>
</html>
