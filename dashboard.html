<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - tution.app</title>
    
    <!-- Google Translate -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,gu,ta,te,kn,ml,pa,bn,mr,or,as',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <!-- Preload essential resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    <link rel="preload" href="/public/images/roy_sir.jpg" as="image">
    
    <!-- Load Tailwind CSS production version -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Load essential scripts with defer -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="public/js/config.js" defer></script>
    
    <!-- Environment Variables Loader -->
    <script>
        // Direct Supabase credentials (fallback if .env doesn't work)
        window.supabaseUrl = 'https://xhuljxuxnlwtocfmwiid.supabase.co';
        window.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWxqeHV4bmx3dG9jZm13aWlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzODYwOTMsImV4cCI6MjA2Nzk2MjA5M30.mTsc-UknUlrhTqfUCzALyRhmqC26XvwMVNHgD5Ttkw4';
        
        // Try to load environment variables first (for Next.js)
        if (typeof process !== 'undefined' && process.env) {
            if (process.env.NEXT_PUBLIC_SUPABASE_URL) {
                window.supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
            }
            if (process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
                window.supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
            }
        }
        
        console.log('üîß Supabase URL:', window.supabaseUrl);
        console.log('üîß Supabase Key:', window.supabaseKey ? 'Available' : 'Not found');
    </script>
    <script src="public/js/supabaseClient.js" defer></script>
    <script src="public/js/gptService.js" defer></script>
    <script src="public/js/voiceRecognition.js" defer></script>
    <script src="public/js/textToSpeech.js" defer></script>
    <script src="public/js/learningProgress.js" defer></script>
    <script src="public/js/classBookManager.js" defer></script>
    <script src="public/js/groupLearning.js" defer></script>
    <script src="public/js/imageSearch.js" defer></script>
    <script src="public/js/enhancedAIService.js" defer></script>
    <script src="public/js/claudeChat.js" defer></script>
    <script src="public/js/dashboard.js" defer></script>
    
    <!-- Load Razorpay for payments -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Load payment system -->
    <script src="public/js/paymentSystem.js" defer></script>
    
    <!-- Load non-critical scripts after page load -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.3/dist/purify.min.js" defer></script>
    
    <!-- Load fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { 
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            overscroll-behavior-y: contain;
            touch-action: manipulation;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Modern Glass Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }
        
        .glass-card-hover {
            transition: all 0.3s ease;
        }
        
        .glass-card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Modern Chat Interface */
        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 20px;
        }
        
        /* Scroll to top button */
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }
        
        /* Page scroll container */
        .page-content {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        /* Settings and Progress pages scroll */
        .settings-content,
        .progress-content {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }
        
        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        /* Smooth scrolling for entire page */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar for chat container */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease-out;
        }
        
        .message-user {
            display: flex;
            justify-content: flex-end;
        }
        
        .message-ai {
            display: flex;
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message-user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 8px;
        }
        
        .message-ai .message-bubble {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-bottom-left-radius: 8px;
        }
        
        /* Modern Input Area */
        .input-area {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 20px;
        }
        
        .chat-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            color: white;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Modern Buttons */
        .btn-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-modern:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Modern Navigation */
        .nav-modern {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-item {
            padding: 12px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Modern Sidebar */
        .sidebar-modern {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Modern Cards */
        .card-modern {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .card-modern:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Modern Progress Bars */
        .progress-modern {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        /* Modern Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            max-width: 80px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 180px);
                padding: 15px;
            }
            
            .input-area {
                margin: 15px;
                padding: 15px;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 14px 18px;
            }
            
            .nav-item {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .card-modern {
                padding: 20px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .quick-action-btn {
                padding: 10px 6px;
            }
        }
        
        /* Teacher Avatar */
        .teacher-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .quick-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .quick-action-btn:hover::before {
            left: 100%;
        }
        
        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Avatar Selection */
        .avatar-selection-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .avatar-selection-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .avatar-selection-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        /* Subscription Badge */
        .subscription-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .subscription-badge.trial {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .subscription-badge.expired {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">
    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-white/10 backdrop-blur-xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:hidden">
        <div class="flex flex-col h-full">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-6 border-b border-white/20">
                <div class="flex items-center space-x-3">
                    <img src="public/images/tution_logo.png" alt="tution.app Logo" class="h-8 cursor-pointer" onclick="window.location.href='index.html'">
                </div>
                <button class="text-white text-2xl" onclick="closeMobileSidebar()">√ó</button>
            </div>
            
            <!-- Sidebar Navigation -->
            <nav class="flex-1 p-6 space-y-4">
                <div class="nav-item active" onclick="showSection('chat')">
                    <span class="text-xl">üí¨</span>
                    <span>AI Chat</span>
                </div>
                <div class="nav-item" onclick="showSection('materials')">
                    <span class="text-xl">üìö</span>
                    <span>Study Materials</span>
                </div>
                <div class="nav-item" onclick="showSection('progress')">
                    <span class="text-xl">üìä</span>
                    <span>Progress</span>
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <span class="text-xl">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
            </nav>
            
            <!-- User Info -->
            <div class="p-6 border-t border-white/20">
                <button onclick="logout()" class="nav-item w-full text-red-400 hover:text-red-300 hover:bg-red-500/10">
                    <span class="text-xl">üö™</span>
                    <span>Logout</span>
                </button>
                <button onclick="forceShowTrialOverlay()" class="nav-item w-full text-yellow-400 hover:text-yellow-300 hover:bg-yellow-500/10">
                    <span class="text-xl">‚è∞</span>
                    <span>Test Trial</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Sidebar Overlay -->
    <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out lg:hidden"></div>
    
    <!-- Main Layout -->
    <div class="flex h-screen">
        <!-- Desktop Sidebar -->
        <div class="hidden lg:flex lg:w-80 lg:flex-col sidebar-modern">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-6 border-b border-white/20">
                <div class="flex items-center space-x-3">
                    <img src="public/images/tution_logo.png" alt="tution.app Logo" class="h-8 cursor-pointer" onclick="window.location.href='index.html'">
                </div>
            </div>
            
            <!-- Sidebar Navigation -->
            <nav class="flex-1 p-6 space-y-4">
                <div class="nav-item active" onclick="showSection('chat')">
                    <span class="text-xl">üí¨</span>
                    <span>AI Chat</span>
                </div>
                <div class="nav-item" onclick="showSection('materials')">
                    <span class="text-xl">üìö</span>
                    <span>Study Materials</span>
                </div>
                <div class="nav-item" onclick="showSection('progress')">
                    <span class="text-xl">üìä</span>
                    <span>Progress</span>
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <span class="text-xl">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
            </nav>
            
            <!-- User Info -->
            <div class="p-6 border-t border-white/20">
                <button onclick="logout()" class="nav-item w-full text-red-400 hover:text-red-300 hover:bg-red-500/10">
                    <span class="text-xl">üö™</span>
                    <span>Logout</span>
                </button>
                <button onclick="forceShowTrialOverlay()" class="nav-item w-full text-yellow-400 hover:text-yellow-300 hover:bg-yellow-500/10">
                    <span class="text-xl">‚è∞</span>
                    <span>Test Trial</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="nav-modern p-4">
                <div class="flex items-center justify-between">
                    <!-- Mobile Menu Button -->
                    <button class="lg:hidden text-white text-2xl hover:text-blue-300 transition-colors" onclick="openMobileSidebar()">‚ò∞</button>
                    
                    <!-- Logo (Mobile) -->
                    <div class="lg:hidden flex items-center">
                        <img src="/public/images/tution_emblem.png" alt="tution.app Emblem" class="h-8 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.href='index.html'">
                    </div>
                    
                    <!-- Desktop Header Content -->
                    <div class="hidden lg:flex lg:items-center lg:space-x-4">
                        <div class="subscription-badge trial" id="subscriptionBadge">
                            <span class="flex items-center space-x-1">
                                <span>‚≠ê</span>
                                <span>Trial</span>
                            </span>
                        </div>
                        <button id="upgradeButton" onclick="window.location.href='public/payment.html'" class="btn-modern text-sm">
                            <span>üöÄ</span>
                            <span>Upgrade</span>
                        </button>
                    </div>
                    
                    <!-- Google Translate - Extreme Right -->
                    <div class="hidden lg:block">
                        <div id="google_translate_element"></div>
                    </div>
                    

                </div>
            </header>
            
            <!-- Content Area -->
            <main class="flex-1 overflow-hidden">
                <!-- Chat Section -->
                <div id="chatSection" class="h-full flex flex-col">
                    <!-- Chat Header -->
                    <div class="p-4 border-b border-white/20">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <img id="teacher-avatar-chat" class="teacher-avatar" src="/public/images/roy_sir.jpg" alt="Teacher Avatar">
                                <div>
                                    <h2 class="text-white text-xl font-bold" id="teacherName">Roy Sir</h2>
                                    <p class="text-gray-300 text-sm" id="teacherStatus">Online ‚Ä¢ Ready to help</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <h3 class="text-white text-lg font-semibold" id="studentName">Student</h3>
                                    <p class="text-gray-300 text-sm" id="studentClass">Class</p>
                                </div>
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                    <span id="studentInitials" class="text-white font-bold text-sm">S</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="chat-container flex-1">
                        <!-- Welcome Message -->
                        <div class="message message-ai">
                            <div class="message-bubble">
                                <div class="flex items-center space-x-3 mb-3">
                                    <img src="/public/images/roy_sir.jpg" alt="Roy Sir" class="w-8 h-8 rounded-full">
                                    <span class="text-sm font-medium text-blue-200">Roy Sir</span>
                                </div>
                                <p>Hello! I'm your AI teacher. How can I help you today? You can ask me anything about your studies, homework, or any subject you're learning.</p>
                                <div class="mt-3 text-xs text-gray-300">
                                    üí° <strong>Tip:</strong> Try asking me about Math, Science, English, or any homework problems!
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- Input Area -->
                    <div class="input-area">
                        <div class="flex items-center space-x-3">
                            <div class="relative flex-1">
                                <input type="text" id="chatInput" placeholder="Ask me anything about your studies..." class="chat-input pr-12">
                                <button id="voiceButton" onclick="toggleVoiceInput()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors">
                                    <span id="voiceIcon" class="text-xl">üé§</span>
                                </button>
                            </div>
                            <button id="sendButton" onclick="sendMessage()" class="btn-modern">
                                <span>Send</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mt-3 text-xs text-gray-400 text-center">
                            Press Enter to send ‚Ä¢ Use voice input for hands-free learning
                        </div>
                    </div>
                </div>
                
                <!-- Other Sections (Hidden by default) -->
                <div id="materialsSection" class="h-full hidden">
                    <div class="p-6">
                        <h2 class="text-white text-2xl font-bold mb-6">Study Materials</h2>
                        <div class="flex items-center justify-center h-64">
                            <div class="text-center">
                                <div class="text-6xl mb-4">üöß</div>
                                <h3 class="text-white text-xl font-semibold mb-2">Coming Soon!</h3>
                                <p class="text-gray-300 mb-4">We're working hard to bring you amazing study materials.</p>
                                <p class="text-gray-400 text-sm">NCERT Books, Practice Tests, and Video Lessons will be available soon!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="progressSection" class="h-full hidden">
                    <div class="progress-content p-6">
                        <h2 class="text-white text-2xl font-bold mb-6">Learning Progress</h2>
                        <div class="space-y-6">
                            <!-- Final Exam Section -->
                            <div class="card-modern">
                                <h3 class="text-white text-lg font-semibold mb-4">Final Exam Planning</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-white text-sm font-medium mb-2 block">Final Exam in:</label>
                                        <select id="finalExamMonth" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400" onchange="updateMonthsRemaining()">
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4" selected>April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    <div class="text-center p-4 bg-purple-600/20 rounded-lg">
                                        <p class="text-white text-lg font-semibold" id="monthsRemaining">Months remaining to final exam: 8</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Subject Progress -->
                            <div class="card-modern">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-white text-lg font-semibold">Subject Progress</h3>
                                    <button onclick="addNewSubject()" class="btn-modern text-sm">
                                        <span>‚ûï</span>
                                        <span>Add Subject</span>
                                    </button>
                                </div>
                                <div id="subjectsContainer" class="space-y-4">
                                    <div class="subject-item">
                                        <div class="flex justify-between text-white text-sm mb-2">
                                            <span>Mathematics</span>
                                            <span id="mathProgress">0%</span>
                                        </div>
                                        <div class="progress-modern">
                                            <div class="progress-fill" id="mathProgressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="subject-item">
                                        <div class="flex justify-between text-white text-sm mb-2">
                                            <span>Science</span>
                                            <span id="scienceProgress">0%</span>
                                        </div>
                                        <div class="progress-modern">
                                            <div class="progress-fill" id="scienceProgressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="subject-item">
                                        <div class="flex justify-between text-white text-sm mb-2">
                                            <span>English</span>
                                            <span id="englishProgress">0%</span>
                                        </div>
                                        <div class="progress-modern">
                                            <div class="progress-fill" id="englishProgressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="settingsSection" class="h-full hidden">
                    <div class="settings-content p-6">
                        <h2 class="text-white text-2xl font-bold mb-6">Settings</h2>
                        <div class="space-y-6">
                            <!-- Teacher Avatar -->
                            <div class="card-modern">
                                <h3 class="text-white text-lg font-semibold mb-4">Teacher Avatar</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="avatar-selection-card p-4 rounded-lg cursor-pointer" onclick="handleAvatarSelection('english')">
                                        <img class="teacher-avatar mx-auto mb-2" src="/public/images/roy_sir.jpg" alt="Roy Sir" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPGV4dCB4PSIyNCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlI8L3RleHQ+Cjwvc3ZnPgo='">
                                        <h4 class="text-white text-center text-sm">Roy Sir</h4>
                                        <p class="text-gray-300 text-center text-xs">Microsoft Ravi (English)</p>
                                    </div>
                                    <div class="avatar-selection-card p-4 rounded-lg cursor-pointer" onclick="handleAvatarSelection('hindi')">
                                        <img class="teacher-avatar mx-auto mb-2" src="/public/images/miss_sapna.jpg" alt="Ms. Sapana" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNhODU1ZjciLz4KPGV4dCB4PSIyNCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlM8L3RleHQ+Cjwvc3ZnPgo='">
                                        <h4 class="text-white text-center text-sm">Ms. Sapana</h4>
                                        <p class="text-gray-300 text-center text-xs">Google Hindi</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Voice Settings -->
                            <div class="card-modern">
                                <h3 class="text-white text-lg font-semibold mb-4">Voice Settings</h3>
                                <div class="space-y-4">
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="ttsEnabled" checked class="rounded" onchange="handleTTSToggle()">
                                        <span class="text-white">Enable Text-to-Speech</span>
                                    </label>
                                    <label class="flex items-center space-x-3">
                                        <input type="checkbox" id="voiceInputEnabled" checked class="rounded" onchange="handleVoiceInputToggle()">
                                        <span class="text-white">Enable Voice Input</span>
                                    </label>
                                </div>
                                <div id="voiceWarning" class="mt-4 p-3 bg-yellow-500/20 border border-yellow-500/30 rounded-lg hidden">
                                    <p class="text-yellow-200 text-sm">‚ö†Ô∏è <strong>Note:</strong> If voice features are disabled, chat will support typing only.</p>
                                </div>
                            </div>

                            <!-- Download App Button -->
                            <div class="card-modern">
                                <button onclick="downloadApp()" class="btn-modern w-full">
                                    <span>üì±</span>
                                    <span>Download App</span>
                                </button>
                            </div>

                            <!-- View Profile Button -->
                            <div class="card-modern">
                                <button onclick="showProfilePopup()" class="btn-modern w-full">
                                    <span>üë§</span>
                                    <span>View Profile</span>
                                </button>
                            </div>

                            <!-- Contact Us Button -->
                            <div class="card-modern">
                                <button onclick="showContactUs()" class="btn-modern w-full">
                                    <span>üí¨</span>
                                    <span>Contact Us</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Scroll to Top Button -->
    <div class="scroll-to-top" onclick="scrollToTop()" id="scrollToTopBtn">
        <span class="text-white text-xl">‚Üë</span>
    </div>

    <!-- Profile Popup Overlay -->
    <div id="profilePopupOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card max-w-md w-full p-6 relative">
            <button onclick="closeProfilePopup()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 transition-colors">√ó</button>
            <h3 class="text-white text-xl font-bold mb-4">View & Edit Profile</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Full Name:</label>
                    <input type="text" id="popupProfileName" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400">
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Class:</label>
                    <input type="text" id="popupProfileClass" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400">
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Board:</label>
                    <input type="text" id="popupProfileBoard" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400">
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Email:</label>
                    <input type="email" id="popupProfileEmail" class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-400" readonly>
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Mobile:</label>
                    <input type="tel" id="popupProfileMobile" class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-400" readonly>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button onclick="saveProfileFromPopup()" class="btn-modern flex-1">
                        <span>üíæ</span>
                        <span>Save</span>
                    </button>
                    <button onclick="closeProfilePopup()" class="btn-modern btn-secondary flex-1">
                        <span>‚ùå</span>
                        <span>Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Us Popup Overlay -->
    <div id="contactUsPopupOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card max-w-lg w-full p-6 relative">
            <button onclick="closeContactUsPopup()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 transition-colors">√ó</button>
            <h3 class="text-white text-xl font-bold mb-4">We'd Love to Hear from You</h3>
            <p class="text-gray-300 text-sm mb-4">Your feedback helps us improve and serve you better</p>
            <form id="contactUsForm" class="space-y-4">
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Your Name:</label>
                    <input type="text" id="contactUsName" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400" readonly>
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Your Email:</label>
                    <input type="email" id="contactUsEmail" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400" readonly>
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Your Mobile:</label>
                    <input type="tel" id="contactUsMobile" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400" readonly>
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Category:</label>
                    <select id="contactUsCategory" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400">
                        <option value="">Select Category</option>
                        <option value="feedback">General Feedback</option>
                        <option value="books">Books & Content</option>
                        <option value="technical">Technical Issue</option>
                        <option value="suggestion">Feature Suggestion</option>
                        <option value="general">Other</option>
                    </select>
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Subject:</label>
                    <input type="text" id="contactUsSubject" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400" placeholder="Brief subject of your message">
                </div>
                <div>
                    <label class="text-white text-sm font-medium mb-2 block">Message:</label>
                    <textarea id="contactUsMessage" rows="4" class="w-full px-3 py-2 bg-purple-700 border border-purple-500 rounded-lg text-white focus:outline-none focus:border-purple-400" placeholder="Tell us about your experience, suggestions, or any issues you're facing..."></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="btn-modern flex-1">
                        <span>üìß</span>
                        <span>Send Message</span>
                    </button>
                    <button type="button" onclick="closeContactUsPopup()" class="btn-modern btn-secondary flex-1">
                        <span>‚ùå</span>
                        <span>Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trial Expired Overlay -->
    <div id="trialExpiredOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card max-w-md w-full p-8 text-center relative">
            <button onclick="closeTrialOverlay()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 transition-colors">√ó</button>
            <div class="text-6xl mb-4">‚è∞</div>
            <h3 class="text-white text-2xl font-bold mb-4">Trial Expired</h3>
            <p class="text-gray-300 mb-6">Your free trial has ended. Upgrade to continue learning with unlimited access!</p>
            <div class="space-y-3">
                <button onclick="upgradeToPremium()" class="btn-modern w-full">Upgrade Now - ‚Çπ99/month</button>
                <button onclick="closeTrialOverlay()" class="btn-modern btn-secondary w-full">Maybe Later</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentUser = null;
        let userData = {
            full_name: 'User',
            class: 'Class 1',
            board: 'CBSE'
        };
        let chatHistory = [];
        let isRecording = false;
        let currentTeacher = {
            name: "Roy Sir",
            image: "/public/images/roy_sir.jpg",
            language: "en"
        };
        
        // TTS Variables
        let currentSpeech = null;
        let lastAIMessage = '';
        let ttsEnabled = true;
        
        // ========== INITIALIZATION ==========
        
        async function initApp() {
            try {
                console.log('üöÄ Initializing TUTOR.AI Dashboard...');
                
                // Initialize Supabase
                await initSupabase();
                
                // Check authentication
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                if (error || !user) {
                    console.log('‚ùå No authenticated user, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = user;
                console.log('‚úÖ User authenticated:', user.email);
                
                // Load user profile
                await loadUserProfile();
                
                // Check trial status
                const trialActive = await checkTrialStatus();
                if (!trialActive) {
                    console.log('‚ùå Trial expired, access blocked');
                    return;
                }
                
                // Initialize voice features
                initVoiceFeatures();
                
                // Connect teacher avatar to AI
                connectTeacherAvatar();
                
                // Set default selected avatar
                document.querySelector('[onclick="handleAvatarSelection(\'english\')"]').classList.add('selected');
                
                console.log('‚úÖ App initialized successfully');
                
            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
                showError('Failed to initialize app. Please refresh the page.');
            }
        }
        
        // ========== SUPABASE FUNCTIONS ==========
        
        async function initSupabase() {
            try {
                // Check if supabaseClient is already available
                if (window.supabaseClient) {
                    supabaseClient = window.supabaseClient;
                    return;
                }
                
                // Try to get Supabase URL and key from environment variables or config
                let supabaseUrl, supabaseKey;
                
                // First try environment variables (for Next.js)
                if (typeof process !== 'undefined' && process.env) {
                    supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
                    supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
                }
                
                // If not found, try window variables
                if (!supabaseUrl || !supabaseKey) {
                    supabaseUrl = window.TUTOR_CONFIG?.SUPABASE_URL;
                    supabaseKey = window.TUTOR_CONFIG?.SUPABASE_ANON_KEY;
                }
                
                // If still not found, try direct window variables
                if (!supabaseUrl || !supabaseKey) {
                    supabaseUrl = window.supabaseUrl;
                    supabaseKey = window.supabaseKey;
                }
                
                // Final fallback to hardcoded values (for development)
                if (!supabaseUrl || !supabaseKey) {
                    supabaseUrl = 'https://xhuljxuxnlwtocfmwiid.supabase.co';
                    supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhodWxqeHV4bmx3dG9jZm13aWlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzODYwOTMsImV4cCI6MjA2Nzk2MjA5M30.mTsc-UknUlrhTqfUCzALyRhmqC26XvwMVNHgD5Ttkw4';
                }
                
                console.log('üîß Supabase URL:', supabaseUrl ? 'Found' : 'Not found');
                console.log('üîß Supabase Key:', supabaseKey ? 'Found' : 'Not found');
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabase configuration not found');
                }
                
                // Create Supabase client
                if (typeof window.supabase !== 'undefined') {
                    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                } else {
                    // Fallback to CDN
                    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                }
                window.supabaseClient = supabaseClient;
                
                console.log('‚úÖ Supabase client initialized successfully');
            } catch (error) {
                console.error('‚ùå Failed to initialize Supabase:', error);
                throw error;
            }
        }
        
        async function loadUserProfile() {
            try {
                console.log('üîç Loading user profile for:', currentUser.id);
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    console.log('‚ùå Profile not found, creating new profile...');
                    // Create new profile if it doesn't exist
                    await createUserProfile();
                    return;
                }
                
                userData = data;
                console.log('‚úÖ User profile loaded:', userData);
                updateUserInterface();
                
            } catch (error) {
                console.error('Failed to load user profile:', error);
                // Try to create profile on error
                try {
                    await createUserProfile();
                } catch (createError) {
                    console.error('Failed to create user profile:', createError);
                }
            }
        }
        
        async function createUserProfile() {
            try {
                console.log('üîß Creating new user profile...');
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .insert({
                        id: currentUser.id,
                        full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                        class: 'Class 1',
                        board: 'CBSE',
                        board_abbr: 'CBSE',
                        phone: currentUser.phone || '',
                        city: '',
                        state: '',
                        preferred_language: 'en'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                userData = data;
                console.log('‚úÖ New user profile created:', userData);
                updateUserInterface();
                
            } catch (error) {
                console.error('Failed to create user profile:', error);
                // Set default user data if creation fails
                userData = {
                    full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                    class: 'Class 1',
                    board: 'CBSE'
                };
                updateUserInterface();
            }
        }
        
        // ========== UI FUNCTIONS ==========
        
        function updateUserInterface() {
            try {
                const name = userData?.full_name || currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'User';
                const className = userData?.class || 'Class 1';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                
                // Update student info in chat header
                const studentNameElement = document.getElementById('studentName');
                const studentClassElement = document.getElementById('studentClass');
                const studentInitialsElement = document.getElementById('studentInitials');
                
                if (studentNameElement) studentNameElement.textContent = name;
                if (studentClassElement) studentClassElement.textContent = className;
                if (studentInitialsElement) studentInitialsElement.textContent = initials;
                
                // Update teacher avatar
                const teacherAvatarElement = document.getElementById('teacher-avatar-chat');
                const teacherNameElement = document.getElementById('teacherName');
                
                if (teacherAvatarElement && currentTeacher?.image) {
                    teacherAvatarElement.src = currentTeacher.image;
                }
                if (teacherNameElement && currentTeacher?.name) {
                    teacherNameElement.textContent = currentTeacher.name;
                }
                
                console.log('‚úÖ User interface updated:', { name, className, initials });
                
            } catch (error) {
                console.error('Error updating user interface:', error);
                // Fallback to basic display
                const studentNameElement = document.getElementById('studentName');
                if (studentNameElement) studentNameElement.textContent = currentUser?.email || 'User';
            }
        }
        
        // ========== NAVIGATION FUNCTIONS ==========
        
        function showSection(sectionName) {
            // Hide all sections
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('materialsSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('onclick')?.includes(sectionName)) {
                    item.classList.add('active');
                }
            });
            
            // Close mobile sidebar
            closeMobileSidebar();
        }
        
        function openMobileSidebar() {
            document.getElementById('mobileSidebar').classList.remove('-translate-x-full');
            document.getElementById('mobileSidebarOverlay').classList.remove('opacity-0', 'pointer-events-none');
        }
        
        function closeMobileSidebar() {
            document.getElementById('mobileSidebar').classList.add('-translate-x-full');
            document.getElementById('mobileSidebarOverlay').classList.add('opacity-0', 'pointer-events-none');
        }
        
        // ========== CHAT FUNCTIONS ==========
        
        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check trial status
            const trialActive = await checkTrialStatus();
            if (!trialActive) {
                console.log('‚ùå Trial expired, message blocked');
                showTrialExpiredOverlay();
                return;
            }
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            
            try {
                // Show loading
                showLoading(true);
                
                // Get AI response
                const response = await getAIResponse(message);
                
                // Add AI response
                addMessage('ai', response);
                
                // Save to history
                await saveChatMessage(message, response);
                
                // Auto-play TTS if enabled
                if (ttsEnabled) {
                    playTTS(response);
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('ai', 'Sorry, I encountered an error. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        // Get AI response using gptService
        async function getAIResponse(message) {
            if (!window.gptService) {
                throw new Error('GPT Service not available');
            }
            
            try {
                const response = await window.gptService.sendMessage(message, userData);
                return response;
            } catch (error) {
                console.error('Error getting AI response:', error);
                throw error;
            }
        }
        
        // Save chat message to history
        async function saveChatMessage(userMessage, aiResponse) {
            try {
                // Add to local chat history
                chatHistory.push({
                    user: userMessage,
                    ai: aiResponse,
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 50 messages
                if (chatHistory.length > 50) {
                    chatHistory = chatHistory.slice(-50);
                }
                
                // Save to Supabase if available
                if (supabaseClient && currentUser) {
                    const { error } = await supabaseClient
                        .from('chat_history')
                        .insert({
                            user_id: currentUser.id,
                            user_message: userMessage,
                            ai_response: aiResponse,
                            created_at: new Date().toISOString()
                        });
                    
                    if (error) {
                        console.warn('Failed to save chat to database:', error);
                    }
                }
            } catch (error) {
                console.warn('Failed to save chat message:', error);
            }
        }
        
        // Show/hide loading indicator
        function showLoading(show) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (show) {
                // Remove existing loading indicator
                const existingIndicator = document.getElementById('loadingIndicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                // Add new loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.className = 'message message-ai';
                loadingDiv.innerHTML = `
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                // Remove loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }
        }
        
        function addMessage(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            // Convert markdown to HTML if it's an AI message
            if (role === 'ai') {
                bubbleDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
            } else {
                bubbleDiv.textContent = content;
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ========== VOICE FUNCTIONS ==========
        
        function initVoiceFeatures() {
            // Initialize voice recognition and TTS
            if (window.initVoiceRecognition) {
                window.initVoiceRecognition();
            }
            if (window.initTextToSpeech) {
                window.initTextToSpeech();
            }
        }
        
        function toggleVoiceInput() {
            if (isRecording) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }
        
        function startVoiceInput() {
            if (window.startVoiceRecognition) {
                window.startVoiceRecognition();
                isRecording = true;
                document.getElementById('voiceIcon').textContent = '‚èπÔ∏è';
            }
        }
        
        function stopVoiceInput() {
            if (window.stopVoiceRecognition) {
                window.stopVoiceRecognition();
                isRecording = false;
                document.getElementById('voiceIcon').textContent = 'üé§';
            }
        }
        
        function playTTS(text) {
            if (window.speakText) {
                window.speakText(text);
            }
        }
        
        // ========== TEACHER FUNCTIONS ==========
        
        function connectTeacherAvatar() {
            const avatar = document.querySelector('.teacher-avatar');
            if (avatar) {
                avatar.addEventListener('click', function() {
                    document.getElementById('chatInput').focus();
                    showSuccess('Click the chat input to start talking with your AI teacher!');
                });
            }
        }
        
        function handleAvatarSelection(teacher) {
            // Remove active class from all avatar cards
            document.querySelectorAll('.avatar-selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            if (teacher === 'hindi') {
                currentTeacher = {
                    name: "Ms. Sapana",
                    image: "/public/images/miss_sapna.jpg",
                    language: "hi"
                };
                // Add selected class to Hindi teacher card
                document.querySelector('[onclick="handleAvatarSelection(\'hindi\')"]').classList.add('selected');
            } else {
                currentTeacher = {
                    name: "Roy Sir",
                    image: "/public/images/roy_sir.jpg",
                    language: "en"
                };
                // Add selected class to English teacher card
                document.querySelector('[onclick="handleAvatarSelection(\'english\')"]').classList.add('selected');
            }
            
            updateUserInterface();
            showSuccess(`Switched to ${currentTeacher.name} (${teacher === 'hindi' ? 'Google Hindi' : 'Microsoft Ravi English'})`);
        }
        
        // ========== TRIAL FUNCTIONS ==========
        
        async function checkTrialStatus() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    console.log('No user found, skipping trial check');
                    return true; // Allow access even without user
                }
                
                const { data: profile, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    console.error('Error fetching profile:', error);
                    return true; // Allow access on error
                }
                
                // Always show user information regardless of trial status
                if (profile) {
                    updateUserDisplay(profile);
                }
                
                if (profile && profile.trial_expires_at) {
                    const trialExpiry = new Date(profile.trial_expires_at);
                    const now = new Date();
                    
                    if (now > trialExpiry) {
                        console.log('‚ùå Trial expired, but allowing access to view profile');
                        showWarning('Your trial has expired. Please upgrade to continue using all features.');
                        return false;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error checking trial status:', error);
                return true; // Allow access on error
            }
        }
        
        // Update user display information
        function updateUserDisplay(profile) {
            try {
                // Update student name and class in header
                const studentNameElement = document.getElementById('studentName');
                const studentClassElement = document.getElementById('studentClass');
                const studentInitialsElement = document.getElementById('studentInitials');
                
                if (studentNameElement && profile.full_name) {
                    studentNameElement.textContent = profile.full_name;
                }
                
                if (studentClassElement && profile.class) {
                    studentClassElement.textContent = `Class ${profile.class}`;
                }
                
                if (studentInitialsElement && profile.full_name) {
                    const initials = profile.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
                    studentInitialsElement.textContent = initials || 'S';
                }
                
                console.log('‚úÖ User display updated:', profile.full_name, 'Class', profile.class);
            } catch (error) {
                console.error('Error updating user display:', error);
            }
        }
        
        function showTrialExpiredOverlay() {
            document.getElementById('trialExpiredOverlay').classList.remove('hidden');
        }
        
        function closeTrialOverlay() {
            document.getElementById('trialExpiredOverlay').classList.add('hidden');
        }
        
        // Force show trial overlay for testing
        function forceShowTrialOverlay() {
            showTrialExpiredOverlay();
        }
        
        function upgradeToPremium() {
            window.location.href = 'public/payment.html';
        }
        
        // ========== UTILITY FUNCTIONS ==========
        
        // Handle TTS toggle
        function handleTTSToggle() {
            const ttsEnabled = document.getElementById('ttsEnabled').checked;
            const voiceInputEnabled = document.getElementById('voiceInputEnabled').checked;
            const warning = document.getElementById('voiceWarning');
            
            if (!ttsEnabled && !voiceInputEnabled) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            ttsEnabled = ttsEnabled;
        }
        
        // Handle Voice Input toggle
        function handleVoiceInputToggle() {
            const ttsEnabled = document.getElementById('ttsEnabled').checked;
            const voiceInputEnabled = document.getElementById('voiceInputEnabled').checked;
            const warning = document.getElementById('voiceWarning');
            
            if (!ttsEnabled && !voiceInputEnabled) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
            
            // Request microphone permission if enabling
            if (voiceInputEnabled && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        console.log('Microphone permission granted');
                        showSuccess('Voice input enabled!');
                    })
                    .catch(function(err) {
                        console.log('Microphone permission denied:', err);
                        showError('Microphone access denied. Please enable it in your browser settings.');
                        document.getElementById('voiceInputEnabled').checked = false;
                    });
            }
        }
        
        // Logout function
        async function logout() {
            try {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        }
        
        function showSuccess(message) {
            // Modern success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg z-50 shadow-lg transform translate-x-full transition-transform duration-300 ease-out';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-xl">‚úÖ</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        function showError(message) {
            // Modern error notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg z-50 shadow-lg transform translate-x-full transition-transform duration-300 ease-out';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-xl">‚ùå</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }
        
        function showWarning(message) {
            // Modern warning notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-4 rounded-lg z-50 shadow-lg transform translate-x-full transition-transform duration-300 ease-out';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-xl">‚ö†Ô∏è</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }
        
        function showSuccess(message) {
            // Modern success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg z-50 shadow-lg transform translate-x-full transition-transform duration-300 ease-out';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-xl">‚úÖ</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }
        
        // ========== EVENT LISTENERS ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // Request microphone permission for mobile
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        console.log('‚úÖ Microphone permission granted');
                        // Stop the stream to release the microphone
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(err) {
                        console.log('‚ùå Microphone permission denied:', err);
                        // Show a helpful message for mobile users
                        if (err.name === 'NotAllowedError') {
                            setTimeout(() => {
                                showError('Microphone access denied. Please enable it in your browser settings for voice features.');
                            }, 2000);
                        }
                    });
            }
            
            initApp();
        });
        
        // Handle Enter key in chat input
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Close sidebar when clicking overlay
        document.getElementById('mobileSidebarOverlay').addEventListener('click', closeMobileSidebar);
        
        // Update subscription UI
        function updateSubscriptionUI(subscription) {
            const badge = document.getElementById('subscriptionBadge');
            if (subscription && subscription.status === 'active') {
                badge.textContent = 'Premium';
                badge.className = 'subscription-badge';
            } else {
                badge.textContent = 'Trial';
                badge.className = 'subscription-badge trial';
            }
        }
        
        // Upgrade function
        function upgradeNow() {
            window.location.href = 'public/payment.html';
        }

        // ========== NEW FEATURES ==========

        // Update months remaining to final exam
        function updateMonthsRemaining() {
            const selectedMonth = parseInt(document.getElementById('finalExamMonth').value);
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
            const currentYear = currentDate.getFullYear();
            
            let monthsRemaining = selectedMonth - currentMonth;
            if (monthsRemaining <= 0) {
                monthsRemaining += 12; // Next year
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('monthsRemaining').textContent = 
                `Months remaining to final exam: ${monthsRemaining} (${monthNames[selectedMonth - 1]})`;
        }

        // Add new subject to progress tracking
        function addNewSubject() {
            const subjectName = prompt('Enter subject name:');
            if (!subjectName) return;
            
            const subjectsContainer = document.getElementById('subjectsContainer');
            const subjectId = 'subject_' + Date.now();
            
            const newSubject = document.createElement('div');
            newSubject.className = 'subject-item';
            newSubject.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-white text-sm">${subjectName}</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-white text-sm" id="${subjectId}_progress">0%</span>
                        <button onclick="removeSubject(this)" class="text-red-400 hover:text-red-300 text-sm">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="progress-modern">
                    <div class="progress-fill" id="${subjectId}_bar" style="width: 0%"></div>
                </div>
            `;
            
            subjectsContainer.appendChild(newSubject);
            showSuccess(`Added ${subjectName} to your subjects!`);
        }

        // Remove subject from progress tracking
        function removeSubject(button) {
            const subjectItem = button.closest('.subject-item');
            const subjectName = subjectItem.querySelector('span').textContent;
            
            if (confirm(`Are you sure you want to remove ${subjectName}?`)) {
                subjectItem.remove();
                showSuccess(`Removed ${subjectName} from your subjects.`);
            }
        }

        // Show profile popup function
        function showProfilePopup() {
            console.log('Opening profile popup...');
            console.log('User data:', userData);
            console.log('Current user:', currentUser);
            
            // Populate popup fields with current user data
            document.getElementById('popupProfileName').value = userData.full_name || '';
            document.getElementById('popupProfileClass').value = userData.class || '';
            document.getElementById('popupProfileBoard').value = userData.board || '';
            document.getElementById('popupProfileEmail').value = currentUser.email || '';
            document.getElementById('popupProfileMobile').value = userData.mobile || 'Not set';
            
            // Show popup
            document.getElementById('profilePopupOverlay').classList.remove('hidden');
        }

        // Close profile popup
        function closeProfilePopup() {
            document.getElementById('profilePopupOverlay').classList.add('hidden');
        }

        // Save profile from popup
        async function saveProfileFromPopup() {
            try {
                const newName = document.getElementById('popupProfileName').value.trim();
                const newClass = document.getElementById('popupProfileClass').value.trim();
                const newBoard = document.getElementById('popupProfileBoard').value.trim();
                
                if (!newName) {
                    showError('Please enter a valid name.');
                    return;
                }
                
                // Check name change limit (3 times)
                if (userData.name_changes && userData.name_changes >= 3) {
                    showError('You have reached the maximum limit of 3 name changes.');
                    return;
                }
                
                // Update user profile in Supabase
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({
                        full_name: newName,
                        class: newClass,
                        board: newBoard,
                        name_changes: (userData.name_changes || 0) + 1,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // Update local user data
                userData.full_name = newName;
                userData.class = newClass;
                userData.board = newBoard;
                userData.name_changes = (userData.name_changes || 0) + 1;
                
                // Update main profile fields
                document.getElementById('profileName').value = newName;
                
                // Update UI
                updateUserInterface();
                
                // Close popup
                closeProfilePopup();
                
                showSuccess('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                showError('Failed to save profile. Please try again.');
            }
        }

        // Show contact us popup
        function showContactUs() {
            // Populate contact form with user data
            document.getElementById('contactUsName').value = userData.full_name || currentUser.email || '';
            document.getElementById('contactUsEmail').value = currentUser.email || '';
            document.getElementById('contactUsMobile').value = userData.mobile || 'Not set';
            
            // Show popup
            document.getElementById('contactUsPopupOverlay').classList.remove('hidden');
        }

        // Close contact us popup
        function closeContactUsPopup() {
            document.getElementById('contactUsPopupOverlay').classList.add('hidden');
        }

        // Handle contact us form submission
        async function handleContactUsSubmit(event) {
            event.preventDefault();
            
            try {
                const category = document.getElementById('contactUsCategory').value;
                const subject = document.getElementById('contactUsSubject').value.trim();
                const message = document.getElementById('contactUsMessage').value.trim();
                
                if (!category || !subject || !message) {
                    showError('Please fill in all fields.');
                    return;
                }
                
                // Send message to admin
                const { error } = await supabaseClient
                    .from('admin_messages')
                    .insert({
                        user_id: currentUser.id,
                        user_name: userData.full_name || currentUser.email,
                        user_email: currentUser.email,
                        user_mobile: userData.mobile,
                        category: category,
                        subject: subject,
                        message: message,
                        status: 'new',
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Close popup and show success
                closeContactUsPopup();
                showSuccess('Message sent successfully! We will get back to you soon.');
                
                // Reset form
                document.getElementById('contactUsForm').reset();
                
            } catch (error) {
                console.error('Error sending contact message:', error);
                showError('Failed to send message. Please try again.');
            }
        }





        // Contact admin function
        async function contactAdmin() {
            try {
                const message = prompt('Please describe your issue or question:');
                if (!message) return;
                
                // Send message to admin
                const { error } = await supabaseClient
                    .from('admin_messages')
                    .insert({
                        user_id: currentUser.id,
                        user_name: userData.full_name || currentUser.email,
                        user_email: currentUser.email,
                        message: message,
                        status: 'new',
                        created_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                showSuccess('Message sent to admin! We will get back to you soon.');
                
            } catch (error) {
                console.error('Error sending message to admin:', error);
                showError('Failed to send message. Please try again.');
            }
        }

        // Check Supabase connection status
        async function checkSupabaseConnection() {
            try {
                if (!supabaseClient) {
                    console.error('‚ùå Supabase client not initialized');
                    showError('Database connection not available. Please refresh the page.');
                    return false;
                }
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                console.log('‚úÖ Supabase connection successful');
                return true;
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                console.error('Error details:', error.message);
                showError('Database connection issue. Please check your internet connection and refresh the page.');
                return false;
            }
        }

        // Initialize new features
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize months remaining calculation
            updateMonthsRemaining();
            
            // Check Supabase connection
            checkSupabaseConnection();
            
            // Add event listener for contact us form
            document.getElementById('contactUsForm').addEventListener('submit', handleContactUsSubmit);
            
            // Test View Profile button
            console.log('Testing View Profile button...');
            const viewProfileBtn = document.querySelector('[onclick="showProfilePopup()"]');
            if (viewProfileBtn) {
                console.log('View Profile button found:', viewProfileBtn);
            } else {
                console.log('View Profile button not found');
            }
            
            // Initialize scroll functionality
            initScrollFunctionality();
        });
        
        // Scroll functionality
        function initScrollFunctionality() {
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            let currentScrollContainer = null;
            
            // Show/hide scroll to top button based on scroll position
            function toggleScrollButton() {
                if (currentScrollContainer && currentScrollContainer.scrollTop > 300) {
                    scrollToTopBtn.classList.add('visible');
                } else {
                    scrollToTopBtn.classList.remove('visible');
                }
            }
            
            // Scroll to top function
            window.scrollToTop = function() {
                if (currentScrollContainer) {
                    currentScrollContainer.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            };
            
            // Update scroll container based on active section
            function updateScrollContainer() {
                const chatSection = document.getElementById('chatSection');
                const settingsSection = document.getElementById('settingsSection');
                const progressSection = document.getElementById('progressSection');
                
                if (!chatSection.classList.contains('hidden')) {
                    currentScrollContainer = document.getElementById('chatMessages');
                } else if (!settingsSection.classList.contains('hidden')) {
                    currentScrollContainer = document.querySelector('.settings-content');
                } else if (!progressSection.classList.contains('hidden')) {
                    currentScrollContainer = document.querySelector('.progress-content');
                }
                
                // Remove previous event listeners
                if (currentScrollContainer) {
                    currentScrollContainer.addEventListener('scroll', toggleScrollButton);
                }
            }
            
            // Update scroll container when section changes
            const originalShowSection = window.showSection;
            window.showSection = function(section) {
                originalShowSection(section);
                setTimeout(updateScrollContainer, 100);
            };
            
            // Initialize scroll container
            updateScrollContainer();
            
            // Auto-scroll to bottom when new messages are added
            const originalAddMessage = window.addMessage;
            window.addMessage = function(role, content) {
                originalAddMessage(role, content);
                setTimeout(() => {
                    const chatContainer = document.getElementById('chatMessages');
                    if (chatContainer) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                }, 100);
            };
        }

        // Download App function
        function downloadApp() {
            // Create download link for APK
            const link = document.createElement('a');
            link.href = 'public/tution.appv1.2.apk';
            link.download = 'tution.appv1.2.apk';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            showSuccess('App download started! Check your downloads folder.');
        }
    </script>
</body>
</html>

