<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - TUTOR.AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/vedicMath.js" defer></script>
    <script src="js/storyDatabase.js" defer></script>
    <script src="js/lessonPlanner.js" defer></script>
    <script src="js/teacherBehavior.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .chat-container {
            height: 60vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-left: auto;
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            color: white;
            margin-bottom: 12px;
        }
        
        .message-ai {
            background: rgba(255, 255, 255, 0.15);
            margin-right: auto;
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            color: white;
            margin-bottom: 12px;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .teacher-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .teacher-avatar.talking {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }
        
        .voice-recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            animation: pulse 1s infinite;
        }
        
        .nav-item {
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .chat-container {
                height: 50vh;
            }
            
            .message-user, .message-ai {
                max-width: 90%;
                font-size: 14px;
            }
            
            .teacher-avatar {
                width: 32px;
                height: 32px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .quick-action-btn {
                padding: 12px 8px;
                font-size: 12px;
            }
        }
        
        .error-toast, .success-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-toast {
            background: rgba(239, 68, 68, 0.9);
        }
        
        .success-toast {
            background: rgba(34, 197, 94, 0.9);
        }
        
        .vedic-tip {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 12px;
            border-left: 4px solid #fbbf24;
        }
        
        .story-content {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 13px;
            border-left: 4px solid #a855f7;
        }
        
        .lesson-progress {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white text-lg">Loading TUTOR.AI...</p>
        </div>
    </div>

    <!-- Mobile Sidebar -->
    <div class="mobile-sidebar fixed top-0 left-0 w-64 h-full bg-slate-800/95 transform -translate-x-full transition-transform z-40" id="mobileSidebar">
        <div class="p-4 border-b border-white/10">
            <h1 class="text-white text-lg font-bold">TUTOR.AI</h1>
            <p class="text-gray-400 text-sm" id="mobileUserName">Loading...</p>
        </div>
        <nav class="p-4 space-y-2">
            <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="showSection('dashboard')" id="navDashboard">
                üè† Dashboard
            </button>
            <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="showSection('progress')" id="navProgress">
                üìà Progress
            </button>
            <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="showSection('settings')" id="navSettings">
                ‚öôÔ∏è Settings
            </button>
            <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="signOut()">
                üö™ Sign Out
            </button>
        </nav>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay fixed inset-0 bg-black/50 hidden z-30" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

    <div class="flex h-screen">
        <!-- Desktop Sidebar -->
        <div class="hidden md:flex w-64 bg-slate-800/90 flex-col">
            <div class="p-6 border-b border-white/10">
                <h1 class="text-white text-xl font-bold">TUTOR.AI</h1>
                <p class="text-gray-400 text-sm" id="desktopUserName">Loading...</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button class="nav-item active w-full text-left p-3 rounded-lg text-white" onclick="showSection('dashboard')" id="navDashboardDesktop">
                    üè† Dashboard
                </button>
                <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="showSection('progress')" id="navProgressDesktop">
                    üìà Progress
                </button>
                <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="showSection('settings')" id="navSettingsDesktop">
                    ‚öôÔ∏è Settings
                </button>
                <button class="nav-item w-full text-left p-3 rounded-lg text-white" onclick="signOut()">
                    üö™ Sign Out
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Mobile Header -->
            <div class="md:hidden bg-slate-800/90 p-4 flex items-center justify-between">
                <button onclick="openMobileSidebar()" class="text-white p-2">‚ò∞</button>
                <h1 class="text-white font-bold">TUTOR.AI</h1>
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <span id="userInitials" class="text-white font-bold text-xs">L</span>
                </div>
            </div>
            
            <!-- Content Container -->
            <div class="flex-1 overflow-y-auto">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section-content p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- Teacher Section -->
                        <div class="glass-effect rounded-xl p-4 mb-6">
                            <div class="flex items-center gap-4 mb-4">
                                <img id="currentTeacherAvatar" class="teacher-avatar" src="/images/teacher-avatar2.png" alt="Teacher">
                                <div>
                                    <h2 id="currentTeacherName" class="text-white text-lg font-bold">Roy Sir</h2>
                                    <p class="text-gray-300 text-sm">Your AI Teacher</p>
                                    <div id="lessonProgress" class="lesson-progress hidden">
                                        <span id="lessonProgressText">Lesson progress will appear here</span>
                                    </div>
                                </div>
                                <div class="ml-auto flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-green-400 text-xs">Online</span>
                                </div>
                            </div>

                            <!-- Chat Container -->
                            <div id="chatMessages" class="chat-container mb-4">
                                <div class="message-ai">
                                    <img class="teacher-avatar" src="/images/teacher-avatar2.png" alt="Roy Sir">
                                    <div>
                                        <div>Hello! I'm Roy Sir, your AI teacher. I'm here to help you learn and grow. What would you like to study today?</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Input -->
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="chatInput" 
                                    placeholder="Ask me anything about your studies..." 
                                    class="flex-1 px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onkeypress="handleKeyPress(event)"
                                >
                                <button 
                                    id="voiceButton" 
                                    class="px-4 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg hover:from-green-600 hover:to-blue-600 transition-all duration-300 font-semibold" 
                                    onclick="toggleVoice()" 
                                    title="Voice Input (Optional)"
                                >
                                    üé§
                                </button>
                                <button 
                                    id="sendButton" 
                                    class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-300 font-semibold"
                                    onclick="sendMessage()"
                                >
                                    Send
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <button onclick="quickStudy('Math')" class="quick-action-btn glass-effect p-4 rounded-xl text-center hover:bg-white/20 transition-all">
                                <div class="text-2xl mb-2">üî¢</div>
                                <p class="text-white font-medium text-sm">Math Help</p>
                            </button>
                            <button onclick="quickStudy('Science')" class="quick-action-btn glass-effect p-4 rounded-xl text-center hover:bg-white/20 transition-all">
                                <div class="text-2xl mb-2">üß™</div>
                                <p class="text-white font-medium text-sm">Science</p>
                            </button>
                            <button onclick="quickStudy('English')" class="quick-action-btn glass-effect p-4 rounded-xl text-center hover:bg-white/20 transition-all">
                                <div class="text-2xl mb-2">üìù</div>
                                <p class="text-white font-medium text-sm">English</p>
                            </button>
                            <button onclick="showProgress()" class="quick-action-btn glass-effect p-4 rounded-xl text-center hover:bg-white/20 transition-all">
                                <div class="text-2xl mb-2">üìà</div>
                                <p class="text-white font-medium text-sm">Progress</p>
                            </button>
                        </div>

                        <!-- Study Materials -->
                        <div class="glass-effect rounded-xl p-4">
                            <h3 class="text-white font-bold mb-4">Study Materials</h3>
                            <div id="studyMaterials" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="bg-indigo-600/50 p-4 rounded-lg text-white">
                                    <div class="flex items-center mb-2">
                                        <span class="mr-2">üìö</span>
                                        <span class="font-medium">NCERT Books</span>
                                    </div>
                                    <p class="text-sm text-gray-300">Access your textbooks</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div id="progressSection" class="section-content p-4 hidden">
                    <div class="max-w-4xl mx-auto">
                        <div class="glass-effect rounded-xl p-6">
                            <h2 class="text-white text-2xl font-bold mb-6">Learning Progress</h2>
                            <div id="progressContent">
                                <p class="text-gray-300">Progress tracking will be implemented here...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="section-content p-4 hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="glass-effect rounded-xl p-6">
                            <h2 class="text-white text-2xl font-bold mb-6">Settings</h2>
                            
                            <!-- Teacher Selection -->
                            <div class="mb-6">
                                <label class="text-white text-sm font-medium mb-3 block">Choose Your Teacher:</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="teacher-card bg-white/10 p-4 rounded-lg cursor-pointer border-2 border-transparent hover:border-blue-500" data-teacher="roy" onclick="selectTeacher('roy')">
                                        <img class="teacher-avatar mx-auto mb-2" src="/images/teacher-avatar2.png" alt="Roy Sir">
                                        <h3 class="text-white text-center font-medium">Roy Sir</h3>
                                        <p class="text-gray-400 text-xs text-center">English ‚Ä¢ Structured</p>
                                    </div>
                                    <div class="teacher-card bg-white/10 p-4 rounded-lg cursor-pointer border-2 border-transparent hover:border-blue-500" data-teacher="sapna" onclick="selectTeacher('sapna')">
                                        <img class="teacher-avatar mx-auto mb-2" src="/images/teacher-avatar1.png" alt="Ms. Sapna">
                                        <h3 class="text-white text-center font-medium">Ms. Sapna</h3>
                                        <p class="text-gray-400 text-xs text-center">Hindi ‚Ä¢ Nurturing</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Language Settings -->
                            <div class="mb-6">
                                <label class="text-white text-sm font-medium mb-2 block">Preferred Language:</label>
                                <select id="languageSelect" class="w-full bg-slate-700 text-white rounded-lg px-3 py-2" onchange="changeLanguage(this.value)">
                                    <option value="en">English</option>
                                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                                    <option value="hinglish">Hinglish</option>
                                </select>
                            </div>

                            <!-- Voice Settings -->
                            <div class="mb-6">
                                <label class="text-white text-sm font-medium mb-2 block">Voice Settings:</label>
                                <div class="space-y-2">
                                    <button onclick="testVoice()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        üîä Test Voice
                                    </button>
                                    <button onclick="testMicrophone()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        üé§ Test Microphone
                                    </button>
                                </div>
                            </div>

                            <!-- Account -->
                            <div class="mb-6">
                                <label class="text-white text-sm font-medium mb-2 block">Account:</label>
                                <div class="space-y-2">
                                    <button onclick="showProfile()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        üë§ View Profile
                                    </button>
                                    <button onclick="signOut()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        üö™ Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let supabaseClient;
        let currentUser = null;
        let currentTeacher = 'roy';
        let currentLanguage = 'en';
        let isRecording = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let lessonPlanner = null;
        let teacherBehavior = null;
        let sessionStartTime = Date.now();

        // ========== TEACHER PERSONAS ==========
        const teachers = {
            roy: {
                name: "Roy Sir",
                avatar: "/images/teacher-avatar2.png",
                language: "english",
                style: "structured",
                personality: "friendly but strict",
                greeting: "Hello! I'm Roy Sir, your AI teacher. Let's learn together today."
            },
            sapna: {
                name: "Ms. Sapna",
                avatar: "/images/teacher-avatar1.png", 
                language: "hinglish",
                style: "nurturing",
                personality: "empathetic and encouraging",
                greeting: "Namaste! Main Ms. Sapna hun, aapki teacher. Aaj hum kya interesting seekhenge?"
            }
        };

        // ========== INITIALIZATION ==========
        async function initApp() {
            try {
                console.log('üöÄ Initializing TUTOR.AI...');
                
                // Initialize Supabase
                await initSupabase();
                
                // Check authentication
                await checkAuth();
                
                // Initialize teacher system
                await initTeacherSystem();
                
                // Initialize UI
                initUI();
                
                // Hide loading screen
                document.getElementById('loadingScreen').style.display = 'none';
                
                console.log('‚úÖ TUTOR.AI initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showError('Failed to initialize. Please refresh the page.');
            }
        }

        async function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase not loaded');
                }
                
                const SUPABASE_URL = 'https://tutor-tq4v.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1dG9yLXRxNHYiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczNTU5NzI5MCwiZXhwIjoyMDUxMTczMjkwfQ.Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8';
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase initialized');
                
            } catch (error) {
                console.error('‚ùå Supabase initialization failed:', error);
                throw error;
            }
        }

        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) throw error;
                
                if (!session?.user) {
                    console.log('‚ùå No authenticated user found');
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('‚úÖ User authenticated:', currentUser.email);
                
                // Update UI with user info
                updateUserInfo();
                
            } catch (error) {
                console.error('‚ùå Auth check failed:', error);
                window.location.href = '/login.html';
            }
        }

        async function initTeacherSystem() {
            try {
                // Load teacher personas and lesson planner
                if (typeof LessonPlanner !== 'undefined' && currentUser) {
                    lessonPlanner = new LessonPlanner({
                        id: currentUser.id,
                        class: 'class_8', // Default, will be updated from profile
                        grade: 8
                    });
                    console.log('‚úÖ Lesson planner initialized');
                }
                
                if (typeof TeacherBehavior !== 'undefined') {
                    teacherBehavior = new TeacherBehavior(teachers[currentTeacher], lessonPlanner);
                    console.log('‚úÖ Teacher behavior initialized');
                }
                
                // Initialize current teacher
                selectTeacher('roy');
                
            } catch (error) {
                console.error('‚ùå Teacher system initialization failed:', error);
                // Continue without advanced features
            }
        }

        function initUI() {
            // Initialize speech recognition (optional, non-blocking)
            try {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        isRecording = false;
                        updateVoiceButton();
                    };
                    
                    recognition.onerror = () => {
                        isRecording = false;
                        updateVoiceButton();
                    };
                    
                    recognition.onend = () => {
                        isRecording = false;
                        updateVoiceButton();
                    };
                }
            } catch (error) {
                console.log('Voice recognition not available:', error);
            }
            
            // Set default teacher as selected
            document.querySelector('.teacher-card[data-teacher="roy"]')?.classList.add('border-blue-500');
        }

        // ========== USER INTERFACE ==========
        function updateUserInfo() {
            const name = currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'Student';
            const initials = name.charAt(0).toUpperCase();
            
            // Update mobile
            const mobileUserName = document.getElementById('mobileUserName');
            const userInitials = document.getElementById('userInitials');
            
            if (mobileUserName) mobileUserName.textContent = name;
            if (userInitials) userInitials.textContent = initials;
            
            // Update desktop
            const desktopUserName = document.getElementById('desktopUserName');
            if (desktopUserName) desktopUserName.textContent = name;
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Activate current nav items
            document.getElementById('nav' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1))?.classList.add('active');
            document.getElementById('nav' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1) + 'Desktop')?.classList.add('active');
            
            // Close mobile sidebar
            closeMobileSidebar();
        }

        function openMobileSidebar() {
            document.getElementById('mobileSidebar').classList.remove('-translate-x-full');
            document.getElementById('mobileOverlay').classList.remove('hidden');
        }

        function closeMobileSidebar() {
            document.getElementById('mobileSidebar').classList.add('-translate-x-full');
            document.getElementById('mobileOverlay').classList.add('hidden');
        }

        // ========== TEACHER SYSTEM ==========
        function selectTeacher(teacherId) {
            currentTeacher = teacherId;
            const teacher = teachers[teacherId];
            
            // Update UI
            document.getElementById('currentTeacherName').textContent = teacher.name;
            document.getElementById('currentTeacherAvatar').src = teacher.avatar;
            
            // Update selection in settings
            document.querySelectorAll('.teacher-card').forEach(card => {
                card.classList.remove('border-blue-500');
            });
            document.querySelector(`.teacher-card[data-teacher="${teacherId}"]`)?.classList.add('border-blue-500');
            
            // Update language
            currentLanguage = teacher.language === 'hinglish' ? 'hinglish' : (teacher.language === 'english' ? 'en' : 'hi');
            document.getElementById('languageSelect').value = currentLanguage;
            
            // Add greeting message
            addAIMessage(teacher.greeting);
            
            // Update teacher behavior if available
            if (teacherBehavior) {
                teacherBehavior.persona = teacher;
            }
            
            console.log('‚úÖ Teacher selected:', teacher.name);
        }

        function changeLanguage(language) {
            currentLanguage = language;
            
            // Auto-select appropriate teacher
            if (language === 'hi' || language === 'hinglish') {
                selectTeacher('sapna');
            } else {
                selectTeacher('roy');
            }
        }

        // ========== CHAT SYSTEM ==========
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addUserMessage(message);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Get AI response
                let response;
                
                if (teacherBehavior) {
                    // Use advanced teacher behavior
                    const result = teacherBehavior.getResponse(message, {
                        currentSubject: getCurrentSubject(message),
                        sessionTime: (Date.now() - sessionStartTime) / 60000 // minutes
                    });
                    response = result.message;
                    
                    // Add special content if available
                    if (result.vedic_tip) {
                        response += `\n\nü™î Vedic Math Tip: ${result.vedic_tip.explanation}\nExample: ${result.vedic_tip.example}`;
                    }
                    
                    if (result.story) {
                        response += `\n\nüìö Story Time: ${result.story.introduction}\n${result.story.title}\nMoral: ${result.story.moral}`;
                    }
                    
                    if (result.progress_update) {
                        updateLessonProgress(result.progress_update);
                    }
                } else {
                    // Fallback simple response
                    response = generateFallbackResponse(message);
                }
                
                hideTypingIndicator();
                addAIMessage(response);
                
                // Text-to-speech if available
                speakText(response);
                
            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addAIMessage("Sorry, I encountered an error. Please try again.");
            }
        }

        function addUserMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-user';
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addAIMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-ai';
            
            const teacher = teachers[currentTeacher];
            messageDiv.innerHTML = `
                <img class="teacher-avatar talking" src="${teacher.avatar}" alt="${teacher.name}">
                <div>${message}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'typing-indicator message-ai';
            typingDiv.innerHTML = `
                <img class="teacher-avatar" src="${teachers[currentTeacher].avatar}" alt="Typing">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ========== VOICE FEATURES ==========
        function toggleVoice() {
            if (!recognition) {
                showError('Voice input not available in this browser');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
                isRecording = false;
            } else {
                try {
                    recognition.start();
                    isRecording = true;
                    showSuccess('Listening... speak now!');
                } catch (error) {
                    showError('Could not start voice recording');
                }
            }
            
            updateVoiceButton();
        }

        function updateVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            if (isRecording) {
                voiceButton.textContent = 'üî¥';
                voiceButton.classList.add('voice-recording');
            } else {
                voiceButton.textContent = 'üé§';
                voiceButton.classList.remove('voice-recording');
            }
        }

        function speakText(text) {
            if (!speechSynthesis) return;
            
            try {
                speechSynthesis.cancel(); // Stop any current speech
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                // Try to use appropriate voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.lang.includes('en-IN') || 
                    voice.lang.includes('hi-IN') ||
                    voice.name.includes('Indian')
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.log('Text-to-speech error:', error);
            }
        }

        function testVoice() {
            const teacher = teachers[currentTeacher];
            speakText(`Hello, this is ${teacher.name}. Voice test successful!`);
        }

        function testMicrophone() {
            if (!recognition) {
                showError('Voice input not supported in this browser');
                return;
            }
            
            toggleVoice();
            setTimeout(() => {
                if (isRecording) {
                    recognition.stop();
                    showSuccess('Microphone test completed!');
                }
            }, 3000);
        }

        // ========== UTILITY FUNCTIONS ==========
        function quickStudy(subject) {
            const message = `Help me study ${subject}`;
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        function showProgress() {
            if (lessonPlanner) {
                const progress = lessonPlanner.getProgressUpdate();
                updateLessonProgress(progress);
                showSection('progress');
            } else {
                showSection('progress');
            }
        }

        function updateLessonProgress(progressData) {
            const lessonProgress = document.getElementById('lessonProgress');
            const lessonProgressText = document.getElementById('lessonProgressText');
            
            if (progressData && lessonProgressText) {
                lessonProgressText.textContent = `Progress: ${progressData.overall_progress}% | Days remaining: ${progressData.days_remaining}`;
                lessonProgress.classList.remove('hidden');
            }
        }

        function getCurrentSubject(message) {
            const subjects = ['math', 'science', 'english', 'hindi', 'history', 'geography'];
            const messageLower = message.toLowerCase();
            
            for (const subject of subjects) {
                if (messageLower.includes(subject)) {
                    return subject;
                }
            }
            return 'general';
        }

        function generateFallbackResponse(message) {
            const teacher = teachers[currentTeacher];
            const messageLower = message.toLowerCase();
            
            if (messageLower.includes('math') || messageLower.includes('‡§ó‡§£‡§ø‡§§')) {
                return teacher.name === 'Roy Sir' 
                    ? "Mathematics is a fundamental subject. Which topic would you like to explore?"
                    : "‡§ó‡§£‡§ø‡§§ ‡§è‡§ï ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§µ‡§ø‡§∑‡§Ø ‡§π‡•à‡•§ ‡§ï‡•å‡§® ‡§∏‡§æ topic ‡§Ü‡§™‡§ï‡•ã ‡§™‡§¢‡§º‡§®‡§æ ‡§π‡•à?";
            }
            
            if (messageLower.includes('science') || messageLower.includes('‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®')) {
                return teacher.name === 'Roy Sir'
                    ? "Science helps us understand the world around us. What would you like to learn?"
                    : "Science ‡§π‡§Æ‡•á‡§Ç duniya ‡§ï‡•ã ‡§∏‡§Æ‡§ù‡§®‡•á ‡§Æ‡•á‡§Ç help ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡•Ä‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?";
            }
            
            return teacher.name === 'Roy Sir'
                ? "That's an interesting question. Let me help you understand this topic better."
                : "Ye ek ‡§Ö‡§ö‡•ç‡§õ‡§æ question ‡§π‡•à‡•§ Main aapko ‡§á‡§∏‡•á ‡§∏‡§Æ‡§ù‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç help ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡•Ä‡•§";
        }

        function showProfile() {
            const name = currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'Student';
            const email = currentUser?.email || 'Not available';
            
            showSuccess(`Profile: ${name} (${email})`);
        }

        async function signOut() {
            try {
                await supabaseClient.auth.signOut();
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Sign out error:', error);
                window.location.href = '/index.html';
            }
        }

        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'error-toast';
            toast.innerHTML = `<span>‚ùå</span><span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.innerHTML = `<span>‚úÖ</span><span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ========== ERROR HANDLING ==========
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            event.preventDefault();
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled rejection:', event.reason);
            event.preventDefault();
        });

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
